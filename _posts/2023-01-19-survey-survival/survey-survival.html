<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { color: #00769e; background-color: #f1f3f5; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #00769e; } /* Normal */
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #657422; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #00769e; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #00769e; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #00769e; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #5e5e5e; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>


  <!--radix_placeholder_meta_tags-->
  <title>Survival Analysis with Survey Weights</title>

  <meta property="description" itemprop="description" content="The survey package for R makes it easy to incorpate weights and other elements of survey design into survival analysis."/>


  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2023-01-25"/>
  <meta property="article:created" itemprop="dateCreated" content="2023-01-25"/>
  <meta name="article:author" content="Matt Gunther"/>

  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Survival Analysis with Survey Weights"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="The survey package for R makes it easy to incorpate weights and other elements of survey design into survival analysis."/>
  <meta property="og:locale" content="en_US"/>

  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Survival Analysis with Survey Weights"/>
  <meta property="twitter:description" content="The survey package for R makes it easy to incorpate weights and other elements of survey design into survival analysis."/>

  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","output","categories"]}},"value":[{"type":"character","attributes":{},"value":["Survival Analysis with Survey Weights"]},{"type":"character","attributes":{},"value":["The survey package for R makes it easy to incorpate weights and other elements of survey design into survival analysis. \n"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","affiliation"]}},"value":[{"type":"character","attributes":{},"value":["Matt Gunther"]},{"type":"character","attributes":{},"value":["IPUMS PMA Senior Data Analyst"]}]}]},{"type":"character","attributes":{},"value":["2023-01-25"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","toc","toc_depth","toc_float"]}},"value":[{"type":"logical","attributes":{},"value":[false]},{"type":"logical","attributes":{},"value":[true]},{"type":"integer","attributes":{},"value":[3]},{"type":"logical","attributes":{},"value":[true]}]}]},{"type":"character","attributes":{},"value":["Data Analysis","Survival Analysis","Weights","Cluster Sampling","Contraceptive Calendar","survey","survival","srvyr"]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["data/cals.rds","data/dat.rds","images/featured.png","survey-survival_files/anchor-4.2.2/anchor.min.js","survey-survival_files/bowser-1.9.3/bowser.min.js","survey-survival_files/distill-2.2.21/template.v2.js","survey-survival_files/figure-html5/unnamed-chunk-10-1.png","survey-survival_files/figure-html5/unnamed-chunk-18-1.png","survey-survival_files/figure-html5/unnamed-chunk-19-1.png","survey-survival_files/figure-html5/unnamed-chunk-20-1.png","survey-survival_files/figure-html5/unnamed-chunk-21-1.png","survey-survival_files/figure-html5/unnamed-chunk-9-1.png","survey-survival_files/header-attrs-2.19/header-attrs.js","survey-survival_files/jquery-3.6.0/jquery-3.6.0.js","survey-survival_files/jquery-3.6.0/jquery-3.6.0.min.js","survey-survival_files/jquery-3.6.0/jquery-3.6.0.min.map","survey-survival_files/popper-2.6.0/popper.min.js","survey-survival_files/tippy-6.2.7/tippy-bundle.umd.min.js","survey-survival_files/tippy-6.2.7/tippy-light-border.css","survey-survival_files/tippy-6.2.7/tippy.css","survey-survival_files/tippy-6.2.7/tippy.umd.min.js","survey-survival_files/webcomponents-2.0.0/webcomponents.js"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

  <style type="text/css">

  body {
    background-color: white;
  }

  .pandoc-table {
    width: 100%;
  }

  .pandoc-table>caption {
    margin-bottom: 10px;
  }

  .pandoc-table th:not([align]) {
    text-align: left;
  }

  .pagedtable-footer {
    font-size: 15px;
  }

  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }

  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }

  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }

  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }

  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }

  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
    font-size: 100%;
  }

  .html-widget {
    margin-bottom: 2.0em;
  }

  .l-screen-inset {
    padding-right: 16px;
  }

  .l-screen .caption {
    margin-left: 10px;
  }

  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .shaded-content {
    background: white;
  }

  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }

  .hidden {
    display: none !important;
  }

  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }

  d-appendix {
    padding-top: 30px;
  }

  d-article>p>img {
    width: 100%;
  }

  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }

  d-article h3 {
    margin-top: 1.5rem;
  }

  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }

  /* Tweak code blocks */

  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }

  d-article div.sourceCode {
    background-color: white;
  }

  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }

  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  d-article pre a {
    border-bottom: none;
  }

  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }

  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }

  @media(min-width: 768px) {

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }

  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }

  d-article pre {
    font-size: 14px;
  }

  }

  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  /* CSS for d-contents */

  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }

  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }

  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .d-contents li {
    list-style-type: none
  }

  .d-contents nav > ul {
    padding-left: 0;
  }

  .d-contents ul {
    padding-left: 1em
  }

  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }

  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }

  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }

  .d-contents nav > ul > li > a {
    font-weight: 600;
  }

  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }

  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }


  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }

  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }


  /* Figure */

  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }

  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }

  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }

  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }

  /* Citations */

  d-article .citation {
    color: inherit;
    cursor: inherit;
  }

  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }

  /* Citation hover box */

  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }

  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }


  /* Tweak 1000px media break to show more text */

  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }

    .grid {
      grid-column-gap: 16px;
    }

    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }

  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }

    .grid {
      grid-column-gap: 32px;
    }
  }


  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */

  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Include appendix styles here so they can be overridden */

  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }

  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }

  d-appendix h3 + * {
    margin-top: 1em;
  }

  d-appendix ol {
    padding: 0 0 0 15px;
  }

  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }

  d-appendix li {
    margin-bottom: 1em;
  }

  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }

  d-appendix > * {
    grid-column: text;
  }

  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }

  /* Include footnote styles here so they can be overridden */

  d-footnote-list {
    contain: layout style;
  }

  d-footnote-list > * {
    grid-column: text;
  }

  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }



  /* Anchor.js */

  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }

  /* Social footer */

  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }

  .disqus-comments {
    margin-right: 30px;
  }

  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }

  #disqus_thread {
    margin-top: 30px;
  }

  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }

  .article-sharing a:hover {
    border-bottom: none;
  }

  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }

  .subscribe p {
    margin-bottom: 0.5em;
  }


  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }


  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }

  .custom p {
    margin-bottom: 0.5em;
  }

  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }

  /* Styles for posts lists (not auto-injected) */


  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }

  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }

  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }

  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }

  .post-preview-last {
    border-bottom: none !important;
  }

  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }

  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }

  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }

  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }

  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }

  .posts-list .metadata > * {
    display: inline-block;
  }

  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }

  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }

  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }

  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .posts-list img {
    opacity: 1;
  }

  .posts-list img[data-src] {
    opacity: 0;
  }

  .posts-more {
    clear: both;
  }


  .posts-sidebar {
    font-size: 16px;
  }

  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }

  .sidebar-section {
    margin-bottom: 30px;
  }

  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }

  .categories li>a {
    border-bottom: none;
  }

  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }

  .categories .active {
    font-weight: 600;
  }

  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }


  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }


  /* Improve display for browsers without grid (IE/Edge <= 15) */

  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }

  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }

  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }

  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }

  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }

  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }


  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }

  .downlevel .footnotes ol {
    padding-left: 13px;
  }

  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }

  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }

  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }

  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  .downlevel .posts-list .post-preview {
    color: inherit;
  }



  </style>

  <script type="application/javascript">

  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }

  // show body when load is complete
  function on_load_complete() {

    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }


    // set body to visible
    document.body.style.visibility = 'visible';

    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }

    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }

  function init_distill() {

    init_common();

    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);

    // create d-title
    $('.d-title').changeElementType('d-title');

    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);

    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();

    // move posts container into article
    $('.posts-container').appendTo($('d-article'));

    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');

    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;

    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();

    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));

    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });

    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');

    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {

      // capture layout
      var layout = $(this).attr('data-layout');

      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });


      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });

    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();

    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();

    // load distill framework
    load_distill_framework();

    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {

      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;

      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');

      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');

      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });

      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }

      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");

      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }

       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }

      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();

      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();

      // hoverable references
      $('span.citation[data-cites]').each(function() {
        const citeChild = $(this).children()[0]
        // Do not process if @xyz has been used without escaping and without bibliography activated
        // https://github.com/rstudio/distill/issues/466
        if (citeChild === undefined) return true

        if (citeChild.nodeName == "D-FOOTNOTE") {
          var fn = citeChild
          $(this).html(fn.shadowRoot.querySelector("sup"))
          $(this).id = fn.id
          fn.remove()
        }
        var refs = $(this).attr('data-cites').split(" ");
        var refHtml = refs.map(function(ref) {
          // Could use CSS.escape too here, we insure backward compatibility in navigator
          return "<p>" + $('div[id="ref-' + ref + '"]').html() + "</p>";
        }).join("\n");
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });

      // fix footnotes in tables (#411)
      // replacing broken distill.pub feature
      $('table d-footnote').each(function() {
        // we replace internal showAtNode methode which is triggered when hovering a footnote
        this.hoverBox.showAtNode = function(node) {
          // ported from https://github.com/distillpub/template/pull/105/files
          calcOffset = function(elem) {
              let x = elem.offsetLeft;
              let y = elem.offsetTop;
              // Traverse upwards until an `absolute` element is found or `elem`
              // becomes null.
              while (elem = elem.offsetParent && elem.style.position != 'absolute') {
                  x += elem.offsetLeft;
                  y += elem.offsetTop;
              }

              return { left: x, top: y };
          }
          // https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/offsetTop
          const bbox = node.getBoundingClientRect();
          const offset = calcOffset(node);
          this.show([offset.left + bbox.width, offset.top + bbox.height]);
        }
      })

      // clear polling timer
      clearInterval(tid);

      // show body now that everything is ready
      on_load_complete();
    }

    var tid = setInterval(distill_post_process, 50);
    distill_post_process();

  }

  function init_downlevel() {

    init_common();

     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));

    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;

    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();

    // remove toc
    $('.d-contents').remove();

    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });


    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);

    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();

    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });

    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));

    $('body').addClass('downlevel');

    on_load_complete();
  }


  function init_common() {

    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};

        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });

        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);

    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});

    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      // ignore leaflet img layers (#106)
      figures = figures.filter(':not(img[class*="leaflet"])')
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });

      }
    });

    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });

    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace(/^index[.]html/, "./"));
      });
    }

    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');

    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");

    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();

    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });

  </script>

  <!--/radix_placeholder_distill-->
  <script src="survey-survival_files/header-attrs-2.19/header-attrs.js"></script>
  <script src="survey-survival_files/jquery-3.6.0/jquery-3.6.0.min.js"></script>
  <script src="survey-survival_files/popper-2.6.0/popper.min.js"></script>
  <link href="survey-survival_files/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="survey-survival_files/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="survey-survival_files/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="survey-survival_files/anchor-4.2.2/anchor.min.js"></script>
  <script src="survey-survival_files/bowser-1.9.3/bowser.min.js"></script>
  <script src="survey-survival_files/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="survey-survival_files/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Survival Analysis with Survey Weights","description":"The survey package for R makes it easy to incorpate weights and other elements of survey design into survival analysis.","authors":[{"author":"Matt Gunther","authorURL":"#","affiliation":"IPUMS PMA Senior Data Analyst","affiliationURL":"#","orcidID":""}],"publishedDate":"2023-01-25T00:00:00.000-05:00","citationText":"Gunther, 2023"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Survival Analysis with Survey Weights</h1>
<!--radix_placeholder_categories-->
<div class="dt-tags">
<div class="dt-tag">Data Analysis</div>
<div class="dt-tag">Survival Analysis</div>
<div class="dt-tag">Weights</div>
<div class="dt-tag">Cluster Sampling</div>
<div class="dt-tag">Contraceptive Calendar</div>
<div class="dt-tag">survey</div>
<div class="dt-tag">survival</div>
<div class="dt-tag">srvyr</div>
</div>
<!--/radix_placeholder_categories-->
<p><p>The survey package for R makes it easy to incorpate weights and other elements of survey design into survival analysis.</p></p>
</div>

<div class="d-byline">
  Matt Gunther  (IPUMS PMA Senior Data Analyst)
  
<br/>2023-01-25
</div>

<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#data" id="toc-data">Data</a></li>
<li><a href="#setup" id="toc-setup">Setup</a></li>
<li><a href="#unweighted-estimates" id="toc-unweighted-estimates">Unweighted Estimates</a></li>
<li><a href="#survey-design" id="toc-survey-design">Survey Design</a></li>
<li><a href="#data-with-multiple-samples" id="toc-data-with-multiple-samples">Data with Multiple Samples</a></li>
</ul>
</nav>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<p>Several months ago, we introduced the <a href="../2022-05-15-phase2-calendar">PMA Contraceptive Calendar</a> as a monthly recollection of contraceptive use and pregnancy status reported by women in each phase of the ongoing <a href="../../index.html#category:Panel_Data">PMA panel study</a>. These data are an especially useful tool for researchers interested in <strong>survival analysis</strong>, which can be used to estimate the expected amount of time to a particular family planning event (measured in months).</p>
<p>In that introduction, we demonstrated how to estimate <em>time to adoption</em> of a family planning method for women who initially were not using one. Because we focused most of our attention on data preparation and visualization techniques with the <a href="https://github.com/therneau/survival">survival</a> package for R, we set aside some issues related to PMA survey weights and its clustered sample design. In short: <a href="https://github.com/therneau/survival">survival</a> is probably the best known way to conduct this kind of survival analysis in R, but it does not include the tools we need to incorporate information about the PMA survey design.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>In our case, survival functions included in the <a href="http://r-survey.r-forge.r-project.org/survey/">survey</a> package offer an easy way to use PMA weights and identifiers for each cluster and sample stratum.</p>
<h1 id="data">Data</h1>
<p>Let’s pick up with the contraceptive calendar dataset we created in our earlier post, except that we’ll now include all of the variables necessary to describe PMA survey design:</p>
<ul>
<li><code>ID</code> - Unique identifier for each woman (our data includes <em>de facto</em> panel members only)</li>
<li><code>POP</code> - Population of study. Our extract contains six independent samples drawn from different populations; we’ll demonstrate how to use survey design information for one sample first, and then repeat for all samples.</li>
<li><a href="https://pma.ipums.org/pma-action/variables/panelweight">PANELWEIGHT</a> - An inverse probability weight for panel membership, adjusted for loss to follow-up at Phase 2<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></li>
<li><a href="https://pma.ipums.org/pma-action/variables/eaid">EAID</a> - Unique identifier for each sample cluster</li>
<li><a href="https://pma.ipums.org/pma-action/variables/strata">STRATA</a> - Unique identifier for each sample stratum, from which clusters are drawn</li>
<li><code>CALSTART</code> - The date of the woman’s Phase 1 interview (CMC format). This corresponds with the <em>first</em> month in our survival analysis.</li>
<li><code>CALSTOP</code> - The date of the woman’s Phase 2 interview (CMC format). This corresponds with the <em>last</em> month in our survival analysis.</li>
<li><code>CALCMC</code> - The date of each month, formatted here as <em>one month per row</em> (CMC format). Most women report about 12 months between <code>CALSTART</code> and <code>CALSTOP</code>, depending on the actual spacing of Phase 1 and Phase 2 interviews. Some women do not have completed Phase 2 calendars, so we only have data from the month in <code>CALSTART</code>.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></li>
</ul>
<p>Additionally, we’ve included a two variables describing 1) each woman’s family planning intentions at Phase 1 and 2) her monthly family planning status reported on the Phase 2 Contraceptive Calendar.</p>
<ul>
<li><code>FPPLANYR</code> indicates whether the woman indicated at Phase 1 that she was not currently using a method, but planned to adopt one by Phase 2 (one year later). All cases are either <code>TRUE</code> (non-user with plans to adopt) or <code>FALSE</code> (e.g. Phase 1 users, or Phase 1 non-users with no such plans). Derived from <a href="https://pma.ipums.org/pma-action/variables/FPPLANWHEN">FPPLANWHEN</a> and <a href="https://pma.ipums.org/pma-action/variables/fpplanval">FPPLANVAL</a>.</li>
<li><code>FPSTATUS</code> indicates the woman’s recalled family planning status for each month between Phase 1 and her Phase 2 interview (approximately 12 months later).</li>
</ul>
<p>Since we’re working with a dataset created in a previous session, we’ll load it with <a href="https://readr.tidyverse.org/reference/read_rds.html">read_rds</a> from the <a href="https://tidyverse.tidyverse.org">tidyverse</a>. We’ll also load <a href="http://r-survey.r-forge.r-project.org/survey/">survey</a> (along with its tidy-helper <a href="http://gdfe.co/srvyr/">srvyr</a>). The <a href="https://github.com/therneau/survival">survival</a> package is listed as a dependency for <a href="http://r-survey.r-forge.r-project.org/survey/">survey</a>, so it is attched automatically.</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tidyverse.tidyverse.org'>tidyverse</a></span><span class='op'>)</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://r-survey.r-forge.r-project.org/survey/'>survey</a></span><span class='op'>)</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://gdfe.co/srvyr/'>srvyr</a></span><span class='op'>)</span></span>
<span><span class='va'>dat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://readr.tidyverse.org/reference/read_rds.html'>read_rds</a></span><span class='op'>(</span><span class='st'>"data/dat.rds"</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body-outset">
<pre><code># A tibble: 208,098 × 10
# Groups:   ID [17,725]
      ID POP          PANELWEIGHT      EAID STRATA CALSTART CALSTOP CALCMC FPPLANYR FPSTATUS
   &lt;int&gt; &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;  &lt;int&gt;    &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;lgl&gt;    &lt;chr&gt;   
 1     1 Burkina Faso        2.50 854111005  85402     1442    1453   1453 TRUE     3       
 2     1 Burkina Faso        2.50 854111005  85402     1442    1453   1452 TRUE     3       
 3     1 Burkina Faso        2.50 854111005  85402     1442    1453   1451 TRUE     3       
 4     1 Burkina Faso        2.50 854111005  85402     1442    1453   1450 TRUE     3       
 5     1 Burkina Faso        2.50 854111005  85402     1442    1453   1449 TRUE     3       
 6     1 Burkina Faso        2.50 854111005  85402     1442    1453   1448 TRUE     3       
 7     1 Burkina Faso        2.50 854111005  85402     1442    1453   1447 TRUE     0       
 8     1 Burkina Faso        2.50 854111005  85402     1442    1453   1446 TRUE     0       
 9     1 Burkina Faso        2.50 854111005  85402     1442    1453   1445 TRUE     0       
10     1 Burkina Faso        2.50 854111005  85402     1442    1453   1444 TRUE     0       
11     1 Burkina Faso        2.50 854111005  85402     1442    1453   1443 TRUE     0       
12     1 Burkina Faso        2.50 854111005  85402     1442    1453   1442 TRUE     0       
13     2 Burkina Faso        2.61 854111004  85402     1441    1452   1452 FALSE    5       
14     2 Burkina Faso        2.61 854111004  85402     1441    1452   1451 FALSE    5       
15     2 Burkina Faso        2.61 854111004  85402     1441    1452   1450 FALSE    5       
# … with 208,083 more rows</code></pre>
</div>
<h1 id="setup">Setup</h1>
<p>The numeric codes shown above in <code>FPSTATUS</code> refer to specific family planning methods used in a particular month, with the following exceptions:</p>
<ul>
<li><code>P</code> Pregnant</li>
<li><code>B</code> Birth<br />
</li>
<li><code>T</code> Termination of pregnancy</li>
<li><code>0</code> No pregnancy and no family planning method used</li>
</ul>
<p>We’ll build a binary indicator for <code>USE</code> of <em>any</em> method, as indicated by any value except for these codes. (For the moment, our data contain placeholder <code>NA</code> values for women with incomplete Phase 2 calendars).</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>dat</span> <span class='op'>&lt;-</span> <span class='va'>dat</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rowwise.html'>rowwise</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>USE <span class='op'>=</span> <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/any.html'>any</a></span><span class='op'>(</span><span class='va'>FPSTATUS</span> <span class='op'>==</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"0"</span>, <span class='st'>"P"</span>, <span class='st'>"B"</span>, <span class='st'>"T"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<p>Our analysis will compare time to adoption for Phase 1 <em>non-users</em> like the woman at the top of our dataset (<code>ID == 1</code>). <code>FPPLANYR</code> shows that she reported plans to adopt a method within 12 months after the Phase 1 interview, and the Phase 2 calendar data in <code>FPSTATUS</code> shows that she did so just 6 months later. We should hypothesize that women <em>with plans</em> probably adopt a method sooner, on average, compared with women who had <em>no plans</em>.</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>dat</span> </span></code></pre>
</div>
<pre><code># A tibble: 208,098 × 11
# Rowwise:  ID
      ID POP          PANELWEIGHT      EAID STRATA CALSTART CALSTOP CALCMC FPPLANYR FPSTATUS USE  
   &lt;int&gt; &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;  &lt;int&gt;    &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;lgl&gt;    &lt;chr&gt;    &lt;lgl&gt;
 1     1 Burkina Faso        2.50 854111005  85402     1442    1453   1453 TRUE     3        TRUE 
 2     1 Burkina Faso        2.50 854111005  85402     1442    1453   1452 TRUE     3        TRUE 
 3     1 Burkina Faso        2.50 854111005  85402     1442    1453   1451 TRUE     3        TRUE 
 4     1 Burkina Faso        2.50 854111005  85402     1442    1453   1450 TRUE     3        TRUE 
 5     1 Burkina Faso        2.50 854111005  85402     1442    1453   1449 TRUE     3        TRUE 
 6     1 Burkina Faso        2.50 854111005  85402     1442    1453   1448 TRUE     3        TRUE 
 7     1 Burkina Faso        2.50 854111005  85402     1442    1453   1447 TRUE     0        FALSE
 8     1 Burkina Faso        2.50 854111005  85402     1442    1453   1446 TRUE     0        FALSE
 9     1 Burkina Faso        2.50 854111005  85402     1442    1453   1445 TRUE     0        FALSE
10     1 Burkina Faso        2.50 854111005  85402     1442    1453   1444 TRUE     0        FALSE
11     1 Burkina Faso        2.50 854111005  85402     1442    1453   1443 TRUE     0        FALSE
12     1 Burkina Faso        2.50 854111005  85402     1442    1453   1442 TRUE     0        FALSE
13     2 Burkina Faso        2.61 854111004  85402     1441    1452   1452 FALSE    5        TRUE 
14     2 Burkina Faso        2.61 854111004  85402     1441    1452   1451 FALSE    5        TRUE 
15     2 Burkina Faso        2.61 854111004  85402     1441    1452   1450 FALSE    5        TRUE 
# … with 208,083 more rows</code></pre>
</div>
<p>Given our research interest, you might consider <strong>subsetting</strong> the dataset to exclude women who were already using a method at the time of the Phase 1 interview. In fact, we’ll want to keep track of these women so that we can calculate the correct <strong>degrees of freedom</strong> from each original sample size. For now, we’ll mark each of those cases as “User”, dividing the remaining cases into “Plan” and “No Plan” in a new variable called <code>INTENT</code>.</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>dat</span> <span class='op'>&lt;-</span> <span class='va'>dat</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>ID</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>    INTENT <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/case_when.html'>case_when</a></span><span class='op'>(</span></span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/any.html'>any</a></span><span class='op'>(</span><span class='va'>USE</span> <span class='op'>&amp;</span> <span class='va'>CALCMC</span> <span class='op'>==</span> <span class='va'>CALSTART</span><span class='op'>)</span> <span class='op'>~</span> <span class='st'>"User"</span>,</span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/any.html'>any</a></span><span class='op'>(</span><span class='op'>!</span><span class='va'>USE</span> <span class='op'>&amp;</span> <span class='va'>FPPLANYR</span> <span class='op'>&amp;</span> <span class='va'>CALCMC</span> <span class='op'>==</span> <span class='va'>CALSTART</span><span class='op'>)</span> <span class='op'>~</span> <span class='st'>"Plan"</span>,</span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/any.html'>any</a></span><span class='op'>(</span><span class='op'>!</span><span class='va'>USE</span> <span class='op'>&amp;</span> <span class='op'>!</span><span class='va'>FPPLANYR</span> <span class='op'>&amp;</span> <span class='va'>CALCMC</span> <span class='op'>==</span> <span class='va'>CALSTART</span><span class='op'>)</span> <span class='op'>~</span> <span class='st'>"No Plan"</span>,</span>
<span>    <span class='op'>)</span></span>
<span>  <span class='op'>)</span></span></code></pre>
</div>
</div>
<div>
<p>Lastly, whether who intend to use the <a href="https://github.com/therneau/survival">survival</a> package or its counterpart functions in the <a href="http://r-survey.r-forge.r-project.org/survey/">survey</a> package, you’ll want to <a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a> down to use one row per person: this should be the first month of <code>USE</code> or the last reported month in <code>CALCMC</code>, whichever comes first.</p>
<p>With only one row per person remaining we’ll 1) create <code>MONTH</code> to count the number of months after the Phase 1 interview, and 2) remove any extra variables that won’t be necessary in our analysis.</p>
</div>
<aside>
Women who were not yet using a method by the last calendar month are said to be <strong>right-censored</strong>. If they adopted a method at all, that month occurs after the analysis period.
</aside>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>dat</span> <span class='op'>&lt;-</span> <span class='va'>dat</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>ID</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>    USEMO <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/case_when.html'>case_when</a></span><span class='op'>(</span><span class='va'>USE</span> <span class='op'>~</span> <span class='va'>CALCMC</span><span class='op'>)</span>,</span>
<span>    KEEP <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/any.html'>any</a></span><span class='op'>(</span><span class='va'>USE</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>USEMO</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>CALCMC</span><span class='op'>)</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>KEEP</span> <span class='op'>==</span> <span class='va'>CALCMC</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>.before <span class='op'>=</span> <span class='va'>USE</span>, MONTH <span class='op'>=</span> <span class='va'>CALCMC</span> <span class='op'>-</span> <span class='va'>CALSTART</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>"CAL"</span><span class='op'>)</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>"FP"</span><span class='op'>)</span>, <span class='va'>USEMO</span>, <span class='va'>KEEP</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>dat</span> </span></code></pre>
</div>
<pre><code># A tibble: 17,725 × 8
      ID POP          PANELWEIGHT      EAID STRATA MONTH USE   INTENT 
   &lt;int&gt; &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;  &lt;int&gt; &lt;dbl&gt; &lt;lgl&gt; &lt;chr&gt;  
 1     1 Burkina Faso       2.50  854111005  85402     6 TRUE  Plan   
 2     2 Burkina Faso       2.61  854111004  85402     3 TRUE  No Plan
 3     3 Burkina Faso       3.21  854161007  85402    12 FALSE No Plan
 4     4 Burkina Faso       0.538 854141008  85401    11 FALSE No Plan
 5     5 Burkina Faso       0.358 854191022  85402     0 FALSE Plan   
 6     6 Burkina Faso       3.20  854141002  85402    12 FALSE No Plan
 7     7 Burkina Faso       0.404 854131034  85401    11 FALSE No Plan
 8     8 Burkina Faso       0.314 854191036  85402    11 FALSE No Plan
 9     9 Burkina Faso       0.337 854121003  85401     0 TRUE  User   
10    10 Burkina Faso       2.55  854231003  85402     0 FALSE No Plan
11    11 Burkina Faso       0.221 854111006  85401     9 TRUE  No Plan
12    12 Burkina Faso       0.478 854191025  85402     0 TRUE  User   
13    13 Burkina Faso       0.412 854191026  85402     0 TRUE  User   
14    14 Burkina Faso       0.404 854191013  85402     0 TRUE  User   
15    15 Burkina Faso       0.395 854131021  85401     0 TRUE  User   
# … with 17,710 more rows</code></pre>
</div>
<h1 id="unweighted-estimates">Unweighted Estimates</h1>
<p>Let’s review the procedure highlighted in our previous post, where we used no survey design information at all. To estimate a survival model for one population, we’ll filter <code>dat</code> to include only women from one sample; we’ll use Kenya as an example.</p>
<p>The function <a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a> indicates whether the observation in the last <code>MONTH</code> for each woman was adopted <code>USE</code> of a method, or that her ultimate adoption is right-censored (if at happened at all). <a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a> is part of a model formula provided to the function <a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a>; in this case, we’re modeling <code>USE</code> with each woman’s original <code>INTENT</code> at Phase 1.</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>ke_survival</span> <span class='op'>&lt;-</span> <span class='va'>dat</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>POP</span> <span class='op'>==</span> <span class='st'>"Kenya"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://rdrr.io/pkg/survival/man/survfit.html'>survfit</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/survival/man/Surv.html'>Surv</a></span><span class='op'>(</span><span class='va'>MONTH</span>, <span class='va'>USE</span><span class='op'>)</span> <span class='op'>~</span> <span class='va'>INTENT</span>, data <span class='op'>=</span> <span class='va'>.</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>ke_survival</span> </span></code></pre>
</div>
<pre><code>Call: survfit(formula = Surv(MONTH, USE) ~ INTENT, data = .)

                  n events median 0.95LCL 0.95UCL
INTENT=No Plan 2997    419     NA      NA      NA
INTENT=Plan     676    328     10       9      11
INTENT=User    3266   3266      0      NA      NA</code></pre>
</div>
<p>The output returned as <code>ke_survival</code> is an object in the <strong>survfit</strong> class defined by the <a href="https://github.com/therneau/survival">survival</a> package. We’ll get more information from this object if we pass it to <a href="https://generics.r-lib.org/reference/tidy.html">tidy</a> from the <a href="https://broom.tidymodels.org/">broom</a> package.</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'>broom</span><span class='fu'>::</span><span class='fu'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>(</span><span class='va'>ke_survival</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span>n <span class='op'>=</span> <span class='cn'>Inf</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code># A tibble: 29 × 9
    time n.risk n.event n.censor estimate std.error conf.high conf.low strata        
   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;         
 1     0   2997       0      269    1       0           1        1     INTENT=No Plan
 2     1   2728      53        0    0.981   0.00269     0.986    0.975 INTENT=No Plan
 3     2   2675      41        0    0.966   0.00362     0.972    0.959 INTENT=No Plan
 4     3   2634      24        0    0.957   0.00407     0.964    0.949 INTENT=No Plan
 5     4   2610      40        0    0.942   0.00475     0.951    0.933 INTENT=No Plan
 6     5   2570      26        0    0.933   0.00515     0.942    0.923 INTENT=No Plan
 7     6   2544      36        0    0.919   0.00567     0.930    0.909 INTENT=No Plan
 8     7   2508      34        0    0.907   0.00613     0.918    0.896 INTENT=No Plan
 9     8   2474      36        0    0.894   0.00660     0.905    0.882 INTENT=No Plan
10     9   2438      37        0    0.880   0.00707     0.892    0.868 INTENT=No Plan
11    10   2401      40        0    0.865   0.00755     0.878    0.853 INTENT=No Plan
12    11   2361      28      782    0.855   0.00788     0.869    0.842 INTENT=No Plan
13    12   1551      24     1336    0.842   0.00850     0.856    0.828 INTENT=No Plan
14    13    191       0      191    0.842   0.00850     0.856    0.828 INTENT=No Plan
15     0    676       0       90    1       0           1        1     INTENT=Plan   
16     1    586      28        0    0.952   0.00925     0.970    0.935 INTENT=Plan   
17     2    558      33        0    0.896   0.0141      0.921    0.872 INTENT=Plan   
18     3    525      45        0    0.819   0.0194      0.851    0.789 INTENT=Plan   
19     4    480      34        0    0.761   0.0231      0.796    0.727 INTENT=Plan   
20     5    446      35        0    0.701   0.0270      0.739    0.665 INTENT=Plan   
21     6    411      28        0    0.654   0.0301      0.693    0.616 INTENT=Plan   
22     7    383      35        0    0.594   0.0342      0.635    0.555 INTENT=Plan   
23     8    348      20        0    0.560   0.0366      0.601    0.521 INTENT=Plan   
24     9    328      23        0    0.520   0.0397      0.563    0.482 INTENT=Plan   
25    10    305      24        0    0.480   0.0430      0.522    0.441 INTENT=Plan   
26    11    281      15       66    0.454   0.0453      0.496    0.415 INTENT=Plan   
27    12    200       7      159    0.438   0.0473      0.481    0.399 INTENT=Plan   
28    13     34       1       33    0.425   0.0559      0.474    0.381 INTENT=Plan   
29     0   3266    3266        0    0     Inf          NA       NA     INTENT=User   </code></pre>
</div>
<p>Notice that <a href="https://generics.r-lib.org/reference/tidy.html">tidy</a> creates an object in the <strong>tibble</strong> class with several helpful columns:</p>
<ul>
<li>The most <em>important</em> column here is <code>estimate</code>: this represents the estimated probability of “surviving” continuous non-use of a method for each month in <code>time</code>.</li>
<li><code>std.error</code> shows the standard error for each <code>estimate</code> on the log scale, and is used to report a 95% confidence interval (by default) in <code>conf.high</code> and <code>conf.low</code>.</li>
<li><code>strata</code> shows that the months reported in <code>time</code> are divided by the three groups of women defined in <code>INTENT</code>.</li>
<li><code>n.risk</code> shows the original group size at month 0, and those remaining for every month afterward.</li>
<li>The number of women who adopted a method in each month are reported in <code>n.event</code>, while those who reported no further months (right-censored cases) are reported in <code>n.censor</code>.</li>
</ul>
<aside>
Don’t be fooled by the <a href="https://generics.r-lib.org/reference/tidy.html">tidy</a> column name <code>strata</code> - this refers to the <em>subgroups</em> defined by each woman’s <code>INTENT</code> at Phase 1. It <em>does not refer</em> to PMA sample strata in the variable <a href="https://pma.ipums.org/pma-action/variables/STRATA">STRATA</a>.
</aside>
<p>In the last row, <code>strata</code> shows the results for 3,266 women who were <em>already</em> using a method at month 0 (when Phase 1 interviews were conducted). The survival probability for these women is 0 because they “survived” no months of non-use.</p>
<p>Let’s create a quick step-wise Time to Event plot for the two groups with data after month 0.</p>
<div class="layout-chunk" data-layout="l-body-outset">
<details>
<summary>
Show ggplot theme
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># Define `theme_pma` for maps</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/yixuan/showtext'>showtext</a></span><span class='op'>)</span></span>
<span><span class='fu'>sysfonts</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/sysfonts/man/font_add.html'>font_add</a></span><span class='op'>(</span></span>
<span>  family <span class='op'>=</span> <span class='st'>"cabrito"</span>, </span>
<span>  regular <span class='op'>=</span> <span class='st'>"../../fonts/cabritosansnormregular-webfont.ttf"</span></span>
<span><span class='op'>)</span></span>
<span><span class='fu'>showtext</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/showtext/man/showtext_auto.html'>showtext_auto</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>theme_pma</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='op'>)</span><span class='op'>{</span></span>
<span>  <span class='va'>legned_title</span> <span class='op'>=</span>  <span class='st'>"Planned to Adopt Any Method within 12 Months"</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_wrap.html'>str_wrap</a></span><span class='op'>(</span><span class='fl'>16</span><span class='op'>)</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggtheme.html'>theme_minimal</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://ggplot2.tidyverse.org/reference/theme_get.html'>%+replace%</a></span> </span>
<span>      <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span></span>
<span>        text <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_text</a></span><span class='op'>(</span>family <span class='op'>=</span> <span class='st'>"cabrito"</span>, size <span class='op'>=</span> <span class='fl'>13</span><span class='op'>)</span>,</span>
<span>        plot.title <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_text</a></span><span class='op'>(</span></span>
<span>          size <span class='op'>=</span> <span class='fl'>18</span>, </span>
<span>          color <span class='op'>=</span> <span class='va'>pma_blue</span>, </span>
<span>          hjust <span class='op'>=</span> <span class='fl'>0</span>, </span>
<span>          margin <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>margin</a></span><span class='op'>(</span>b <span class='op'>=</span> <span class='fl'>10</span><span class='op'>)</span></span>
<span>        <span class='op'>)</span>,</span>
<span>        panel.spacing <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/grid/unit.html'>unit</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='st'>"lines"</span><span class='op'>)</span>,</span>
<span>        legend.position <span class='op'>=</span> <span class='st'>"right"</span></span>
<span>      <span class='op'>)</span>,</span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_continuous.html'>scale_y_continuous</a></span><span class='op'>(</span>labels <span class='op'>=</span> <span class='fu'>scales</span><span class='fu'>::</span><span class='va'><a href='https://scales.r-lib.org/reference/percent_format.html'>percent</a></span>, limits <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_continuous.html'>scale_x_continuous</a></span><span class='op'>(</span>limits <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>15</span><span class='op'>)</span><span class='op'>)</span>, </span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_manual.html'>scale_fill_manual</a></span><span class='op'>(</span></span>
<span>      aesthetics <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"color"</span>, <span class='st'>"fill"</span><span class='op'>)</span>,</span>
<span>      values <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>        <span class='st'>"Plan"</span> <span class='op'>=</span> <span class='va'>pma_pink</span>, </span>
<span>        <span class='st'>"No Plan"</span> <span class='op'>=</span> <span class='va'>pma_blue</span></span>
<span>      <span class='op'>)</span>,</span>
<span>      labels <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>        <span class='st'>"Plan"</span> <span class='op'>=</span> <span class='st'>"Yes"</span>, </span>
<span>        <span class='st'>"No Plan"</span> <span class='op'>=</span> <span class='st'>"No"</span></span>
<span>      <span class='op'>)</span></span>
<span>    <span class='op'>)</span>, </span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span></span>
<span>      x <span class='op'>=</span> <span class='st'>"Months After Baseline"</span>, </span>
<span>      y <span class='op'>=</span> <span class='st'>"Probability of Continued Non-use"</span>,</span>
<span>      fill <span class='op'>=</span> <span class='va'>legned_title</span>,</span>
<span>      color <span class='op'>=</span> <span class='va'>legned_title</span></span>
<span>    <span class='op'>)</span></span>
<span>  <span class='op'>)</span></span>
<span><span class='op'>}</span></span></code></pre>
</div>
</details>
</div>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>ke_survival</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'>broom</span><span class='fu'>::</span><span class='fu'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>estimate <span class='op'>=</span> <span class='fl'>1</span> <span class='op'>-</span> <span class='va'>estimate</span>, strata <span class='op'>=</span> <span class='va'>strata</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_remove.html'>str_remove</a></span><span class='op'>(</span><span class='st'>"INTENT="</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>strata</span> <span class='op'>!=</span> <span class='st'>"User"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>time</span>, y <span class='op'>=</span> <span class='va'>estimate</span>, color <span class='op'>=</span> <span class='va'>strata</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_step</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> </span>
<span>  <span class='fu'>theme_pma</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>title <span class='op'>=</span> <span class='st'>"Predicted time to FP Adoption for Phase 1 Non-users in Kenya"</span><span class='op'>)</span></span></code></pre>
</div>
<p><img src="survey-survival_files/figure-html5/unnamed-chunk-10-1.png" width="960" style="display: block; margin: auto;" /></p>
</div>
<p>No surprises here: women who planned to adopt a method at Phase 1 are expected to adopt one sooner than women with no such plans. Notice, however, that we didn’t bother to plot confidence intervals for each line: that’s because we’ll first want to incorporate information about the PMA sampling procedure with help from the <a href="http://r-survey.r-forge.r-project.org/survey/">survey</a> package.</p>
<h1 id="survey-design">Survey Design</h1>
<p>We can use a similar workflow with <a href="http://r-survey.r-forge.r-project.org/survey/">survey</a>, but it’s important to remember that the output of <a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a> shown above was an object of a particular class called <strong>survfit</strong> - because <a href="https://github.com/therneau/survival">survival</a> is such a popular package, the developers of <a href="https://broom.tidymodels.org/">broom</a> wrote specific methods for <a href="https://generics.r-lib.org/reference/tidy.html">tidy</a>-ing objects from this class.</p>
<p><a href="http://r-survey.r-forge.r-project.org/survey/">survey</a> uses the <a href="https://github.com/therneau/survival">survival</a> function <a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a>, but has its <em>own</em> modeling function <a href="https://rdrr.io/pkg/survey/man/svykm.html">svykm</a>. Its output is not familiar to <a href="https://broom.tidymodels.org/">broom</a>, so we’ll have to create our own tidy output from scratch.</p>
<p>Before we add survey design information, let’s ensure that we’re able to reproduce the above results with <a href="https://rdrr.io/pkg/survey/man/svykm.html">svykm</a>. This time, we’ll pass dummy survey design information to <a href="http://gdfe.co/srvyr/reference/as_survey_design.html">as_survey_design</a> via a test-variable <code>w</code>: we’ll use this to weight every case equally with the value <code>1</code>.</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>ke_survey</span> <span class='op'>&lt;-</span> <span class='va'>dat</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>POP</span> <span class='op'>==</span> <span class='st'>"Kenya"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>w <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='http://gdfe.co/srvyr/reference/as_survey_design.html'>as_survey_design</a></span><span class='op'>(</span>weight <span class='op'>=</span> <span class='va'>w</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://rdrr.io/pkg/survey/man/svykm.html'>svykm</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/survival/man/Surv.html'>Surv</a></span><span class='op'>(</span><span class='va'>MONTH</span>, <span class='va'>USE</span><span class='op'>)</span> <span class='op'>~</span> <span class='va'>INTENT</span>, design <span class='op'>=</span> <span class='va'>.</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>ke_survey</span></span></code></pre>
</div>
<pre><code>Weighted survival curves:
svykm(formula = Surv(MONTH, USE) ~ INTENT, design = .)
No Plan : Q1 = Inf  median = Inf  Q3 = Inf 
Plan : Q1 = 5  median = 10  Q3 = Inf 
User : Q1 = 0  median = 0  Q3 = 0 </code></pre>
</div>
<p>Notice how this output looks different from <code>ke_survival</code>? If we try, <a href="https://broom.tidymodels.org/">broom</a> will be unable to <a href="https://generics.r-lib.org/reference/tidy.html">tidy</a> it.</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'>broom</span><span class='fu'>::</span><span class='fu'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>(</span><span class='va'>ke_survey</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>Error: No tidy method for objects of class svykmlist</code></pre>
</div>
<p>You can think about <code>ke_survey</code> as a kind of special list, with one element per group in <code>INTENT</code>. Each of those elements also has a list-like structure with vectors representing <code>time</code> (months), <code>surv</code> (survival probability), and standard error (if specified). For example, you can use list-syntax to check that the monthly estimates in <code>ke_survey</code> match those in <code>ke_survival</code> for women who planned to adopt a method:</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>ke_survey</span><span class='op'>$</span><span class='va'>Plan</span><span class='op'>$</span><span class='va'>surv</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='fl'>3</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code> [1] 1.000 1.000 0.952 0.896 0.819 0.761 0.701 0.654 0.594 0.560 0.520 0.480 0.454 0.438 0.425</code></pre>
</div>
<p>We’ll want to compile all of these lists in a <a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a>, which we’ll demonstrate with the <a href="https://www.tidyverse.org/blog/2022/12/purrr-1-0-0/">new recommended workflow</a> for <a href="https://purrr.tidyverse.org/reference/map.html">map</a> with <a href="https://purrr.tidyverse.org/">purrr</a> version 1.0.0. (We now use <a href="https://purrr.tidyverse.org/reference/list_c.html">list_rbind</a> in place of <a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_dfr</a>, which has been <a href="https://lifecycle.r-lib.org/articles/stages.html#superseded">superseded</a>).</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>ke_survey</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://purrr.tidyverse.org/reference/imap.html'>imap</a></span><span class='op'>(</span><span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>strata <span class='op'>=</span> <span class='va'>.y</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://purrr.tidyverse.org/reference/list_c.html'>list_rbind</a></span><span class='op'>(</span><span class='op'>)</span> </span></code></pre>
</div>
<pre><code># A tibble: 32 × 3
    time  surv strata 
   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  
 1     0 1     No Plan
 2     0 1     No Plan
 3     1 0.981 No Plan
 4     2 0.966 No Plan
 5     3 0.957 No Plan
 6     4 0.942 No Plan
 7     5 0.933 No Plan
 8     6 0.919 No Plan
 9     7 0.907 No Plan
10     8 0.894 No Plan
11     9 0.880 No Plan
12    10 0.865 No Plan
13    11 0.855 No Plan
14    12 0.842 No Plan
15    13 0.842 No Plan
# … with 17 more rows</code></pre>
</div>
<p>We’ll ultimately want cluster-robust standard error estimates for each month, so this output isn’t very useful on its own. Instead, we’ll specify <code>se = TRUE</code> in <a href="https://rdrr.io/pkg/survey/man/svykm.html">svykm</a>. Just make sure to drop women who were originally using a method at Phase 1: the estimated standard error for these cases is infinite in month 0, and R will likely stall if you don’t exclude them from <a href="https://rdrr.io/pkg/survey/man/svykm.html">svykm</a>! We’ll do this <em>after</em> our call to <a href="http://gdfe.co/srvyr/reference/as_survey_design.html">as_survey_design</a> in order to preserve the correct sample size.</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>ke_survey</span> <span class='op'>&lt;-</span> <span class='va'>dat</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>POP</span> <span class='op'>==</span> <span class='st'>"Kenya"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>w <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='http://gdfe.co/srvyr/reference/as_survey_design.html'>as_survey_design</a></span><span class='op'>(</span>weight <span class='op'>=</span> <span class='va'>w</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>INTENT</span> <span class='op'>!=</span> <span class='st'>"User"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='co'># remove baseline users </span></span>
<span>  <span class='fu'><a href='https://rdrr.io/pkg/survey/man/svykm.html'>svykm</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/survival/man/Surv.html'>Surv</a></span><span class='op'>(</span><span class='va'>MONTH</span>, <span class='va'>USE</span><span class='op'>)</span> <span class='op'>~</span> <span class='va'>INTENT</span>, design <span class='op'>=</span> <span class='va'>.</span>, se <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='co'># add se = TRUE</span></span>
<span>  <span class='fu'><a href='https://purrr.tidyverse.org/reference/imap.html'>imap</a></span><span class='op'>(</span><span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>strata <span class='op'>=</span> <span class='va'>.y</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://purrr.tidyverse.org/reference/list_c.html'>list_rbind</a></span><span class='op'>(</span><span class='op'>)</span> </span>
<span></span>
<span><span class='va'>ke_survey</span></span></code></pre>
</div>
<pre><code># A tibble: 747 × 4
    time  surv      varlog strata 
   &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt; &lt;chr&gt;  
 1     1 1.00  0.000000134 No Plan
 2     1 0.999 0.000000269 No Plan
 3     1 0.999 0.000000403 No Plan
 4     1 0.999 0.000000537 No Plan
 5     1 0.998 0.000000671 No Plan
 6     1 0.998 0.000000805 No Plan
 7     1 0.997 0.000000938 No Plan
 8     1 0.997 0.00000107  No Plan
 9     1 0.997 0.00000121  No Plan
10     1 0.996 0.00000134  No Plan
11     1 0.996 0.00000147  No Plan
12     1 0.996 0.00000161  No Plan
13     1 0.995 0.00000174  No Plan
14     1 0.995 0.00000187  No Plan
15     1 0.995 0.00000200  No Plan
# … with 732 more rows</code></pre>
</div>
<p>The new column <code>varlog</code> represents the log-scale variance, which is the square of our desired standard error. The confidence intervals shown above can be reproduced if we use <code>p = 0.05</code> in <a href="https://rdrr.io/r/stats/Normal.html">qnorm</a> and exponentiate the results.</p>
<aside>
We also use <a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a> here to obtain just one estimate per month. When you use <code>se = TRUE</code>, <a href="https://rdrr.io/pkg/survey/man/svykm.html">svykm</a> generates one row for <em>each case</em> that experienced the event.
</aside>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>ke_survey</span> <span class='op'>&lt;-</span> <span class='va'>ke_survey</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>strata</span>, <span class='va'>time</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarise</a></span><span class='op'>(</span></span>
<span>    n.event <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>    estimate <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>surv</span><span class='op'>)</span>,</span>
<span>    std.error <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='va'>varlog</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>    conf.high <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>estimate</span><span class='op'>)</span> <span class='op'>-</span> <span class='va'>std.error</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>qnorm</a></span><span class='op'>(</span><span class='fl'>0.05</span><span class='op'>/</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>    conf.low <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>estimate</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>std.error</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>qnorm</a></span><span class='op'>(</span><span class='fl'>0.05</span><span class='op'>/</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span></span>
<span></span>
<span><span class='va'>ke_survey</span></span></code></pre>
</div>
<pre><code># A tibble: 25 × 7
# Groups:   strata [2]
   strata   time n.event estimate std.error conf.high conf.low
   &lt;chr&gt;   &lt;dbl&gt;   &lt;int&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
 1 No Plan     1      53    0.981  0.000367     0.981    0.980
 2 No Plan     2      41    0.966  0.00267      0.971    0.961
 3 No Plan     3      24    0.957  0.00357      0.964    0.950
 4 No Plan     4      40    0.943  0.00403      0.950    0.935
 5 No Plan     5      26    0.933  0.00469      0.942    0.925
 6 No Plan     6      36    0.920  0.00509      0.929    0.911
 7 No Plan     7      34    0.908  0.00560      0.918    0.898
 8 No Plan     8      36    0.894  0.00606      0.905    0.884
 9 No Plan     9      37    0.881  0.00652      0.892    0.870
10 No Plan    10      40    0.866  0.00698      0.878    0.855
11 No Plan    11      28    0.856  0.00745      0.869    0.844
12 No Plan    12      24    0.843  0.00779      0.856    0.830
13 Plan        1      28    0.953  0.00171      0.957    0.950
14 Plan        2      33    0.899  0.00899      0.915    0.883
15 Plan        3      45    0.825  0.0135       0.847    0.803
# … with 10 more rows</code></pre>
</div>
<p>This is <em>close</em> to the output from <code>ke_survival</code>, except that you’ll notice we have no rows for months were all cases are censored (e.g. month 0). This leaves us with no column analogous to <code>n.risk</code>. We’ll create it from <code>dat</code> and then <a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a> the results from <code>ke_survey</code>. If you’d like to have a column for censored cases in <code>n.censor</code>, it can be made by subtracting <code>n.event</code> from the count of women in each month (<code>n</code>). Lastly, we’ll carry the same <code>std.error</code> and confidence interval downward for all new rows where only censored cases are listed.</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>ke_survey</span> <span class='op'>&lt;-</span> <span class='va'>dat</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>POP</span> <span class='op'>==</span> <span class='st'>"Kenya"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>INTENT</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/count.html'>count</a></span><span class='op'>(</span><span class='va'>MONTH</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>n.risk <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/if_else.html'>if_else</a></span><span class='op'>(</span><span class='va'>MONTH</span> <span class='op'>==</span> <span class='fl'>0</span>, <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span>, <span class='fu'>lag</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span> <span class='op'>-</span> <span class='va'>n</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>strata <span class='op'>=</span> <span class='va'>INTENT</span>, time <span class='op'>=</span> <span class='va'>MONTH</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>ke_survey</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>    n.event <span class='op'>=</span> <span class='va'>n.event</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://tidyr.tidyverse.org/reference/replace_na.html'>replace_na</a></span><span class='op'>(</span><span class='fl'>0</span><span class='op'>)</span>, </span>
<span>    n.censor <span class='op'>=</span> <span class='va'>n</span> <span class='op'>-</span> <span class='va'>n.event</span>,</span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span></span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>estimate</span>, <span class='va'>std.error</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>"conf"</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>      <span class='op'>~</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/case_when.html'>case_when</a></span><span class='op'>(</span></span>
<span>        <span class='va'>time</span> <span class='op'>==</span> <span class='fl'>0</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/base/double.html'>as.double</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>cur_column</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>!=</span> <span class='st'>"std.error"</span><span class='op'>)</span>,</span>
<span>        <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span> <span class='op'>~</span> <span class='va'>.x</span>,</span>
<span>        <span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span> <span class='op'>~</span> <span class='fu'>lag</span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span></span>
<span>      <span class='op'>)</span></span>
<span>    <span class='op'>)</span></span>
<span>  <span class='op'>)</span></span>
<span></span>
<span><span class='va'>ke_survey</span></span></code></pre>
</div>
<pre><code># A tibble: 29 × 10
# Groups:   strata [3]
   strata   time     n n.risk n.event estimate std.error conf.high conf.low n.censor
   &lt;chr&gt;   &lt;dbl&gt; &lt;int&gt;  &lt;int&gt;   &lt;int&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;int&gt;
 1 No Plan     0   269   2997       0    1      0            1        1          269
 2 No Plan     1    53   2728      53    0.981  0.000367     0.981    0.980        0
 3 No Plan     2    41   2944      41    0.966  0.00267      0.971    0.961        0
 4 No Plan     3    24   2956      24    0.957  0.00357      0.964    0.950        0
 5 No Plan     4    40   2973      40    0.943  0.00403      0.950    0.935        0
 6 No Plan     5    26   2957      26    0.933  0.00469      0.942    0.925        0
 7 No Plan     6    36   2971      36    0.920  0.00509      0.929    0.911        0
 8 No Plan     7    34   2961      34    0.908  0.00560      0.918    0.898        0
 9 No Plan     8    36   2963      36    0.894  0.00606      0.905    0.884        0
10 No Plan     9    37   2961      37    0.881  0.00652      0.892    0.870        0
11 No Plan    10    40   2960      40    0.866  0.00698      0.878    0.855        0
12 No Plan    11   810   2957      28    0.856  0.00745      0.869    0.844      782
13 No Plan    12  1360   2187      24    0.843  0.00779      0.856    0.830     1336
14 No Plan    13   191   1637       0    0.843  0.00779      0.856    0.830      191
15 Plan        0    90    676       0    1      0            1        1           90
# … with 14 more rows</code></pre>
</div>
<p>Now that we know how to obtain identical results from <a href="https://github.com/therneau/survival">survival</a> and <a href="http://r-survey.r-forge.r-project.org/survey/">survey</a>, we’ll rebuild our table with the <em>actual</em> survey weights, cluster IDs, and stratum IDs in <a href="http://gdfe.co/srvyr/reference/as_survey_design.html">as_survey_design</a>.</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># Fit the survival model with information from `as_survey_design`</span></span>
<span> <span class='va'>ke_survey</span> <span class='op'>&lt;-</span> <span class='va'>dat</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>POP</span> <span class='op'>==</span> <span class='st'>"Kenya"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='http://gdfe.co/srvyr/reference/as_survey_design.html'>as_survey_design</a></span><span class='op'>(</span>weight <span class='op'>=</span> <span class='va'>PANELWEIGHT</span>, id <span class='op'>=</span> <span class='va'>EAID</span>, strata <span class='op'>=</span> <span class='va'>STRATA</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>INTENT</span> <span class='op'>!=</span> <span class='st'>"User"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://rdrr.io/pkg/survey/man/svykm.html'>svykm</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/survival/man/Surv.html'>Surv</a></span><span class='op'>(</span><span class='va'>MONTH</span>, <span class='va'>USE</span><span class='op'>)</span> <span class='op'>~</span> <span class='va'>INTENT</span>, design <span class='op'>=</span> <span class='va'>.</span>, se <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> </span>
<span></span>
<span><span class='co'># Create tidy output from the `svykm` object</span></span>
<span><span class='va'>ke_survey</span> <span class='op'>&lt;-</span> <span class='va'>ke_survey</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://purrr.tidyverse.org/reference/imap.html'>imap</a></span><span class='op'>(</span><span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>strata <span class='op'>=</span> <span class='va'>.y</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://purrr.tidyverse.org/reference/list_c.html'>list_rbind</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>strata</span>, <span class='va'>time</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarise</a></span><span class='op'>(</span></span>
<span>    n.event <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>    estimate <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>surv</span><span class='op'>)</span>,</span>
<span>    std.error <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='va'>varlog</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>    conf.high <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>estimate</span><span class='op'>)</span> <span class='op'>-</span> <span class='va'>std.error</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>qnorm</a></span><span class='op'>(</span><span class='fl'>0.05</span><span class='op'>/</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>    conf.low <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>estimate</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>std.error</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>qnorm</a></span><span class='op'>(</span><span class='fl'>0.05</span><span class='op'>/</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span></span>
<span></span>
<span><span class='co'># Complete tidy output with information about censored cases in each month</span></span>
<span><span class='va'>ke_survey</span> <span class='op'>&lt;-</span> <span class='va'>dat</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>POP</span> <span class='op'>==</span> <span class='st'>"Kenya"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>INTENT</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/count.html'>count</a></span><span class='op'>(</span><span class='va'>MONTH</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>n.risk <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/if_else.html'>if_else</a></span><span class='op'>(</span><span class='va'>MONTH</span> <span class='op'>==</span> <span class='fl'>0</span>, <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span>, <span class='fu'>lag</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span> <span class='op'>-</span> <span class='va'>n</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>strata <span class='op'>=</span> <span class='va'>INTENT</span>, time <span class='op'>=</span> <span class='va'>MONTH</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>ke_survey</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>    n.event <span class='op'>=</span> <span class='va'>n.event</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://tidyr.tidyverse.org/reference/replace_na.html'>replace_na</a></span><span class='op'>(</span><span class='fl'>0</span><span class='op'>)</span>, </span>
<span>    n.censor <span class='op'>=</span> <span class='va'>n</span> <span class='op'>-</span> <span class='va'>n.event</span>,</span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span></span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>estimate</span>, <span class='va'>std.error</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>"conf"</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>      <span class='op'>~</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/case_when.html'>case_when</a></span><span class='op'>(</span></span>
<span>        <span class='va'>time</span> <span class='op'>==</span> <span class='fl'>0</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/base/double.html'>as.double</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>cur_column</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>!=</span> <span class='st'>"std.error"</span><span class='op'>)</span>,</span>
<span>        <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span> <span class='op'>~</span> <span class='va'>.x</span>,</span>
<span>        <span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span> <span class='op'>~</span> <span class='fu'>lag</span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span></span>
<span>      <span class='op'>)</span></span>
<span>    <span class='op'>)</span></span>
<span>  <span class='op'>)</span></span>
<span></span>
<span><span class='va'>ke_survey</span></span></code></pre>
</div>
<pre><code># A tibble: 29 × 10
# Groups:   strata [3]
   strata   time     n n.risk n.event estimate std.error conf.high conf.low n.censor
   &lt;chr&gt;   &lt;dbl&gt; &lt;int&gt;  &lt;int&gt;   &lt;int&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;int&gt;
 1 No Plan     0   269   2997       0    1      0            1        1          269
 2 No Plan     1    53   2728      53    0.981  0.000201     0.982    0.981        0
 3 No Plan     2    41   2944      41    0.965  0.00279      0.971    0.960        0
 4 No Plan     3    24   2956      24    0.958  0.00418      0.966    0.950        0
 5 No Plan     4    40   2973      40    0.942  0.00487      0.951    0.933        0
 6 No Plan     5    26   2957      26    0.934  0.00556      0.944    0.924        0
 7 No Plan     6    36   2971      36    0.920  0.00583      0.931    0.910        0
 8 No Plan     7    34   2961      34    0.907  0.00689      0.920    0.895        0
 9 No Plan     8    36   2963      36    0.898  0.00767      0.911    0.884        0
10 No Plan     9    37   2961      37    0.883  0.00808      0.897    0.869        0
11 No Plan    10    40   2960      40    0.869  0.00886      0.884    0.854        0
12 No Plan    11   810   2957      28    0.860  0.00982      0.876    0.843      782
13 No Plan    12  1360   2187      24    0.845  0.0103       0.862    0.828     1336
14 No Plan    13   191   1637       0    0.845  0.0103       0.862    0.828      191
15 Plan        0    90    676       0    1      0            1        1           90
# … with 14 more rows</code></pre>
</div>
<p>Finally, we’ll plot these new weighted estimates, this time also adding their associated cluster-robust confidence intervals with <a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_rect</a>.</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>ke_survey</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>strata</span> <span class='op'>!=</span> <span class='st'>"User"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>strata</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>estimate</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>"conf"</span><span class='op'>)</span><span class='op'>)</span>, <span class='op'>~</span><span class='fl'>1</span> <span class='op'>-</span> <span class='va'>.x</span><span class='op'>)</span>,</span>
<span>    xmax <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/if_else.html'>if_else</a></span><span class='op'>(</span><span class='va'>time</span> <span class='op'>==</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>time</span><span class='op'>)</span>, <span class='va'>time</span>, <span class='va'>time</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>time</span>, y <span class='op'>=</span> <span class='va'>estimate</span>, fill <span class='op'>=</span> <span class='va'>strata</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_step</a></span><span class='op'>(</span>linewidth <span class='op'>=</span> <span class='fl'>0.25</span><span class='op'>)</span> <span class='op'>+</span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_tile.html'>geom_rect</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>xmin <span class='op'>=</span> <span class='va'>time</span>, xmax <span class='op'>=</span> <span class='va'>xmax</span>, ymin <span class='op'>=</span> <span class='va'>conf.low</span>, ymax <span class='op'>=</span> <span class='va'>conf.high</span><span class='op'>)</span>,</span>
<span>    alpha <span class='op'>=</span> <span class='fl'>0.2</span>, color <span class='op'>=</span> <span class='fl'>0</span></span>
<span>  <span class='op'>)</span> <span class='op'>+</span> </span>
<span>  <span class='fu'>theme_pma</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span></span>
<span>    title <span class='op'>=</span> <span class='st'>"Predicted time to FP Adoption for Phase 1 Non-users in Kenya"</span>,</span>
<span>    subtitle <span class='op'>=</span> <span class='st'>"Weighted estimates (95% CI)"</span></span>
<span>  <span class='op'>)</span></span></code></pre>
</div>
<p><img src="survey-survival_files/figure-html5/unnamed-chunk-19-1.png" width="960" style="display: block; margin: auto;" /></p>
</div>
<h1 id="data-with-multiple-samples">Data with Multiple Samples</h1>
<p>So far, we’ve only generated survival curves for <em>one</em> of the samples in our original data extract. Now we’ll show how to iterate through each of the samples, and then compbine their results in a faceted plot.</p>
<p>The tricky thing here is that we need to be careful to avoid <em>combining sample sizes</em> in the formula <a href="http://r-survey.r-forge.r-project.org/survey/">survey</a> uses to calculate degrees of freedom. Remember our point above about <em>not</em> subsetting the Kenya sample to exclude Phase 1 users prior to defining its survey design? By contrast, you <em>should</em> subset your data extract before defining survey design <em>if your extract contains multiple samples</em>.</p>
<p>Fortunately, this procedure is made very simple with two functions from <a href="https://dplyr.tidyverse.org">dplyr</a>: we’ll use <a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a> followed by <a href="https://dplyr.tidyverse.org/reference/group_map.html">group_modify</a>.</p>
<p>In <a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a>, we’ll subset <code>dat</code> by the variable <code>POP</code> so that everything in <a href="https://dplyr.tidyverse.org/reference/group_map.html">group_modify</a> applies only to the members of each group.</p>
<p>Then, in <a href="https://dplyr.tidyverse.org/reference/group_map.html">group_modify</a>, we’ll signal an anonymous function with <code>~{}</code>, inside of which <code>.x</code> references only the data <em>within each group</em>. Hence <code>.x</code> replaces all of the code where we’d written <code>dat %&gt;% filter(POP == "Kenya")</code> above. We also replace the name <code>ke_survey</code> with a more general name <code>output</code>.</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>dat_surv</span> <span class='op'>&lt;-</span> <span class='va'>dat</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>POP</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_map.html'>group_modify</a></span><span class='op'>(</span><span class='op'>~</span><span class='op'>{</span></span>
<span>    <span class='co'># Fit the survival model with information from `as_survey_design`</span></span>
<span>    <span class='va'>output</span> <span class='op'>&lt;-</span> <span class='va'>.x</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>      <span class='fu'><a href='http://gdfe.co/srvyr/reference/as_survey_design.html'>as_survey_design</a></span><span class='op'>(</span>weight <span class='op'>=</span> <span class='va'>PANELWEIGHT</span>, id <span class='op'>=</span> <span class='va'>EAID</span>, strata <span class='op'>=</span> <span class='va'>STRATA</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>INTENT</span> <span class='op'>!=</span> <span class='st'>"User"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>      <span class='fu'><a href='https://rdrr.io/pkg/survey/man/svykm.html'>svykm</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/survival/man/Surv.html'>Surv</a></span><span class='op'>(</span><span class='va'>MONTH</span>, <span class='va'>USE</span><span class='op'>)</span> <span class='op'>~</span> <span class='va'>INTENT</span>, design <span class='op'>=</span> <span class='va'>.</span>, se <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> </span>
<span>    </span>
<span>    <span class='co'># Create tidy output from the `svykm` object</span></span>
<span>    <span class='va'>output</span> <span class='op'>&lt;-</span> <span class='va'>output</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>      <span class='fu'><a href='https://purrr.tidyverse.org/reference/imap.html'>imap</a></span><span class='op'>(</span><span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>strata <span class='op'>=</span> <span class='va'>.y</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>      <span class='fu'><a href='https://purrr.tidyverse.org/reference/list_c.html'>list_rbind</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>strata</span>, <span class='va'>time</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarise</a></span><span class='op'>(</span></span>
<span>        n.event <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>        estimate <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>surv</span><span class='op'>)</span>,</span>
<span>        std.error <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='va'>varlog</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>        conf.high <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>estimate</span><span class='op'>)</span> <span class='op'>-</span> <span class='va'>std.error</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>qnorm</a></span><span class='op'>(</span><span class='fl'>0.05</span><span class='op'>/</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>        conf.low <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>estimate</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>std.error</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>qnorm</a></span><span class='op'>(</span><span class='fl'>0.05</span><span class='op'>/</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span></span>
<span>      <span class='op'>)</span></span>
<span>    </span>
<span>    <span class='co'># Complete tidy output with information about censored cases in each month</span></span>
<span>    <span class='va'>output</span> <span class='op'>&lt;-</span> <span class='va'>.x</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>INTENT</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/count.html'>count</a></span><span class='op'>(</span><span class='va'>MONTH</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>n.risk <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/if_else.html'>if_else</a></span><span class='op'>(</span><span class='va'>MONTH</span> <span class='op'>==</span> <span class='fl'>0</span>, <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span>, <span class='fu'>lag</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span> <span class='op'>-</span> <span class='va'>n</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>strata <span class='op'>=</span> <span class='va'>INTENT</span>, time <span class='op'>=</span> <span class='va'>MONTH</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>output</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>        n.event <span class='op'>=</span> <span class='va'>n.event</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://tidyr.tidyverse.org/reference/replace_na.html'>replace_na</a></span><span class='op'>(</span><span class='fl'>0</span><span class='op'>)</span>, </span>
<span>        n.censor <span class='op'>=</span> <span class='va'>n</span> <span class='op'>-</span> <span class='va'>n.event</span>,</span>
<span>        <span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span></span>
<span>          <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>estimate</span>, <span class='va'>std.error</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>"conf"</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>          <span class='op'>~</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/case_when.html'>case_when</a></span><span class='op'>(</span></span>
<span>            <span class='va'>time</span> <span class='op'>==</span> <span class='fl'>0</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/base/double.html'>as.double</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>cur_column</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>!=</span> <span class='st'>"std.error"</span><span class='op'>)</span>,</span>
<span>            <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span> <span class='op'>~</span> <span class='va'>.x</span>,</span>
<span>            <span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span> <span class='op'>~</span> <span class='fu'>lag</span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span></span>
<span>          <span class='op'>)</span></span>
<span>        <span class='op'>)</span></span>
<span>      <span class='op'>)</span></span>
<span>  <span class='op'>}</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>dat_surv</span></span></code></pre>
</div>
<pre><code># A tibble: 175 × 11
   POP          strata   time     n n.risk n.event estimate std.error conf.high conf.low n.censor
   &lt;chr&gt;        &lt;chr&gt;   &lt;dbl&gt; &lt;int&gt;  &lt;int&gt;   &lt;int&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;int&gt;
 1 Burkina Faso No Plan     0   348   2686       0    1      0            1        1          348
 2 Burkina Faso No Plan     1    30   2338      30    0.990  0.000334     0.990    0.989        0
 3 Burkina Faso No Plan     2    20   2656      20    0.984  0.00304      0.990    0.979        0
 4 Burkina Faso No Plan     3    16   2666      16    0.977  0.00424      0.985    0.969        0
 5 Burkina Faso No Plan     4    22   2670      22    0.967  0.00500      0.976    0.957        0
 6 Burkina Faso No Plan     5    16   2664      16    0.958  0.00617      0.970    0.947        0
 7 Burkina Faso No Plan     6    18   2670      18    0.952  0.00666      0.964    0.940        0
 8 Burkina Faso No Plan     7    22   2668      22    0.943  0.00751      0.957    0.929        0
 9 Burkina Faso No Plan     8    17   2664      17    0.937  0.00783      0.952    0.923        0
10 Burkina Faso No Plan     9    32   2669      32    0.927  0.00820      0.942    0.912        0
11 Burkina Faso No Plan    10   152   2654      39    0.911  0.00936      0.928    0.895      113
12 Burkina Faso No Plan    11  1100   2534      29    0.902  0.0103       0.920    0.884     1071
13 Burkina Faso No Plan    12   783   1586       7    0.894  0.0116       0.915    0.874      776
14 Burkina Faso No Plan    13    84   1903       3    0.879  0.0131       0.902    0.857       81
15 Burkina Faso No Plan    14    26   2602       0    0.879  0.0131       0.902    0.857       26
# … with 160 more rows</code></pre>
</div>
<p>The resulting tibble <code>dat_surv</code> includes the <code>POP</code> variable we used to define each group. That’s helpful, because we’ll now want to use add <code>facet_wrap(~POP)</code> to our previous <a href="https://ggplot2.tidyverse.org">ggplot2</a> code, thereby creating one panel from each sample.</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>dat_surv</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>strata</span> <span class='op'>!=</span> <span class='st'>"User"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>POP</span>, <span class='va'>strata</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>estimate</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>"conf"</span><span class='op'>)</span><span class='op'>)</span>, <span class='op'>~</span><span class='fl'>1</span> <span class='op'>-</span> <span class='va'>.x</span><span class='op'>)</span>,</span>
<span>    xmax <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/if_else.html'>if_else</a></span><span class='op'>(</span><span class='va'>time</span> <span class='op'>==</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>time</span><span class='op'>)</span>, <span class='va'>time</span>, <span class='va'>time</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>time</span>, y <span class='op'>=</span> <span class='va'>estimate</span>, fill <span class='op'>=</span> <span class='va'>strata</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_step</a></span><span class='op'>(</span>linewidth <span class='op'>=</span> <span class='fl'>0.25</span><span class='op'>)</span> <span class='op'>+</span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_tile.html'>geom_rect</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>xmin <span class='op'>=</span> <span class='va'>time</span>, xmax <span class='op'>=</span> <span class='va'>xmax</span>, ymin <span class='op'>=</span> <span class='va'>conf.low</span>, ymax <span class='op'>=</span> <span class='va'>conf.high</span><span class='op'>)</span>,</span>
<span>    alpha <span class='op'>=</span> <span class='fl'>0.2</span>, color <span class='op'>=</span> <span class='fl'>0</span></span>
<span>  <span class='op'>)</span> <span class='op'>+</span> </span>
<span>  <span class='fu'>theme_pma</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span></span>
<span>    title <span class='op'>=</span> <span class='st'>"Predicted time to FP Adoption for Phase 1 Non-users"</span>,</span>
<span>    subtitle <span class='op'>=</span> <span class='st'>"Weighted estimates (95% CI)"</span></span>
<span>  <span class='op'>)</span> <span class='op'>+</span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/facet_wrap.html'>facet_wrap</a></span><span class='op'>(</span><span class='op'>~</span><span class='va'>POP</span><span class='op'>)</span> <span class='co'># one panel per sample </span></span></code></pre>
</div>
<p><img src="survey-survival_files/figure-html5/unnamed-chunk-21-1.png" width="960" data-distill-preview=1 style="display: block; margin: auto;" /></p>
</div>
<div class="sourceCode" id="cb15"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>Certain functions like <a href="https://rdrr.io/pkg/survival/man/survfit.html">survival::survfit</a> function do accept a <code>weight</code> argument, but these are intended for <em>frequency weights</em> representing duplicate observations. Our discussion concerns <em>survey weights</em> representing each woman’s sampling probability. You can use the <code>weight</code> arguments in the <a href="https://github.com/therneau/survival">survival</a> package to obtain weighted point-estimates, but the standard error estimation will be incorrect. <a href="https://stats.stackexchange.com/questions/538876/what-does-the-weights-argument-do-when-fitting-kaplan-meier-curveswith-the-sur">See discussion here</a>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><a href="https://pma.ipums.org/pma-action/variables/panelweight">PANELWEIGHT</a> should be used in analyses of all questions on the female questionnaire for women who were interviewed in both Phase 1 and Phase 2 survey rounds. See our <a href="https://pma.ipums.org/pma/weightguide.shtml#long">weighting guide</a> for details.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>We discuss reasons for missing data in our <a href="../2022-05-15-phase2-calendar">previous Contraceptive Calendar post</a>. The data we feature here have been modified to include women who maintained the same family planning status throughout the duration of the calendar period.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
