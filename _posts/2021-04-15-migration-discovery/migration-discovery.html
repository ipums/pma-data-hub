<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #20794d; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007ba5; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #007ba5; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #007ba5; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #20794d; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>

  <!--radix_placeholder_meta_tags-->
  <title>Formatting Migration Recall Data for Longitudinal Analysis</title>

  <meta property="description" itemprop="description" content="Use tidyr::pivot_longer to reshape wide data into a long format."/>


  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2021-04-15"/>
  <meta property="article:created" itemprop="dateCreated" content="2021-04-15"/>
  <meta name="article:author" content="Matt Gunther"/>

  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Formatting Migration Recall Data for Longitudinal Analysis"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="Use tidyr::pivot_longer to reshape wide data into a long format."/>
  <meta property="og:locale" content="en_US"/>

  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Formatting Migration Recall Data for Longitudinal Analysis"/>
  <meta property="twitter:description" content="Use tidyr::pivot_longer to reshape wide data into a long format."/>

  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","categories","output","preview"]}},"value":[{"type":"character","attributes":{},"value":["Formatting Migration Recall Data for Longitudinal Analysis"]},{"type":"character","attributes":{},"value":["Use tidyr::pivot_longer to reshape wide data into a long format.\n"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","affiliation"]}},"value":[{"type":"character","attributes":{},"value":["Matt Gunther"]},{"type":"character","attributes":{},"value":["IPUMS PMA Senior Data Analyst"]}]}]},{"type":"character","attributes":{},"value":["04-15-2021"]},{"type":"character","attributes":{},"value":["Migration","Data Discovery","Data Manipulation","pivot_longer","regex"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","toc","toc_depth","toc_float"]}},"value":[{"type":"logical","attributes":{},"value":[false]},{"type":"logical","attributes":{},"value":[true]},{"type":"integer","attributes":{},"value":[3]},{"type":"logical","attributes":{},"value":[true]}]}]},{"type":"character","attributes":{},"value":["images/tidyr_wide.png"]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["data/pma_00021.dat.gz","data/pma_00021.xml","data/pma_00022.dat.gz","data/pma_00022.xml","images/tidyr_wide.png","images/tidyr.png","migration-discovery_files/anchor-4.2.2/anchor.min.js","migration-discovery_files/bowser-1.9.3/bowser.min.js","migration-discovery_files/distill-2.2.21/template.v2.js","migration-discovery_files/header-attrs-2.7/header-attrs.js","migration-discovery_files/jquery-1.11.3/jquery.min.js","migration-discovery_files/popper-2.6.0/popper.min.js","migration-discovery_files/tippy-6.2.7/tippy-bundle.umd.min.js","migration-discovery_files/tippy-6.2.7/tippy-light-border.css","migration-discovery_files/tippy-6.2.7/tippy.css","migration-discovery_files/tippy-6.2.7/tippy.umd.min.js","migration-discovery_files/webcomponents-2.0.0/webcomponents.js"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

  <style type="text/css">

  body {
    background-color: white;
  }

  .pandoc-table {
    width: 100%;
  }

  .pandoc-table>caption {
    margin-bottom: 10px;
  }

  .pandoc-table th:not([align]) {
    text-align: left;
  }

  .pagedtable-footer {
    font-size: 15px;
  }

  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }

  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }

  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }

  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }

  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }

  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
  }

  .html-widget {
    margin-bottom: 2.0em;
  }

  .l-screen-inset {
    padding-right: 16px;
  }

  .l-screen .caption {
    margin-left: 10px;
  }

  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .shaded-content {
    background: white;
  }

  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }

  .hidden {
    display: none !important;
  }

  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }

  d-appendix {
    padding-top: 30px;
  }

  d-article>p>img {
    width: 100%;
  }

  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }

  d-article h3 {
    margin-top: 1.5rem;
  }

  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }

  /* Tweak code blocks */

  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }

  d-article div.sourceCode {
    background-color: white;
  }

  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }

  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  d-article pre a {
    border-bottom: none;
  }

  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }

  @media(min-width: 768px) {

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }

  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }

  d-article pre {
    font-size: 14px;
  }

  }

  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  /* CSS for d-contents */

  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }

  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }

  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .d-contents li {
    list-style-type: none
  }

  .d-contents nav > ul {
    padding-left: 0;
  }

  .d-contents ul {
    padding-left: 1em
  }

  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }

  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }

  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }

  .d-contents nav > ul > li > a {
    font-weight: 600;
  }

  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }

  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }


  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }

  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }


  /* Figure */

  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }

  .figure img {
    width: 100%;
  }

  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }

  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }

  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }

  /* Citations */

  d-article .citation {
    color: inherit;
    cursor: inherit;
  }

  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }


  /* Tweak 1000px media break to show more text */

  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }

    .grid {
      grid-column-gap: 16px;
    }

    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }

  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }

    .grid {
      grid-column-gap: 32px;
    }
  }


  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */

  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Include appendix styles here so they can be overridden */

  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }

  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }

  d-appendix h3 + * {
    margin-top: 1em;
  }

  d-appendix ol {
    padding: 0 0 0 15px;
  }

  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }

  d-appendix li {
    margin-bottom: 1em;
  }

  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }

  d-appendix > * {
    grid-column: text;
  }

  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }

  /* Include footnote styles here so they can be overridden */

  d-footnote-list {
    contain: layout style;
  }

  d-footnote-list > * {
    grid-column: text;
  }

  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }



  /* Anchor.js */

  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }

  /* Social footer */

  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }

  .disqus-comments {
    margin-right: 30px;
  }

  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }

  #disqus_thread {
    margin-top: 30px;
  }

  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }

  .article-sharing a:hover {
    border-bottom: none;
  }

  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }

  .subscribe p {
    margin-bottom: 0.5em;
  }


  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }


  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }

  .custom p {
    margin-bottom: 0.5em;
  }

  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }

  /* Styles for posts lists (not auto-injected) */


  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }

  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }

  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }

  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }

  .post-preview-last {
    border-bottom: none !important;
  }

  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }

  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }

  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }

  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }

  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }

  .posts-list .metadata > * {
    display: inline-block;
  }

  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }

  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }

  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }

  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .posts-list img {
    opacity: 1;
  }

  .posts-list img[data-src] {
    opacity: 0;
  }

  .posts-more {
    clear: both;
  }


  .posts-sidebar {
    font-size: 16px;
  }

  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }

  .sidebar-section {
    margin-bottom: 30px;
  }

  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }

  .categories li>a {
    border-bottom: none;
  }

  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }

  .categories .active {
    font-weight: 600;
  }

  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }


  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }


  /* Improve display for browsers without grid (IE/Edge <= 15) */

  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }

  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }

  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }

  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }

  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }

  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }


  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }

  .downlevel .footnotes ol {
    padding-left: 13px;
  }

  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }

  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }

  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }

  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  .downlevel .posts-list .post-preview {
    color: inherit;
  }



  </style>

  <script type="application/javascript">

  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }

  // show body when load is complete
  function on_load_complete() {

    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }


    // set body to visible
    document.body.style.visibility = 'visible';

    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }

    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }

  function init_distill() {

    init_common();

    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);

    // create d-title
    $('.d-title').changeElementType('d-title');

    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);

    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();

    // move posts container into article
    $('.posts-container').appendTo($('d-article'));

    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');

    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;

    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();

    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));

    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });

    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');

    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {

      // capture layout
      var layout = $(this).attr('data-layout');

      // apply layout to markdown level block elements
      var elements = $(this).children().not('div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });


      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });

    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();

    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();

    // load distill framework
    load_distill_framework();

    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {

      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;

      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');

      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');

      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });

      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }

      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");

      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }

       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }

      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();

      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();

      // clear polling timer
      clearInterval(tid);

      // show body now that everything is ready
      on_load_complete();
    }

    var tid = setInterval(distill_post_process, 50);
    distill_post_process();

  }

  function init_downlevel() {

    init_common();

     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));

    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;

    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();

    // remove toc
    $('.d-contents').remove();

    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });


    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);

    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();

    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });

    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));

    $('body').addClass('downlevel');

    on_load_complete();
  }


  function init_common() {

    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};

        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });

        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);

    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});

    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });

      }
    });

    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });

    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }

    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');

    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");

    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();

    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });

  </script>

  <!--/radix_placeholder_distill-->
  <script src="migration-discovery_files/header-attrs-2.7/header-attrs.js"></script>
  <script src="migration-discovery_files/jquery-1.11.3/jquery.min.js"></script>
  <script src="migration-discovery_files/anchor-4.2.2/anchor.min.js"></script>
  <script src="migration-discovery_files/bowser-1.9.3/bowser.min.js"></script>
  <script src="migration-discovery_files/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="migration-discovery_files/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Formatting Migration Recall Data for Longitudinal Analysis","description":"Use tidyr::pivot_longer to reshape wide data into a long format.","authors":[{"author":"Matt Gunther","authorURL":"#","affiliation":"IPUMS PMA Senior Data Analyst","affiliationURL":"#","orcidID":""}],"publishedDate":"2021-04-15T00:00:00.000+00:00","citationText":"Gunther, 2021"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Formatting Migration Recall Data for Longitudinal Analysis</h1>
<!--radix_placeholder_categories-->
<div class="dt-tags">
<div class="dt=tag">Migration</div>
<div class="dt=tag">Data Discovery</div>
<div class="dt=tag">Data Manipulation</div>
<div class="dt=tag">pivot_longer</div>
<div class="dt=tag">regex</div>
</div>
<!--/radix_placeholder_categories-->
<p><p>Use tidyr::pivot_longer to reshape wide data into a long format.</p></p>
</div>

<div class="d-byline">
  Matt Gunther  (IPUMS PMA Senior Data Analyst)
  
<br/>04-15-2021
</div>

<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#data-availability">Data Availability</a></li>
<li><a href="#longitudinal-data-structures">Longitudinal Data Structures</a>
<ul>
<li><a href="#pivot-longer-into-one-column">Pivot Longer into One Column</a></li>
<li><a href="#pivot-longer-into-multiple-columns">Pivot Longer into Multiple Columns</a></li>
</ul></li>
</ul>
</nav>
</div>
<p>Most of the data you’ll find at <a href="https://pma.ipums.org/pma/index.shtml">IPUMS PMA</a> comes from cross-sectional surveys, where each respondent is interviewed only once. However, there are some items on the Female Questionnaire that ask respondents to recall past events. When these <strong>recall data</strong> are linked to a measure of time, the data can be restructured to simulate <strong>longitudinal data</strong> – or repeated observations on individuals over time. Once the data are in this structure, we can use a range of analytic tools to determine how the frequency or duration of past experiences explains current outcomes.</p>
<aside>
Currently, only the 2016 Ethiopia <a href="https://pma.ipums.org/pma-action/variables/group?unit_of_analysis=mnh">Maternal and Newborn Health</a> survey contains data from follow-up interviews. <a href="https://www.pmadata.org/data/survey-methodology">Panel data</a> related to contraceptive use is coming soon!
</aside>
<p>One place where you’ll find this type of data is on the <a href="https://pma.ipums.org/pma-action/variables/group?id=fem_mig">migration variables page</a>. In our <a href="../2021-04-01-et-internal-migration/index.html">last post</a>, we saw that PMA samples from Ethiopia began including information about each respondent’s <strong>single most most recent migration experience</strong> beginning with the 2016 sample. More recently, a number of samples from other countries have collected data about each respondent’s <strong>complete migration history</strong>, organized in chronological order. These samples include:</p>
<ul>
<li>Burkina Faso 2020</li>
<li>Congo (DR), Kinshasa 2019</li>
<li>Congo (DR), Kongo Central 2019</li>
<li>Kenya 2019</li>
<li>Nigeria, Kano 2019</li>
<li>Nigeria, Lagos 2019</li>
</ul>
<p>In this post, we’ll take a look at the available information in the migration data collected from these newer samples. As we’ll see, female respondents who indicate that they have migrated at least once receive the same set of questions <em>for each place they have lived</em>, resulting in a dataset that is exceptionally <strong>wide</strong> and cumbersome to use in most time-dependent applications. We’ll show how to reshape an example data extract into a much friendlier <strong>long</strong> format using the function <a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">tidyr::pivot_longer</a>.</p>
<h1 id="data-availability">Data Availability</h1>
<p>The samples listed above contain data from nearly identical survey questions. In the interview, a respondent is first asked <a href="https://pma.ipums.org/pma-action/variables/LIVEINPLACE">how long they have lived in their current place of residence</a>; if they indicate that they have not “always” lived in the same place, they are then asked <a href="https://pma.ipums.org/pma-action/variables/PLACELIVENUM">how many places</a> they’ve lived <em>for more than six months after age 15 or their first marriage (whichever happened first)</em>.</p>
<aside>
Interviewers were instructed to define a <strong>place</strong> as “a community, village, or neighborhood”.
</aside>
<p>Respondents who list at least one such place are then asked to recall information about each place, starting with the place before their current residence. Information about the most recent place is represented by variables beginning with the prefix <code>PLACE1</code>. Information about the second most recent place is represented by the prefix <code>PLACE2</code>, and so forth.</p>
<p>In each of these samples, the same questions are repeated for each place until all of the respondent’s previous places of residence are fully enumerated. The available information about each place includes:</p>
<ul>
<li>its country</li>
<li>its district or region</li>
<li>the respondent’s age when she moved to the place</li>
<li>whether the place was a city, a town, peri-urban, or rural (not available for Nigeria samples)</li>
</ul>
<p>Additionally, the respondent could list multiple reasons for migrating <em>to</em> each place (note that this information is not available for the respondent’s migration to their <em>current</em> place of residence). Options include:</p>
<ul>
<li>looking for a job</li>
<li>seasonal work</li>
<li>work (non-seasonal)</li>
<li>want to change jobs</li>
<li>family or village conflict</li>
<li>to attend school</li>
<li>move after completed school</li>
<li>join spouse after marriage</li>
<li>co-reside with boy/girlfriend</li>
<li>divorce/widowhood</li>
<li>hospitalization/health problem</li>
<li>better access to health service</li>
<li>caring for sick relative</li>
<li>followed spouse to job</li>
<li>better land for farming</li>
<li>better education for children</li>
<li>other social reasons</li>
<li>other</li>
</ul>
<p>Because the respondent can choose multiple reasons, we’ll find one binary indicator for each of these 18 reasons. <strong>As you might imagine, this results in a very wide dataset!</strong> Some respondents move as many as 11 times, resulting in 198 columns from just this one repeated multiple-response question.</p>
<p>The wide shape of these data is more than an inconvenience: most longitudinal analysis applications require easy access to the <strong>time interval</strong> between events. In their current format, each numbered <code>PLACE</code> variable represents a single migration event, but it’s difficult to tell how much time passed between any two migrations for a given person. To make this kind of analysis possible, we need to <strong>pivot</strong> the migration variables into a <strong>long</strong> format accompanied by a new variable showing the time interval between each migration.</p>
<h1 id="longitudinal-data-structures">Longitudinal Data Structures</h1>
<p>Let’s take a look at the way migration history variables are currently formatted for one of the samples we discussed above. For this example, we’ve <a href="../2020-12-10-get-ipums-pma-data/index.html">created a data extract</a> containing all of the available migration data for the Kenya 2019 sample (female respondents only). We’ll load it and the following packages into R:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://tidyverse.tidyverse.org'>tidyverse</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://www.ipums.org'>ipumsr</a></span><span class='op'>)</span>

<span class='va'>dat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/ipumsr/man/read_ipums_micro.html'>read_ipums_micro</a></span><span class='op'>(</span>
  ddi <span class='op'>=</span> <span class='st'>"data/pma_00022.xml"</span>,
  data <span class='op'>=</span> <span class='st'>"data/pma_00022.dat.gz"</span>
<span class='op'>)</span>
</code></pre>
</div>
</div>
<aside>
Remember: change these file paths to match the download location for your own data extract!
</aside>
<div class="layout-chunk" data-layout="l-body">

</div>
<p>Like all IPUMS PMA data extracts, this dataset reflects a <strong>cross-sectional survey design</strong> where every response from each person is stored in a <em>single row</em>. If you’re familiar with <strong>longitudinal data</strong> structures, you know that repeated observations from the same respondents are stored in <em>separate rows</em>, where each row represents a different moment in time. Why might this be the case?</p>
<p>As we’ll see in our own data, the <em>values</em> for repeated observations and the amount of <em>time</em> that passes between observations are related only by a common pattern in the names for each variable when they’re stored together in a <strong>wide format</strong>. In our case, the only mark of time between migrations is the respondent’s age. Consider the following respondents, who have each migrated at least twice:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>dat</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>PLACELIVENUM</span> <span class='op'>%in%</span> <span class='fl'>2</span><span class='op'>:</span><span class='fl'>7</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>select</span><span class='op'>(</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>ends_with</a></span><span class='op'>(</span><span class='st'>"DISTRICTKE"</span><span class='op'>)</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>ends_with</a></span><span class='op'>(</span><span class='st'>"MOVEAGE"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>relocate</span><span class='op'>(</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>"PLACE1"</span><span class='op'>)</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>"PLACE2"</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 1,206 x 14
  PLACE1DISTRICTKE PLACE1MOVEAGE PLACE2DISTRICTKE PLACE2MOVEAGE
         &lt;int+lbl&gt;     &lt;int+lbl&gt;        &lt;int+lbl&gt;     &lt;int+lbl&gt;
1  7 [Nandi]                  29    32 [Migori]              19
2  8 [Nyamira]                19     8 [Nyamira]             21
3  6 [Nairobi]                34     3 [Kiambu]              28
4  6 [Nairobi]                25    35 [Nakuru]               0
5 43 [Trans-Nzoia]            15    28 [Machakos]             0
# … with 1,201 more rows, and 10 more variables:
#   PLACE3DISTRICTKE &lt;int+lbl&gt;, PLACE4DISTRICTKE &lt;int+lbl&gt;,
#   PLACE5DISTRICTKE &lt;int+lbl&gt;, PLACE6DISTRICTKE &lt;int+lbl&gt;,
#   PLACE7DISTRICTKE &lt;int+lbl&gt;, PLACE3MOVEAGE &lt;int+lbl&gt;,
#   PLACE4MOVEAGE &lt;int+lbl&gt;, PLACE5MOVEAGE &lt;int+lbl&gt;,
#   PLACE6MOVEAGE &lt;int+lbl&gt;, PLACE7MOVEAGE &lt;int+lbl&gt;</code></pre>
</div>
<p><code>PLACE1DISTRICTKE</code> shows the administrative district of the last place a respondent lived before their current place of residence, and <code>PLACE1MOVEAGE</code> shows her age when she moved there. <code>PLACE2DISTRICTKE</code> shows the district of the second most recent place she lived, and <code>PLACE2MOVEAGE</code> shows her age when she moved there. The same pattern would be repeated for all of the places a person might have lived (in this sample, some respondents migrated as many as 7 times).</p>
<aside>
You might notice that the respondent in the second row recalls her prior places of residence in reverse chronological order. This particular type of recall error is also easier to fix when we <code>pivot_longer</code>.
</aside>
<p>Suppose you wanted to know something very simple about the relationship between these variables, such as the average age of female migrants arriving at each district in the sample. In this <strong>wide format</strong>, you would first have to find the mean <code>PLACE1MOVEAGE</code> for every district in <code>PLACE1DISTRICTKE</code>, then the mean <code>PLACE2MOVEAGE</code> for every district in <code>PLACE2DISTRICTKE</code>, and so forth for all 7 places. Then, you’d need to find the frequency weighted mean for each district in all 7 places. That’s quite a bit of extra work for just one simple statistic!</p>
<p>Imagine you wanted to model the effect of a time-dependent variable on an outcome of interest. For example, you might suppose that the number of times a female respondent gives birth could be related to the length of time she’s lived in a district where there are relatively few family planning services available. As you can see, we’d have a hard time building an appropriate model because the relevant data are currently strewn across 14 different variables. Instead, we’d much prefer two work with the data in a <strong>long format</strong> with only two variables: one representing <code>DISTRICTKE</code> and one representing <code>MOVEAGE</code>.</p>
<h2 id="pivot-longer-into-one-column">Pivot Longer into One Column</h2>
<p>For the moment, let’s continue working <em>just</em> with the district for each place in an individual’s migration history. To keep things simple, we’ll create a dataset called <code>district</code> containing only the variables ending with the string <code>DISTRICTKE</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>district</span> <span class='op'>&lt;-</span> <span class='va'>dat</span> <span class='op'>%&gt;%</span> <span class='fu'>select</span><span class='op'>(</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>ends_with</a></span><span class='op'>(</span><span class='st'>"DISTRICTKE"</span><span class='op'>)</span><span class='op'>)</span> 

<span class='va'>district</span>
</code></pre>
</div>
<pre><code># A tibble: 9,549 x 7
   PLACE1DISTRICTKE PLACE2DISTRICTKE PLACE3DISTRICTKE PLACE4DISTRICTKE
          &lt;int+lbl&gt;        &lt;int+lbl&gt;        &lt;int+lbl&gt;        &lt;int+lbl&gt;
1 99 [NIU (not in … 99 [NIU (not in… 99 [NIU (not in… 99 [NIU (not in…
2  6 [Nairobi]      99 [NIU (not in… 99 [NIU (not in… 99 [NIU (not in…
3 99 [NIU (not in … 99 [NIU (not in… 99 [NIU (not in… 99 [NIU (not in…
4 99 [NIU (not in … 99 [NIU (not in… 99 [NIU (not in… 99 [NIU (not in…
5 99 [NIU (not in … 99 [NIU (not in… 99 [NIU (not in… 99 [NIU (not in…
# … with 9,544 more rows, and 3 more variables:
#   PLACE5DISTRICTKE &lt;int+lbl&gt;, PLACE6DISTRICTKE &lt;int+lbl&gt;,
#   PLACE7DISTRICTKE &lt;int+lbl&gt;</code></pre>
</div>
<p>As you can see, a lot of the information contained in <code>district</code> isn’t really necessary. Every row holds information on 7 places of residence, but most respondents migrated only to 1 or 2 places if they ever migrated at all. The best approach here is to tell R that labels like <code>NIU (not in universe)</code> and <code>No response or missing</code> each represent a type of missing data that we can recode as <code>NA</code>. We can do that with help from <code>ipumsr::lbl_na_if</code> and <code>dplyr::across</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>district</span> <span class='op'>&lt;-</span> <span class='va'>district</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>mutate</span><span class='op'>(</span><span class='fu'>across</span><span class='op'>(</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/everything.html'>everything</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='op'>~</span><span class='op'>{</span>
    <span class='fu'><a href='https://rdrr.io/pkg/ipumsr/man/lbl_na_if.html'>lbl_na_if</a></span><span class='op'>(</span><span class='va'>.x</span>, <span class='op'>~</span><span class='va'>.lbl</span> <span class='op'>%in%</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>
      <span class='st'>"No response or missing"</span>,
      <span class='st'>"NIU (not in universe)"</span>
    <span class='op'>)</span><span class='op'>)</span>
  <span class='op'>}</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>district</span>
</code></pre>
</div>
<pre><code># A tibble: 9,549 x 7
  PLACE1DISTRICTKE PLACE2DISTRICTKE PLACE3DISTRICTKE PLACE4DISTRICTKE
         &lt;int+lbl&gt;        &lt;int+lbl&gt;        &lt;int+lbl&gt;        &lt;int+lbl&gt;
1     NA                         NA               NA               NA
2      6 [Nairobi]               NA               NA               NA
3     NA                         NA               NA               NA
4     NA                         NA               NA               NA
5     NA                         NA               NA               NA
# … with 9,544 more rows, and 3 more variables:
#   PLACE5DISTRICTKE &lt;int+lbl&gt;, PLACE6DISTRICTKE &lt;int+lbl&gt;,
#   PLACE7DISTRICTKE &lt;int+lbl&gt;</code></pre>
</div>
<aside>
See <a href="../2021-01-28-across-sdp/index.html">this post</a> for additional details on recoding variables with <code>ipumsr</code> and <code>dplyr::across</code>.
</aside>
<p>In order to keep track of individuals, let’s also add a column <code>ID</code> that represents a short identification number for each person:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>district</span> <span class='op'>&lt;-</span> <span class='va'>district</span> <span class='op'>%&gt;%</span> <span class='fu'>rowid_to_column</span><span class='op'>(</span><span class='st'>"ID"</span><span class='op'>)</span>
<span class='va'>district</span>
</code></pre>
</div>
<pre><code># A tibble: 9,549 x 8
     ID PLACE1DISTRICTKE PLACE2DISTRICTKE PLACE3DISTRICTKE
  &lt;int&gt;        &lt;int+lbl&gt;        &lt;int+lbl&gt;        &lt;int+lbl&gt;
1     1     NA                         NA               NA
2     2      6 [Nairobi]               NA               NA
3     3     NA                         NA               NA
4     4     NA                         NA               NA
5     5     NA                         NA               NA
# … with 9,544 more rows, and 4 more variables:
#   PLACE4DISTRICTKE &lt;int+lbl&gt;, PLACE5DISTRICTKE &lt;int+lbl&gt;,
#   PLACE6DISTRICTKE &lt;int+lbl&gt;, PLACE7DISTRICTKE &lt;int+lbl&gt;</code></pre>
</div>
<p>Now, we’re ready to use the function <code>tidyr::pivot_longer</code> to reshape <code>district</code>. The simplest way to use this function is to specify a group of columns with the argument <code>cols</code>:</p>
<div class="layout-chunk" data-layout="l-body">

</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>district</span> <span class='op'>%&gt;%</span> <span class='fu'>pivot_longer</span><span class='op'>(</span>cols <span class='op'>=</span> <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>ends_with</a></span><span class='op'>(</span><span class='st'>"DISTRICTKE"</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 66,843 x 3
      ID name                    value
   &lt;int&gt; &lt;chr&gt;               &lt;int+lbl&gt;
 1     1 PLACE1DISTRICTKE NA          
 2     1 PLACE2DISTRICTKE NA          
 3     1 PLACE3DISTRICTKE NA          
 4     1 PLACE4DISTRICTKE NA          
 5     1 PLACE5DISTRICTKE NA          
 6     1 PLACE6DISTRICTKE NA          
 7     1 PLACE7DISTRICTKE NA          
 8     2 PLACE1DISTRICTKE  6 [Nairobi]
 9     2 PLACE2DISTRICTKE NA          
10     2 PLACE3DISTRICTKE NA          
# … with 66,833 more rows</code></pre>
</div>
<aside>
<div class="layout-chunk" data-layout="l-body">
<p><img src="images/tidyr.png" width="368" /></p>
</div>
<p>© 2018 RStudio (<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0 1.0</a>)</p>
<a href="https://tidyr.tidyverse.org/index.html">tidyr</a> is included with <code>library(tidyverse)</code>.
</aside>
<p>By default, the name of each column moves into a single column called <code>name</code>, and the value of each column moves into an adjascent column called <code>value</code>. We can manually change the names of these columns with the arguments <code>names_to</code> and <code>values_to</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>district</span> <span class='op'>%&gt;%</span> <span class='fu'>pivot_longer</span><span class='op'>(</span>
  cols <span class='op'>=</span> <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>ends_with</a></span><span class='op'>(</span><span class='st'>"DISTRICTKE"</span><span class='op'>)</span>,
  names_to <span class='op'>=</span> <span class='st'>"PLACE"</span>,
  values_to <span class='op'>=</span> <span class='st'>"DISTRICTKE"</span>
<span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 66,843 x 3
      ID PLACE              DISTRICTKE
   &lt;int&gt; &lt;chr&gt;               &lt;int+lbl&gt;
 1     1 PLACE1DISTRICTKE NA          
 2     1 PLACE2DISTRICTKE NA          
 3     1 PLACE3DISTRICTKE NA          
 4     1 PLACE4DISTRICTKE NA          
 5     1 PLACE5DISTRICTKE NA          
 6     1 PLACE6DISTRICTKE NA          
 7     1 PLACE7DISTRICTKE NA          
 8     2 PLACE1DISTRICTKE  6 [Nairobi]
 9     2 PLACE2DISTRICTKE NA          
10     2 PLACE3DISTRICTKE NA          
# … with 66,833 more rows</code></pre>
</div>
<p>Even more conveniently, we can generate these columns automatically if we identify a pattern in the original column names. This approach efficiently handles both the names of the new columns <em>and</em> the values stored in each column. Notice that we’ve manually specified the name of the column <code>DISTRICTKE</code> above; this is fine if we’re only pivoting one column, but we want to avoid manually writing a name for each new column when we start working with several variables at once. Also, notice the values that appear in the <code>PLACE</code> column; wouldn’t it be more convenient to extract the index number for each place, rather than the full names of the original columns?</p>
<p>We’ll use the additional argument <code>names_pattern</code> to solve both problems at once. Any string enclosed with parentheses <code>()</code> in <code>names_pattern</code> can be passed, in sequential order, to <code>names_to</code>. In this example, we specify a pattern where the string <code>PLACE</code> will be followed by a single-digit number <code>([0-9])</code> followed by the string <code>(DISTRICTKE)</code>. The argument <code>names_to</code> places the single-digit number in a column called <code>PLACE</code>, and it places the string <code>DISTRICTKE</code> in a column that uses a pronoun <code>.value</code> to represent the contents of the string.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>district</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>pivot_longer</span><span class='op'>(</span>
    cols <span class='op'>=</span> <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>ends_with</a></span><span class='op'>(</span><span class='st'>"DISTRICTKE"</span><span class='op'>)</span>, 
    names_pattern <span class='op'>=</span> <span class='st'>"PLACE([0-9])(DISTRICTKE)"</span>,
    names_to <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"PLACE"</span>, <span class='st'>".value"</span><span class='op'>)</span>
  <span class='op'>)</span> 
</code></pre>
</div>
<pre><code># A tibble: 66,843 x 3
      ID PLACE   DISTRICTKE
   &lt;int&gt; &lt;chr&gt;    &lt;int+lbl&gt;
 1     1 1     NA          
 2     1 2     NA          
 3     1 3     NA          
 4     1 4     NA          
 5     1 5     NA          
 6     1 6     NA          
 7     1 7     NA          
 8     2 1      6 [Nairobi]
 9     2 2     NA          
10     2 3     NA          
# … with 66,833 more rows</code></pre>
</div>
<p>We can improve the scalability of this code just a little bit more by adding the wildcard <code>.</code> in <code>names_pattern</code> to represent “any character” and the operator <code>*</code> to represent “any number of times”. This allows us to write <code>([0-9]*)</code> to find an integer of any length (in case some respondents move 10 places or more), and <code>(.*)</code> to find a string of any length afterward (this saves us the trouble of writing “DISTRICTKE”).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>district</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>pivot_longer</span><span class='op'>(</span>
    cols <span class='op'>=</span> <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>ends_with</a></span><span class='op'>(</span><span class='st'>"DISTRICTKE"</span><span class='op'>)</span>, 
    names_pattern <span class='op'>=</span> <span class='st'>"PLACE([0-9]*)(.*)"</span>,
    names_to <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"PLACE"</span>, <span class='st'>".value"</span><span class='op'>)</span>
  <span class='op'>)</span> 
</code></pre>
</div>
<pre><code># A tibble: 66,843 x 3
      ID PLACE   DISTRICTKE
   &lt;int&gt; &lt;chr&gt;    &lt;int+lbl&gt;
 1     1 1     NA          
 2     1 2     NA          
 3     1 3     NA          
 4     1 4     NA          
 5     1 5     NA          
 6     1 6     NA          
 7     1 7     NA          
 8     2 1      6 [Nairobi]
 9     2 2     NA          
10     2 3     NA          
# … with 66,833 more rows</code></pre>
</div>
<p>Notice that there are now 66,843 rows in <code>district</code>: that’s 7 rows for 7 places per respondent. Adding the argument <code>values_drop_NA = TRUE</code> drops placeholder values for respondents who lived in fewer than 7 places:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>district</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>pivot_longer</span><span class='op'>(</span>
    cols <span class='op'>=</span> <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>ends_with</a></span><span class='op'>(</span><span class='st'>"DISTRICTKE"</span><span class='op'>)</span>, 
    names_pattern <span class='op'>=</span> <span class='st'>"PLACE([0-9]*)(.*)"</span>,
    names_to <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"PLACE"</span>, <span class='st'>".value"</span><span class='op'>)</span>,
    values_drop_na <span class='op'>=</span> <span class='cn'>TRUE</span>
  <span class='op'>)</span> 
</code></pre>
</div>
<pre><code># A tibble: 5,165 x 3
      ID PLACE    DISTRICTKE
   &lt;int&gt; &lt;chr&gt;     &lt;int+lbl&gt;
 1     2 1      6 [Nairobi] 
 2    11 1     10 [Kakamega]
 3    12 1     10 [Kakamega]
 4    14 1      7 [Nandi]   
 5    14 2     32 [Migori]  
 6    16 1      6 [Nairobi] 
 7    19 1     33 [Mombasa] 
 8    20 1      8 [Nyamira] 
 9    20 2      8 [Nyamira] 
10    21 1      6 [Nairobi] 
# … with 5,155 more rows</code></pre>
</div>
<p>This step causes any respondent who has <em>never</em> migrated from a place they lived for 6 months or more after age 15 / first marriage to be <em>filtered out</em> of the data. Here, we see the first 10 rows from all of the remaining female respondents. Individuals 14 and 20 lived in two such places: individual 14 first lived in the district Migori, then moved to Nandi, and finally moved to her current residence (not shown). Individual 20 first lived in Nyamira, then moved to another place also in Nyamira, and finally moved to her current residence (not shown). All of the other displayed respondents lived in exactly one such place. Next, we’ll add the <strong>age</strong> at which each of the women moved to each location.</p>
<aside>
Remember: these migration history variables contain information about each place a person has lived <em>prior to their current residence</em>. You’ll find information on the woman’s current district of residence in either <a href="https://pma.ipums.org/pma-action/variables/GEOKE">GEOKE</a> (for Kenya samples) or <a href="https://pma.ipums.org/pma-action/variables/SUBNATIONAL">SUBNATIONAL</a> (for all samples, including Kenya).
</aside>
<h2 id="pivot-longer-into-multiple-columns">Pivot Longer into Multiple Columns</h2>
<p>Now that we know how to use wildcard operators in <code>pivot_longer</code>, we’ll be able to start pivoting multiple columns at once. Let’s start by adding the respondent’s age when they moved to each place. Using the same processing steps we used to make <code>district</code>, we’ll create a new dataset called <code>age</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>age</span> <span class='op'>&lt;-</span> <span class='va'>dat</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>select</span><span class='op'>(</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>ends_with</a></span><span class='op'>(</span><span class='st'>"DISTRICTKE"</span><span class='op'>)</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>ends_with</a></span><span class='op'>(</span><span class='st'>"MOVEAGE"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>mutate</span><span class='op'>(</span><span class='fu'>across</span><span class='op'>(</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/everything.html'>everything</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='op'>~</span><span class='op'>{</span>
    <span class='fu'><a href='https://rdrr.io/pkg/ipumsr/man/lbl_na_if.html'>lbl_na_if</a></span><span class='op'>(</span><span class='va'>.x</span>, <span class='op'>~</span><span class='va'>.lbl</span> <span class='op'>%in%</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>
      <span class='st'>"No response or missing"</span>,
      <span class='st'>"NIU (not in universe)"</span>
    <span class='op'>)</span><span class='op'>)</span>
  <span class='op'>}</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>rowid_to_column</span><span class='op'>(</span><span class='st'>"ID"</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>age</span> <span class='op'>%&gt;%</span> <span class='fu'>relocate</span><span class='op'>(</span><span class='va'>ID</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>"PLACE1"</span><span class='op'>)</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>"PLACE2"</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 9,549 x 15
      ID PLACE1DISTRICTKE PLACE1MOVEAGE PLACE2DISTRICTKE PLACE2MOVEAGE
   &lt;int&gt;        &lt;int+lbl&gt;     &lt;int+lbl&gt;        &lt;int+lbl&gt;     &lt;int+lbl&gt;
 1     1     NA                      NA               NA            NA
 2     2      6 [Nairobi]            16               NA            NA
 3     3     NA                      NA               NA            NA
 4     4     NA                      NA               NA            NA
 5     5     NA                      NA               NA            NA
 6     6     NA                      NA               NA            NA
 7     7     NA                      NA               NA            NA
 8     8     NA                      NA               NA            NA
 9     9     NA                      NA               NA            NA
10    10     NA                      NA               NA            NA
# … with 9,539 more rows, and 10 more variables:
#   PLACE3DISTRICTKE &lt;int+lbl&gt;, PLACE4DISTRICTKE &lt;int+lbl&gt;,
#   PLACE5DISTRICTKE &lt;int+lbl&gt;, PLACE6DISTRICTKE &lt;int+lbl&gt;,
#   PLACE7DISTRICTKE &lt;int+lbl&gt;, PLACE3MOVEAGE &lt;int+lbl&gt;,
#   PLACE4MOVEAGE &lt;int+lbl&gt;, PLACE5MOVEAGE &lt;int+lbl&gt;,
#   PLACE6MOVEAGE &lt;int+lbl&gt;, PLACE7MOVEAGE &lt;int+lbl&gt;</code></pre>
</div>
<aside>
We’re using <code>relocate</code> here just so that we can display the <code>DISTRICTKE</code> and <code>MOVEAGE</code> variables side-by-side. It doesn’t change anything else about the structure of the data!
</aside>
<p>Because we’re using the wildcard pattern <code>(.*)</code>, the function will treat the string <code>MOVEEAGE</code> the same way it treats <code>DISTRICTKE</code>. We only need to add the new columns to <code>cols</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>age</span> <span class='op'>&lt;-</span> <span class='va'>age</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>pivot_longer</span><span class='op'>(</span>
    cols <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>ends_with</a></span><span class='op'>(</span><span class='st'>"DISTRICTKE"</span><span class='op'>)</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>ends_with</a></span><span class='op'>(</span><span class='st'>"MOVEAGE"</span><span class='op'>)</span><span class='op'>)</span>, 
    names_pattern <span class='op'>=</span> <span class='st'>"PLACE([0-9]*)(.*)"</span>,
    names_to <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"PLACE"</span>, <span class='st'>".value"</span><span class='op'>)</span>,
    values_drop_na <span class='op'>=</span> <span class='cn'>TRUE</span>
  <span class='op'>)</span> 

<span class='va'>age</span>
</code></pre>
</div>
<pre><code># A tibble: 5,246 x 4
      ID PLACE    DISTRICTKE   MOVEAGE
   &lt;int&gt; &lt;chr&gt;     &lt;int+lbl&gt; &lt;int+lbl&gt;
 1     2 1      6 [Nairobi]         16
 2    11 1     10 [Kakamega]        17
 3    12 1     10 [Kakamega]        16
 4    14 1      7 [Nandi]           29
 5    14 2     32 [Migori]          19
 6    16 1      6 [Nairobi]         21
 7    19 1     33 [Mombasa]         31
 8    20 1      8 [Nyamira]         19
 9    20 2      8 [Nyamira]         21
10    21 1      6 [Nairobi]         34
# … with 5,236 more rows</code></pre>
</div>
<p><strong>The advantages we’ve gained with a longer data format are starting to become clear!</strong> Suppose you wanted to know the average age of migrants arriving at each of Kenya’s administrative districts in this sample. You could find this information easily with just one <code>summarise</code> function:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>age</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>DISTRICTKE</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>summarise</span><span class='op'>(</span>MEAN_AGE <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>MOVEAGE</span>, na.rm <span class='op'>=</span> <span class='cn'>T</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 48 x 2
      DISTRICTKE MEAN_AGE
 *     &lt;int+lbl&gt;    &lt;dbl&gt;
 1  1 [Bungoma]      18.5
 2  2 [Kericho]      18.0
 3  3 [Kiambu]       20.7
 4  4 [Kilifi]       17.1
 5  5 [Kitui]        19.3
 6  6 [Nairobi]      20.0
 7  7 [Nandi]        18.4
 8  8 [Nyamira]      17.9
 9  9 [Siaya]        16.1
10 10 [Kakamega]     17.1
# … with 38 more rows</code></pre>
</div>
<p>Let’s now pivot all of the migration history columns in our original dataset <code>dat</code>. This time, we’ll specify that all of the desired <code>cols</code> start with the same prefix <code>PLACE</code> (but we’ll drop the column <code>PLACELIVENUM</code>, since it contains the string “PLACE” we’re using in <code>names_pattern</code>):</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>dat</span> <span class='op'>&lt;-</span> <span class='va'>dat</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>mutate</span><span class='op'>(</span><span class='fu'>across</span><span class='op'>(</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/everything.html'>everything</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='op'>~</span><span class='op'>{</span>
    <span class='fu'><a href='https://rdrr.io/pkg/ipumsr/man/lbl_na_if.html'>lbl_na_if</a></span><span class='op'>(</span><span class='va'>.x</span>, <span class='op'>~</span><span class='va'>.lbl</span> <span class='op'>%in%</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>
      <span class='st'>"No response or missing"</span>,
      <span class='st'>"NIU (not in universe)"</span>
    <span class='op'>)</span><span class='op'>)</span>
  <span class='op'>}</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>rowid_to_column</span><span class='op'>(</span><span class='st'>"ID"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>ID</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>"PLACE"</span><span class='op'>)</span>, <span class='op'>-</span><span class='va'>PLACELIVENUM</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>pivot_longer</span><span class='op'>(</span>
    cols <span class='op'>=</span> <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>"PLACE"</span><span class='op'>)</span>, 
    names_pattern <span class='op'>=</span> <span class='st'>"PLACE([0-9]*)(.*)"</span>,
    names_to <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"PLACE"</span>, <span class='st'>".value"</span><span class='op'>)</span>,
    values_drop_na <span class='op'>=</span> <span class='cn'>TRUE</span>
  <span class='op'>)</span>

<span class='va'>dat</span>
</code></pre>
</div>
<pre><code># A tibble: 5,251 x 24
      ID PLACE COUNTRY  DISTRICTKE MOVEAGE       UR YCHILDEDU YCOHABIT
   &lt;int&gt; &lt;chr&gt;   &lt;int&gt;   &lt;int+lbl&gt; &lt;int+l&gt; &lt;int+lb&gt; &lt;int+lbl&gt; &lt;int+lb&gt;
 1     2 1         404  6 [Nairob…      16 30 [Rur…    0 [No]   0 [No]
 2    11 1         404 10 [Kakame…      17 30 [Rur…    0 [No]   0 [No]
 3    12 1         404 10 [Kakame…      16 10 [Cit…    0 [No]   0 [No]
 4    14 1         404  7 [Nandi]       29 30 [Rur…    0 [No]   0 [No]
 5    14 2         404 32 [Migori]      19 10 [Cit…    0 [No]   0 [No]
 6    16 1         404  6 [Nairob…      21 30 [Rur…    0 [No]   0 [No]
 7    19 1         404 33 [Mombas…      31 20 [Per…    0 [No]   0 [No]
 8    20 1         404  8 [Nyamir…      19 10 [Cit…    0 [No]   0 [No]
 9    20 2         404  8 [Nyamir…      21 20 [Per…    0 [No]   0 [No]
10    21 1         404  6 [Nairob…      34 20 [Per…    0 [No]   0 [No]
# … with 5,241 more rows, and 16 more variables: YCONFLICT &lt;int+lbl&gt;,
#   YDIVORCE &lt;int+lbl&gt;, YFARM &lt;int+lbl&gt;, YHLTHACCESS &lt;int+lbl&gt;,
#   YHLTHPROB &lt;int+lbl&gt;, YJOBSEARCH &lt;int+lbl&gt;, YOTHER &lt;int+lbl&gt;,
#   YOTHERSOCIAL &lt;int+lbl&gt;, YPOSTMAR &lt;int+lbl&gt;,
#   YSCHOOLATTEND &lt;int+lbl&gt;, …</code></pre>
</div>
<p>We’re left with a very manageable 24 migration history variables. Among these, all of the variables starting with <code>Y</code> indicate a possible reason “why” a respondent migrated to a particular <code>PLACE</code>. The simplest way to work with these <code>Y</code> variables is to use <a href="https://dplyr.tidyverse.org/reference/dplyr_tidy_select.html">tidy selection</a> functions, like <code>starts_with("Y")</code>. For example, suppose you wanted to know the percentage of all migrations in the sample that happened for all of the available reasons:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>dat</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>summarise</span><span class='op'>(</span><span class='fu'>across</span><span class='op'>(</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>"Y"</span><span class='op'>)</span>, <span class='op'>~</span><span class='fl'>100</span><span class='op'>*</span><span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>glimpse</span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Rows: 1
Columns: 18
$ YCHILDEDU     &lt;dbl&gt; 1.980575
$ YCOHABIT      &lt;dbl&gt; 2.418587
$ YCONFLICT     &lt;dbl&gt; 8.931632
$ YDIVORCE      &lt;dbl&gt; 0.8188916
$ YFARM         &lt;dbl&gt; 4.05637
$ YHLTHACCESS   &lt;dbl&gt; 1.866311
$ YHLTHPROB     &lt;dbl&gt; 0.9331556
$ YJOBSEARCH    &lt;dbl&gt; 16.85393
$ YOTHER        &lt;dbl&gt; 9.502952
$ YOTHERSOCIAL  &lt;dbl&gt; 12.53095
$ YPOSTMAR      &lt;dbl&gt; 24.01447
$ YSCHOOLATTEND &lt;dbl&gt; 22.73853
$ YSCHOOLDONE   &lt;dbl&gt; 4.361074
$ YSICKREL      &lt;dbl&gt; 1.371167
$ YSPOUSEJOB    &lt;dbl&gt; 2.704247
$ YWKCHANGE     &lt;dbl&gt; 1.885355
$ YWKNONSEAS    &lt;dbl&gt; 3.77071
$ YWKSEASON     &lt;dbl&gt; 6.189297</code></pre>
</div>
<p>Now that we’ve reshaped our migration recall data from a <strong>wide format</strong> to a <strong>long format</strong>, obtaining this summary data is a snap. And, as we’ll see in an upcoming migration <a href="../../index.html#category:Data_Analysis">Data Analysis</a> post, using these data in longitudinal analysis can be just as easy.</p>
<!-- Unless we're *definitely* doing an event history analysis, I think we should leave this more vague and just we'll show how to analyze these data in an upcoming post?

I also think here at the end might be a good place to plug that this code can be useful for reshaping any wide format recall data - which is common in surveys like PMA, DHS, etc..
-->
<div class="sourceCode" id="cb15"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
