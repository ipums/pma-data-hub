<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #20794d; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007ba5; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #007ba5; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #007ba5; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #20794d; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>

  <!--radix_placeholder_meta_tags-->
  <title>Merging external spatial data</title>

  <meta property="description" itemprop="description" content="How to integrate external spatial data with PMA data."/>


  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2021-02-15"/>
  <meta property="article:created" itemprop="dateCreated" content="2021-02-15"/>
  <meta name="article:author" content="Nina Brooks"/>

  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Merging external spatial data"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="How to integrate external spatial data with PMA data."/>
  <meta property="og:locale" content="en_US"/>

  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Merging external spatial data"/>
  <meta property="twitter:description" content="How to integrate external spatial data with PMA data."/>

  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","categories","date","output","preview"]}},"value":[{"type":"character","attributes":{},"value":["Merging external spatial data"]},{"type":"character","attributes":{},"value":["How to integrate external spatial data with PMA data.\n"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","affiliation","url"]}},"value":[{"type":"character","attributes":{},"value":["Nina Brooks"]},{"type":"character","attributes":{},"value":["IPUMS PMA Postdoctoral Associate"]},{"type":"character","attributes":{},"value":["http://www.ninarbrooks.com/"]}]}]},{"type":"character","attributes":{},"value":["Individuals in Context","Service Delivery Points","Data Manipulation","join","sf","raster","Spatial"]},{"type":"character","attributes":{},"value":["02-15-2021"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","toc","toc_depth","toc_float"]}},"value":[{"type":"logical","attributes":{},"value":[false]},{"type":"logical","attributes":{},"value":[true]},{"type":"integer","attributes":{},"value":[3]},{"type":"logical","attributes":{},"value":[true]}]}]},{"type":"character","attributes":{},"value":["images/road_map.png"]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["bf_gps_fake.csv","bfa_pd_2017_1km.tif","BFA_roads/BFA_roads.dbf","BFA_roads/BFA_roads.prj","BFA_roads/BFA_roads.shp","BFA_roads/BFA_roads.shx","images/raster-resolution.png","images/road_map.pdf","images/road_map.png","merging-external-spatial-data_files/anchor-4.2.2/anchor.min.js","merging-external-spatial-data_files/bowser-1.9.3/bowser.min.js","merging-external-spatial-data_files/distill-2.2.21/template.v2.js","merging-external-spatial-data_files/figure-html5/unnamed-chunk-10-1.png","merging-external-spatial-data_files/figure-html5/unnamed-chunk-11-1.png","merging-external-spatial-data_files/figure-html5/unnamed-chunk-15-1.png","merging-external-spatial-data_files/figure-html5/unnamed-chunk-15-2.png","merging-external-spatial-data_files/figure-html5/unnamed-chunk-16-1.png","merging-external-spatial-data_files/figure-html5/unnamed-chunk-16-2.png","merging-external-spatial-data_files/figure-html5/unnamed-chunk-17-1.png","merging-external-spatial-data_files/figure-html5/unnamed-chunk-3-1.png","merging-external-spatial-data_files/figure-html5/unnamed-chunk-5-1.png","merging-external-spatial-data_files/figure-html5/unnamed-chunk-6-1.png","merging-external-spatial-data_files/figure-html5/unnamed-chunk-9-1.png","merging-external-spatial-data_files/font-awesome-5.13.0/css/all.min.css","merging-external-spatial-data_files/font-awesome-5.13.0/css/v4-shims.min.css","merging-external-spatial-data_files/font-awesome-5.13.0/js/script.js","merging-external-spatial-data_files/font-awesome-5.13.0/webfonts/fa-brands-400.eot","merging-external-spatial-data_files/font-awesome-5.13.0/webfonts/fa-brands-400.svg","merging-external-spatial-data_files/font-awesome-5.13.0/webfonts/fa-brands-400.ttf","merging-external-spatial-data_files/font-awesome-5.13.0/webfonts/fa-brands-400.woff","merging-external-spatial-data_files/font-awesome-5.13.0/webfonts/fa-brands-400.woff2","merging-external-spatial-data_files/font-awesome-5.13.0/webfonts/fa-regular-400.eot","merging-external-spatial-data_files/font-awesome-5.13.0/webfonts/fa-regular-400.svg","merging-external-spatial-data_files/font-awesome-5.13.0/webfonts/fa-regular-400.ttf","merging-external-spatial-data_files/font-awesome-5.13.0/webfonts/fa-regular-400.woff","merging-external-spatial-data_files/font-awesome-5.13.0/webfonts/fa-regular-400.woff2","merging-external-spatial-data_files/font-awesome-5.13.0/webfonts/fa-solid-900.eot","merging-external-spatial-data_files/font-awesome-5.13.0/webfonts/fa-solid-900.svg","merging-external-spatial-data_files/font-awesome-5.13.0/webfonts/fa-solid-900.ttf","merging-external-spatial-data_files/font-awesome-5.13.0/webfonts/fa-solid-900.woff","merging-external-spatial-data_files/font-awesome-5.13.0/webfonts/fa-solid-900.woff2","merging-external-spatial-data_files/header-attrs-2.6/header-attrs.js","merging-external-spatial-data_files/jquery-1.11.3/jquery.min.js","merging-external-spatial-data_files/webcomponents-2.0.0/webcomponents.js"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

  <style type="text/css">

  body {
    background-color: white;
  }

  .pandoc-table {
    width: 100%;
  }

  .pandoc-table>caption {
    margin-bottom: 10px;
  }

  .pandoc-table th:not([align]) {
    text-align: left;
  }

  .pagedtable-footer {
    font-size: 15px;
  }

  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }

  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }

  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }

  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }

  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }

  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
  }

  .html-widget {
    margin-bottom: 2.0em;
  }

  .l-screen-inset {
    padding-right: 16px;
  }

  .l-screen .caption {
    margin-left: 10px;
  }

  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .shaded-content {
    background: white;
  }

  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }

  .hidden {
    display: none !important;
  }

  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }

  d-appendix {
    padding-top: 30px;
  }

  d-article>p>img {
    width: 100%;
  }

  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }

  d-article h3 {
    margin-top: 1.5rem;
  }

  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }

  /* Tweak code blocks */

  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }

  d-article div.sourceCode {
    background-color: white;
  }

  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }

  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  d-article pre a {
    border-bottom: none;
  }

  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }

  @media(min-width: 768px) {

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }

  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }

  d-article pre {
    font-size: 14px;
  }

  }

  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  /* CSS for d-contents */

  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }

  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }

  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .d-contents li {
    list-style-type: none
  }

  .d-contents nav > ul {
    padding-left: 0;
  }

  .d-contents ul {
    padding-left: 1em
  }

  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }

  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }

  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }

  .d-contents nav > ul > li > a {
    font-weight: 600;
  }

  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }

  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }


  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }

  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }


  /* Figure */

  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }

  .figure img {
    width: 100%;
  }

  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }

  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }

  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }

  /* Citations */

  d-article .citation {
    color: inherit;
    cursor: inherit;
  }

  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }


  /* Tweak 1000px media break to show more text */

  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }

    .grid {
      grid-column-gap: 16px;
    }

    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }

  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }

    .grid {
      grid-column-gap: 32px;
    }
  }


  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */

  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Include appendix styles here so they can be overridden */

  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }

  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }

  d-appendix h3 + * {
    margin-top: 1em;
  }

  d-appendix ol {
    padding: 0 0 0 15px;
  }

  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }

  d-appendix li {
    margin-bottom: 1em;
  }

  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }

  d-appendix > * {
    grid-column: text;
  }

  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }

  /* Include footnote styles here so they can be overridden */

  d-footnote-list {
    contain: layout style;
  }

  d-footnote-list > * {
    grid-column: text;
  }

  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }



  /* Anchor.js */

  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }

  /* Social footer */

  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }

  .disqus-comments {
    margin-right: 30px;
  }

  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }

  #disqus_thread {
    margin-top: 30px;
  }

  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }

  .article-sharing a:hover {
    border-bottom: none;
  }

  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }

  .subscribe p {
    margin-bottom: 0.5em;
  }


  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }


  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }

  .custom p {
    margin-bottom: 0.5em;
  }

  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }

  /* Styles for posts lists (not auto-injected) */


  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }

  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }

  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }

  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }

  .post-preview-last {
    border-bottom: none !important;
  }

  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }

  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }

  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }

  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }

  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }

  .posts-list .metadata > * {
    display: inline-block;
  }

  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }

  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }

  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }

  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .posts-list img {
    opacity: 1;
  }

  .posts-list img[data-src] {
    opacity: 0;
  }

  .posts-more {
    clear: both;
  }


  .posts-sidebar {
    font-size: 16px;
  }

  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }

  .sidebar-section {
    margin-bottom: 30px;
  }

  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }

  .categories li>a {
    border-bottom: none;
  }

  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }

  .categories .active {
    font-weight: 600;
  }

  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }


  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }


  /* Improve display for browsers without grid (IE/Edge <= 15) */

  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }

  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }

  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }

  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }

  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }

  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }


  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }

  .downlevel .footnotes ol {
    padding-left: 13px;
  }

  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }

  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }

  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }

  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  .downlevel .posts-list .post-preview {
    color: inherit;
  }



  </style>

  <script type="application/javascript">

  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }

  // show body when load is complete
  function on_load_complete() {

    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }


    // set body to visible
    document.body.style.visibility = 'visible';

    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }

    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }

  function init_distill() {

    init_common();

    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);

    // create d-title
    $('.d-title').changeElementType('d-title');

    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);

    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();

    // move posts container into article
    $('.posts-container').appendTo($('d-article'));

    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');

    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;

    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();

    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));

    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });

    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');

    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {

      // capture layout
      var layout = $(this).attr('data-layout');

      // apply layout to markdown level block elements
      var elements = $(this).children().not('div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });


      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });

    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();

    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();

    // load distill framework
    load_distill_framework();

    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {

      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;

      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');

      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');

      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });

      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }

      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");

      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }

       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }

      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();

      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();

      // clear polling timer
      clearInterval(tid);

      // show body now that everything is ready
      on_load_complete();
    }

    var tid = setInterval(distill_post_process, 50);
    distill_post_process();

  }

  function init_downlevel() {

    init_common();

     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));

    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;

    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();

    // remove toc
    $('.d-contents').remove();

    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });


    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);

    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();

    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });

    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));

    $('body').addClass('downlevel');

    on_load_complete();
  }


  function init_common() {

    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};

        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });

        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);

    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});

    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });

      }
    });

    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });

    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }

    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');

    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");

    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();

    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });

  </script>

  <!--/radix_placeholder_distill-->
  <script src="merging-external-spatial-data_files/header-attrs-2.7/header-attrs.js"></script>
  <script src="merging-external-spatial-data_files/jquery-1.11.3/jquery.min.js"></script>
  <script src="merging-external-spatial-data_files/anchor-4.2.2/anchor.min.js"></script>
  <script src="merging-external-spatial-data_files/bowser-1.9.3/bowser.min.js"></script>
  <script src="merging-external-spatial-data_files/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="merging-external-spatial-data_files/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Merging external spatial data","description":"How to integrate external spatial data with PMA data.","authors":[{"author":"Nina Brooks","authorURL":"http://www.ninarbrooks.com/","affiliation":"IPUMS PMA Postdoctoral Associate","affiliationURL":"#","orcidID":""}],"publishedDate":"2021-02-15T00:00:00.000+00:00","citationText":"Brooks, 2021"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Merging external spatial data</h1>
<!--radix_placeholder_categories-->
<div class="dt-tags">
<div class="dt=tag">Individuals in Context</div>
<div class="dt=tag">Service Delivery Points</div>
<div class="dt=tag">Data Manipulation</div>
<div class="dt=tag">join</div>
<div class="dt=tag">sf</div>
<div class="dt=tag">raster</div>
<div class="dt=tag">Spatial</div>
</div>
<!--/radix_placeholder_categories-->
<p><p>How to integrate external spatial data with PMA data.</p></p>
</div>

<div class="d-byline">
  Nina Brooks <a href="http://www.ninarbrooks.com/" class="uri">http://www.ninarbrooks.com/</a> (IPUMS PMA Postdoctoral Associate)
  
<br/>02-15-2021
</div>

<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#data">Data</a></li>
<li><a href="#setup-load-packages-and-data">Setup: Load packages and data</a></li>
<li><a href="#population-density-working-with-raster-data">Population Density: working with raster data</a></li>
<li><a href="#road-networks-working-with-vector-data">Road Networks: Working with vector data</a></li>
</ul>
</nav>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<p>Our <a href="../2021-01-29-mapping-sdp-variables/index.html">last post</a> showed how to read, merge, and map the PMA GPS data - and how mapping can shed light on interesting spatial variation. A big advantage of the PMA GPS data is that you can also merge in other sources of spatial data, which opens up enormous opportunities for analyzing how contextual and environmental factors affect topics of interest in the PMA data. In this post, we’ll show how to merge in two different types of spatial data and construct variables of interest.</p>
<h1 id="data">Data</h1>
<p>We’ll be using toy PMA GPS data for this post. <strong>To use real PMA GPS data you must request access directly from our partners at</strong> <a href="https://www.pmadata.org/data/about-data">pmadata.org</a>. The toy data we’ll use here contains randomly sampled locations within Burkina Faso which have no actual relationship to the EAs in the PMA data. This means none of the interpretations of spatial patterns will hold, but all the code will run.</p>
<p>We will also be introducing two different spatial datasets that represent different kinds of spatial data. The first is population density data from <a href="https://www.worldpop.org/">WorldPop</a>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> If you want to download the data from the WorldPop site, we’re using the “Unconstrained individual countries 2000-2020 (1 km resolution)” data from 2017 for Burkina Faso. This is <strong>raster</strong> data, which means the data are stored as a grid of values which are rendered on a map as pixels. You can think of this as a matrix that is spatially referenced – that is each pixel represents a specific area of land on the Earth. Lots of spatial data are stored as rasters including climate data (e.g., temperature and rainfall), elevation, and satellite images. <strong>Note that the raster data is saved as a .tiff (which is a common way of storing raster data).</strong> The resolution of the raster maps to the area that each pixel represents in the real world. The population density is <strong>1 km resolution</strong>, which means that each pixel represents a 1 km by 1 km square on the ground. The figure below shows the impact of different spatial resolutions for the same raster data.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure"><span id="fig:unnamed-chunk-1"></span>
<img src="images/raster-resolution.png" alt="Source: [NEON](https://www.neonscience.org/resources/learning-hub/tutorials/raster-res-extent-pixels-r)" width="562" />
<p class="caption">
Figure 1: Source: <a href="https://www.neonscience.org/resources/learning-hub/tutorials/raster-res-extent-pixels-r">NEON</a>
</p>
</div>
</div>
<aside>
There are tons of resources on <strong>earth</strong> data science in R. We recommend the resources by <a href="https://www.earthdatascience.org">Earth Lab</a> and <a href="https://www.neonscience.org">NEON by NSF</a>. <a href="https://www.neonscience.org/resources/learning-hub/tutorials/raster-data-r">This post</a> is an excellent introduction to working with rasters in R!
</aside>
<p>Population density is also conceptually important to the <code>SDP</code> data on contraceptive supply that we’ve been examining through this series of posts. Population density may provide a more nuanced characterization of urbanization than the <code>URBAN</code> variable. Additionally, density may be correlated with longer wait times at clinics, which may also impact contraceptive use at the individual level.</p>
<p>The second spatial dataset we’ll introduce is data on road networks in Burkina Faso from the Digital Chart of the World and made publicly available by <a href="http://www.diva-gis.org/">DIVA-GIS</a>, an excellent source for publicly available spatial datasets. Road networks serve as a proxy for accessibility to health clinics – an important component of the contraceptive service environment – that may be more nuanced than the binary urban/rural distinction. To download the road data, go to <a href="http://www.diva-gis.org/gdata">DIVA-GIS Data</a> and select Burkina Faso from the Country dropdown and Roads from the Subject dropdown. The road data is called <strong>vector</strong> data and is stored in a <strong>shapefile (.shp).</strong> Vector data is used to represent real world features and are three basic types: points, lines, and polygons. The road data we’re using in this post is an example of vector line data.</p>
<aside>
Remember the administrative boundaries we used in the previous post were <strong>polygons</strong> and the GPS points for the PMA enumeration areas were <strong>points.</strong> Both are vector data!
</aside>
<h1 id="setup-load-packages-and-data">Setup: Load packages and data</h1>
<p>We’ll be using many of the packages from the last few posts, as well as a new package for specifically working with raster data – appropriately called <a href="https://rspatial.org/raster/pkg/index.html">raster</a> – and one called <a href="https://cran.r-project.org/web/packages/units/index.html">units</a>, which enables easy conversion between objects of different units. Make sure to install the <code>raster</code> and <code>units</code> packages first and then load everything we’ll be using today:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://r-spatial.github.io/sf/'>sf</a></span><span class='op'>)</span> <span class='co'># primary spatial package</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://rspatial.org/raster'>raster</a></span><span class='op'>)</span> <span class='co'># for working with raster data</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/sjmgarnier/viridis'>viridis</a></span><span class='op'>)</span> <span class='co'># for color palettes</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/r-quantities/units/'>units</a></span><span class='op'>)</span> <span class='co'># to easily convert between units</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://tidyverse.tidyverse.org'>tidyverse</a></span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Let’s start by reading in the raster using <code>raster::raster()</code> and check out the meta-data.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>pop_density</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/raster/man/raster.html'>raster</a></span><span class='op'>(</span><span class='st'>"bfa_pd_2017_1km.tif"</span><span class='op'>)</span>
<span class='va'>pop_density</span>
</code></pre>
</div>
<pre><code>class      : RasterLayer 
dimensions : 682, 951, 648582  (nrow, ncol, ncell)
resolution : 0.008333333, 0.008333333  (x, y)
extent     : -5.517917, 2.407083, 9.407917, 15.09125  (xmin, xmax, ymin, ymax)
crs        : +proj=longlat +datum=WGS84 +no_defs 
source     : /Users/Matt/R/pma-data-hub/_posts/2021-02-04-merging-external-spatial-data/bfa_pd_2017_1km.tif 
names      : bfa_pd_2017_1km 
values     : 0.281988, 8820.016  (min, max)</code></pre>
</div>
<p>Because rasters are essentially just matrices, you can think of the <code>dimensions</code> in the same way. At a spatial resolution of 1 km, this raster covers all of Burkina Faso with 648,582 cells. The <code>resolution</code> describes the size of the cells (the length of one side of each square cell). <strong>You may be wondering why this is showing up as 0.00833 when the data has a spatial scale of 1 km by 1 km.</strong> This is because the units that the resolution is reported in depend on the <strong>coordinate reference system</strong> of the data. More on this in a moment.</p>
<p>The <code>extent</code> (or spatial extent) refers to the geographic area that the raster covers. The values are in the same <code>coordinate reference system</code> as the raster. The <code>coordinate reference system</code> or <code>crs</code> is the next piece of meta-data we have. “A coordinate reference system (CRS) is a coordinate-based local, regional or global system used to locate geographical entities.”<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> The <code>crs</code> for this raster is <code>+proj=longlat +datum=WGS84 +no_defs</code>. The <code>crs</code> contains several pieces of information including the datum (WGS84) and the projection.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> The appropriate CRS to use for any given spatial task depends on what part of the world the data represent and what kind of spatial operations you’ll be performing. <strong>It’s really important to know what</strong> <code>crs</code> <strong>your data are in and make sure that all your spatial data are in the same </strong> <code>crs</code> <strong>if you use more than one kind. Otherwise, they won’t line up on a map and any spatial analysis or processing you do will be incorrect.</strong></p>
<p>The <code>projection</code> of this raster data is described as <code>longlat</code>, which actually is <strong>not a <code>projection</code></strong>. A <code>projection</code> refers to how the Earth’s surface is flattened so it can be represented as a 2-dimensional raster grid. These data use a <code>geographic coordinate system</code>, simply the raw latitude and longitude coordinates, rather than a <code>projected coordinate system</code>, which would transform the coordinates into a 2-dimensional plane. Latitude and longitude locate positions on the Earth using angles, so the spacing of each line of latitude as you move north or south along the Earth is not uniform. The units of this reference system are in degrees (of latitude and longitude), so the 0.00833 resolution we saw above is reporting the spatial resolution in <strong>degrees, rather than meters or kilometers</strong>. This <code>crs</code> is not ideal for measuring distances because the distance covered by a single degree of latitude or longitude varies greatly across the Earth’s surface. This also means that the stated 1 km resolution is only nominal. At the equator, 0.00833 degrees is approximately equal to 1 km, but this distance, and the ground area represented by each pixel, will vary. Fortunately, Burkina Faso is relatively close to the equator, so the pixels will be quite close to 1 km by 1 km.</p>
<p>The last piece of meta-data to look at are the <code>values</code> – this is reporting the minimum and maximum values across all of the cells. Because these are population density data, it can be interpreted as the number of people in each pixel divided by the area of each pixel (which we know is 1 km<sup>2</sup>)</p>
<p>Now that we’ve reviewed the raster attributes, let’s see what it looks like. We can use the basic <code>plot</code> function to do this.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='fu'><a href='https://r-spatial.github.io/sf/reference/plot.html'>plot</a></span><span class='op'>(</span><span class='va'>pop_density</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="merging-external-spatial-data_files/figure-html5/unnamed-chunk-3-1.png" width="624" /></p>
</div>
<p>We can see three locations stand out in terms of population density. First is Ouagadougou the capital of Burkina Faso and largest city, right in the center. Then we can see higher density around Bobo Dioulasso and Banfora in the southwest of the country, which are the second and third largest cities in the country.</p>
<p>Next we’ll load the roads data using <code>sf::st_read()</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>roads</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_read.html'>st_read</a></span><span class='op'>(</span><span class='st'>"BFA_roads/BFA_roads.shp"</span>, quiet <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
<span class='va'>roads</span>
</code></pre>
</div>
<pre><code>Simple feature collection with 1149 features and 5 fields
geometry type:  MULTILINESTRING
dimension:      XY
bbox:           xmin: -5.482261 ymin: 9.407643 xmax: 2.393089 ymax: 15.08071
geographic CRS: WGS 84
First 10 features:
       MED_DESCRI      RTT_DESCRI F_CODE_DES ISO   ISOCOUNTRY
1  Without Median Secondary Route       Road BFA BURKINA FASO
2  Without Median Secondary Route       Road BFA BURKINA FASO
3  Without Median Secondary Route       Road BFA BURKINA FASO
4  Without Median Secondary Route       Road BFA BURKINA FASO
5  Without Median Secondary Route       Road BFA BURKINA FASO
6  Without Median Secondary Route       Road BFA BURKINA FASO
7  Without Median Secondary Route       Road BFA BURKINA FASO
8  Without Median Secondary Route       Road BFA BURKINA FASO
9  Without Median Secondary Route       Road BFA BURKINA FASO
10 Without Median Secondary Route       Road BFA BURKINA FASO
                         geometry
1  MULTILINESTRING ((-0.720550...
2  MULTILINESTRING ((-0.583273...
3  MULTILINESTRING ((-0.397415...
4  MULTILINESTRING ((-0.142728...
5  MULTILINESTRING ((-0.403059...
6  MULTILINESTRING ((-0.171111...
7  MULTILINESTRING ((-0.116756...
8  MULTILINESTRING ((0.0672155...
9  MULTILINESTRING ((-1.245636...
10 MULTILINESTRING ((-1.50246 ...</code></pre>
</div>
<p>This <code>sf</code> object also contains meta-data (shown at the top). In terms of meta-data, the <code>geometry type</code> field tells us this data is a <code>MULTILINESTRING</code> object, which makes sense since these are roads. The <code>bbox</code> (short for bounding box), is the same information as the <code>extent</code> field for the raster data – it tells us the bounds of the geographic area that this spatial data covers. We see the <code>geographic CRS</code> which is the coordinate reference system of the data. For this roads dataset it is WGS84, which is the same as the population density raster data.</p>
<p>The roads data contains several variables: <code>MED_DESCRI</code>, <code>RTT_DESCRI</code>, <code>F_CODE_DES</code>, <code>ISO</code>, <code>ISOCOUNTRY</code>, and <code>geometry</code>. The first three variables provide some information about the types of roads in this data. <code>ISO</code> and <code>ISOCOUNTRY</code> simply provide country codes and names for the data. Finally, we see the <code>geometry</code> variable, which is the variable that contains the spatial information in an <code>sf</code> object.</p>
<p>We can also plot this roads data to see what it looks like.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='fu'><a href='https://r-spatial.github.io/sf/reference/plot.html'>plot</a></span><span class='op'>(</span><span class='va'>roads</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="merging-external-spatial-data_files/figure-html5/unnamed-chunk-5-1.png" width="624" /></p>
</div>
<p>By calling the basic <code>plot</code> function, we get a panel of plots of the road network, with one plot for each variable. We can see some variation in color <code>MED_DESCRI</code> and <code>RTT_DESCRI</code>, indicating that there multiple values for those variables. If we wanted just a single plot of the road network, we can get that by calling <code>plot</code> on the <code>geometry</code> variable:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='fu'><a href='https://r-spatial.github.io/sf/reference/plot.html'>plot</a></span><span class='op'>(</span><span class='va'>roads</span><span class='op'>$</span><span class='va'>geometry</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="merging-external-spatial-data_files/figure-html5/unnamed-chunk-6-1.png" width="624" /></p>
</div>
<p>Finally, we’ll load the “toy” GPS data and convert it to an <code>sf</code> object. The option <code>crs = 4326</code> means that we are creating this with the WGS84 coordinate reference system because <strong>4326</strong> is the EPSG code for WGS84.</p>
<aside>
Most <code>crs</code> are assigned an “EPSG code”, which is a unique ID that can be used to identify a CRS.
</aside>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>gps</span> <span class='op'>&lt;-</span> <span class='fu'>read_csv</span><span class='op'>(</span><span class='st'>"bf_gps_fake.csv"</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>rename</span><span class='op'>(</span>EAID <span class='op'>=</span> <span class='va'>EA_ID</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='co'># rename to be consistent with other PMA data</span>
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_as_sf.html'>st_as_sf</a></span><span class='op'>(</span>
    coords <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"GPSLONG"</span>, <span class='st'>"GPSLAT"</span><span class='op'>)</span>, 
    crs <span class='op'>=</span> <span class='fl'>4326</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<h1 id="population-density-working-with-raster-data">Population Density: working with raster data</h1>
<p>We want to construct a variable that captures the population density at each enumeration area in the data. We’ll use <code>sf::st_buffer()</code> to do this, which will construct a buffer circle around each GPS point. The PMA GPS data are randomly displaced to protect the privacy of respondents, so it’s imperative to consider this displacement when working with the GPS data to do spatial operations. Because the maximum displacement distance is 10 km, if we construct buffers with a radius of 10 km we can be 100% confident that the true locations of each GPS point fall within that buffer.</p>
<aside>
Urban EAs are displaced from their true location up to 2 km. Rural EAs are displaced from their true location up to 5 km. Additionally, a random sample of 1% of rural EAs are displaced up to 10km.
</aside>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>buffers</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/geos_unary.html'>st_buffer</a></span><span class='op'>(</span><span class='va'>gps</span>, dist <span class='op'>=</span> <span class='fl'>10000</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Warning in st_buffer.sfc(st_geometry(x), dist, nQuadSegs, endCapStyle
= endCapStyle, : st_buffer does not correctly buffer longitude/
latitude data</code></pre>
<pre><code>dist is assumed to be in decimal degrees (arc_degrees).</code></pre>
<div class="sourceCode">
<pre><code><span class='fu'>ggplot</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_sf</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>buffers</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_sf</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>gps</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="merging-external-spatial-data_files/figure-html5/unnamed-chunk-9-1.png" width="624" /></p>
</div>
<p>This giant circle is certainly not what we would expect! What’s going on here? Earlier in this post we mentioned that the WGS84 <code>crs</code> is a <code>geographic coordinate system</code> that simply uses the latitude and longitude coordinates to identify locations and the units are in <strong>degrees, rather than meters or kilometers</strong>. This circle thus has a radius of 10,000 degrees and since the Earth only spans 360 degrees it is fully covered by this circle. As we mentioned, the WGS84 <code>crs</code> is not ideal for measuring distances. <code>R</code> alerted us of this problem with two warnings: <em>st_buffer does not correctly buffer longitude/latitude data</em> and <em>dist is assumed to be in decimal degrees (arc_degrees)</em>. This is why it’s so important to pay attention to the <code>crs</code> of your data.</p>
<p>To properly construct a buffer circle around these GPS points, we need to transform the data to a different projection that uses meters or kilometers. And, because it’s essential that all of our data are in the same <code>crs</code>, we need to transform or reproject everything. For vector data, we can do this using <code>sf::st_transform()</code> and for raster data we’ll do this with <code>raster::projectRaster()</code>. For the transformation, we’re using a <code>crs</code> that is projected to meters and is appropriate to the local geography of Burkina Faso. You can read about it on the <a href="https://epsg.io/32630">epsg.io</a> site. After reprojecting, we’ll calculate the buffer again and plot it to make sure this looks right.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='co'># transform the GPS data</span>
<span class='va'>gps_tr</span> <span class='op'>&lt;-</span> <span class='va'>gps</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_transform.html'>st_transform</a></span><span class='op'>(</span>crs <span class='op'>=</span> <span class='fl'>32630</span><span class='op'>)</span>
<span class='va'>gps_tr</span>
</code></pre>
</div>
<pre><code>Simple feature collection with 83 features and 5 fields
geometry type:  POINT
dimension:      XY
bbox:           xmin: 260943.3 ymin: 1114669 xmax: 1025472 ymax: 1653511
projected CRS:  WGS 84 / UTM zone 30N
# A tibble: 83 x 6
   PMACC PMAYEAR REGION                EAID DATUM           geometry
 * &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;                &lt;dbl&gt; &lt;chr&gt;        &lt;POINT [m]&gt;
 1 BF       2017 5. centre-nord        7610 WGS84 (837531.4 1567675)
 2 BF       2017 1. boucle-du-mouhoun  7820 WGS84 (491871.7 1488848)
 3 BF       2017 3. centre             7271 WGS84   (982414 1349907)
 4 BF       2017 3. centre             7799 WGS84   (739431 1352652)
 5 BF       2017 8. est                7243 WGS84 (545866.2 1219668)
 6 BF       2017 6. centre-ouest       7026 WGS84 (352638.7 1209502)
 7 BF       2017 3. centre             7859 WGS84 (833822.1 1377527)
 8 BF       2017 3. centre             7725 WGS84 (980025.8 1406727)
 9 BF       2017 6. centre-ouest       7390 WGS84 (439876.7 1190609)
10 BF       2017 11. plateau-central   7104 WGS84 (835483.2 1469280)
# … with 73 more rows</code></pre>
<div class="sourceCode">
<pre><code><span class='co'># reproject the raster data</span>
<span class='va'>pop_density_tr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/raster/man/projectRaster.html'>projectRaster</a></span><span class='op'>(</span>
  <span class='va'>pop_density</span>, 
  crs <span class='op'>=</span> <span class='st'>"+proj=utm +zone=30 +datum=WGS84 +units=m +no_defs"</span>
<span class='op'>)</span>
<span class='va'>pop_density_tr</span>
</code></pre>
</div>
<pre><code>class      : RasterLayer 
dimensions : 699, 970, 678030  (nrow, ncol, ncell)
resolution : 907, 922  (x, y)
extent     : 218942.9, 1098733, 1035714, 1680192  (xmin, xmax, ymin, ymax)
crs        : +proj=utm +zone=30 +datum=WGS84 +units=m +no_defs 
source     : memory
names      : bfa_pd_2017_1km 
values     : 0.9709167, 8775.492  (min, max)</code></pre>
</div>
<aside>
Note: the <b>projectRaster</b> function takes <b>crs</b> as a character string, rather than the EPSG code 32630. We’re using the <a href="https://epsg.io/32630">PROJ.4 code shown in the “Export” menu</a> on the epsg.io site.
</aside>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='co'># calculate 10 km (10,000 meter) buffer circles</span>
<span class='va'>buffers_tr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/geos_unary.html'>st_buffer</a></span><span class='op'>(</span><span class='va'>gps_tr</span>, dist <span class='op'>=</span> <span class='fl'>10000</span><span class='op'>)</span> <span class='co'># because the units are in meters</span>

<span class='co'># plot</span>
<span class='fu'>ggplot</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_sf</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>buffers_tr</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_sf</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>gps_tr</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="merging-external-spatial-data_files/figure-html5/unnamed-chunk-11-1.png" width="624" /></p>
</div>
<p>Looking at the meta-data for both the <code>gps_tr</code> and <code>raster_tr</code> objects, we can see they have the same <strong>new</strong> projected <code>crs</code>: UTM zone 30N. The <code>raster_tr</code> meta-data also includes information on the units (<code>+units=m</code>) confirming that distances are measured in meters. Turning to the plot, we can see the GPS coordinates marked in red and each has a circle around it.</p>
<p>Now that we have correctly estimated 10 km buffer circles, we can calculate the average population density within each buffer using the <code>raster::extract()</code> command and specifying <code>fun = mean</code>. This produces an 83 x 1 vector of results, which means we have one population density value for each enumeration area. Printing the first 5 results shows there is some substantial variation in population density.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>buffer_density</span> <span class='op'>&lt;-</span> <span class='fu'>raster</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/raster/man/extract.html'>extract</a></span><span class='op'>(</span>
  <span class='va'>pop_density_tr</span>, 
  <span class='va'>buffers_tr</span>, 
  fun <span class='op'>=</span> <span class='va'>mean</span>, 
  na.rm <span class='op'>=</span> <span class='cn'>TRUE</span>,
  cellnumbers <span class='op'>=</span> <span class='cn'>TRUE</span>
<span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/raster/man/dimensions.html'>dim</a></span><span class='op'>(</span><span class='va'>buffer_density</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 83  1</code></pre>
<div class="sourceCode">
<pre><code><span class='fu'><a href='https://rdrr.io/pkg/raster/man/headtail.html'>head</a></span><span class='op'>(</span><span class='va'>buffer_density</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>          [,1]
[1,]  35.58080
[2,]  21.36878
[3,]  17.56161
[4,] 113.36298
[5,]  31.73017
[6,]  57.09591</code></pre>
</div>
<p>Note, that we don’t actually need to create the buffers first to extract the mean values of the raster. We can do it all in one step, shown below. <strong>Just make sure to use the</strong> <code>gps_tr</code> <strong>object instead of the</strong> <code>buffer_tr</code> <strong>object!</strong> But, we’ll use those buffers again with the road data.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>buffer_density_alt</span> <span class='op'>&lt;-</span> <span class='fu'>raster</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/raster/man/extract.html'>extract</a></span><span class='op'>(</span>
  <span class='va'>pop_density_tr</span>, <span class='va'>gps_tr</span>, 
  buffer <span class='op'>=</span> <span class='fl'>10000</span>,
  fun <span class='op'>=</span> <span class='va'>mean</span>, 
  na.rm <span class='op'>=</span> <span class='cn'>TRUE</span>
<span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/raster/man/headtail.html'>head</a></span><span class='op'>(</span><span class='va'>buffer_density_alt</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1]  35.58080  21.36878  17.56161 113.21781  31.73017  57.09591</code></pre>
</div>
<p>Finally, so we can merge everything together by <code>EAID</code>, let’s add the population density calculation directly to the <code>gps_tr</code> data. Note that the <code>raster::extract()</code> command preserves the order of the inputs, so we know the first row of the density calculation corresponds to the first row of the <code>gps_tr</code> data.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>gps_tr</span><span class='op'>$</span><span class='va'>pop_density</span> <span class='op'>&lt;-</span> <span class='fu'>raster</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/raster/man/extract.html'>extract</a></span><span class='op'>(</span>
  <span class='va'>pop_density_tr</span>, <span class='va'>gps_tr</span>, 
  buffer <span class='op'>=</span> <span class='fl'>10000</span>,
  fun <span class='op'>=</span> <span class='va'>mean</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span>
<span class='op'>)</span>
</code></pre>
</div>
</div>
<h1 id="road-networks-working-with-vector-data">Road Networks: Working with vector data</h1>
<p>Before we do anything with the road data, let’s make sure to reproject it to match the rest of our data.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>roads_tr</span> <span class='op'>&lt;-</span> <span class='va'>roads</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_transform.html'>st_transform</a></span><span class='op'>(</span>crs <span class='op'>=</span> <span class='fl'>32630</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Because enumeration areas with better access to roads may make it easier for women to reach local service delivery providers. We are going to calculate the total length of roads within each buffer as a proxy for this accessibility. Because each of these buffers was constructed with the same 10 km radius, they have the same area, which means the sum of road length can also be thought of as a road density measure.</p>
<p>First, we need to identify which portions of the road fall into each buffer. We’ll use <code>sf::st_intersection()</code>, which returns a new <code>sf</code> object that contains observations from the first argument that touch (geographically) the second argument.</p>
<aside>
Note that there is also an <code>sf::intersects()</code> command. This is different than the one we’re using because it returns a logical matrix that indicates whether each geometry pair intersects. See more on these types of operations in the <a href="https://r-spatial.github.io/sf/articles/sf3.html#geometrical-operations-1"><code>sf</code> vignette</a>.
</aside>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>int</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/geos_binary_ops.html'>st_intersection</a></span><span class='op'>(</span><span class='va'>roads_tr</span>, <span class='va'>buffers_tr</span><span class='op'>)</span>
<span class='va'>int</span>
</code></pre>
</div>
<pre><code>Simple feature collection with 238 features and 10 fields
geometry type:  LINESTRING
dimension:      XY
bbox:           xmin: 251238.7 ymin: 1104708 xmax: 1033002 ymax: 1658158
projected CRS:  WGS 84 / UTM zone 30N
First 10 features:
        MED_DESCRI      RTT_DESCRI F_CODE_DES ISO   ISOCOUNTRY PMACC
240 Without Median Secondary Route       Road BFA BURKINA FASO    BF
241 Without Median Secondary Route       Road BFA BURKINA FASO    BF
268 Without Median Secondary Route       Road BFA BURKINA FASO    BF
711 Without Median Secondary Route       Road BFA BURKINA FASO    BF
640    With Median   Primary Route       Road BFA BURKINA FASO    BF
649    With Median   Primary Route       Road BFA BURKINA FASO    BF
728 Without Median Secondary Route       Road BFA BURKINA FASO    BF
958 Without Median Secondary Route       Road BFA BURKINA FASO    BF
959 Without Median Secondary Route       Road BFA BURKINA FASO    BF
964 Without Median Secondary Route       Road BFA BURKINA FASO    BF
    PMAYEAR               REGION EAID DATUM
240    2017 1. boucle-du-mouhoun 7820 WGS84
241    2017 1. boucle-du-mouhoun 7820 WGS84
268    2017 1. boucle-du-mouhoun 7820 WGS84
711    2017            3. centre 7271 WGS84
640    2017            3. centre 7799 WGS84
649    2017            3. centre 7799 WGS84
728    2017            3. centre 7799 WGS84
958    2017               8. est 7243 WGS84
959    2017               8. est 7243 WGS84
964    2017               8. est 7243 WGS84
                          geometry
240 LINESTRING (501051.3 149280...
241 LINESTRING (481961.6 149016...
268 LINESTRING (489661.7 148171...
711 LINESTRING (981157 1359825,...
640 LINESTRING (732417.5 135977...
649 LINESTRING (746990.9 135527...
728 LINESTRING (746990.9 135527...
958 LINESTRING (553191.7 122647...
959 LINESTRING (554462.3 122043...
964 LINESTRING (535888.5 122030...</code></pre>
</div>
<p>The returned object (<code>int</code>) is a <code>data.frame</code> with 238 observations (far fewer than the original 1149 in the <code>roads_tr</code> data). Note that it also contains all the variables from both <code>roads_tr</code> and <code>buffers_tr</code>, so this operates a bit like an <code>inner_join</code>, which means it only includes observations that are in both datasets. We can see the implications of this by making a quick map. The full road network is shown in gray, the buffer circles are in black and the roads that fall into the circles are highlighted in red. Based on this map, it looks like there are a few buffer circles that don’t contain any roads. We want to be sure we account for this.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='co'># plot intersection with buffers and road networks </span>
<span class='fu'>ggplot</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_sf</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>buffers_tr</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_sf</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>roads_tr</span>, color <span class='op'>=</span> <span class='st'>"grey"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_sf</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>int</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="merging-external-spatial-data_files/figure-html5/unnamed-chunk-17-1.png" width="624" /></p>
</div>
<p>We can merge in the full list of <code>EAIDs</code> to make sure we don’t miss this one (or any others) using <code>sf:st_join()</code>, which works like <code>dplyr::left_join()</code>. It’s important that when we do the join, the first argument is <code>int</code>, so that it will retain the <code>LINESTRING</code> geometry from this dataset, which we need to calculate the road length. Then, we’ll calculate the length of the road networks contained in each buffer. We can do this with <code>sf::st_length()</code>. Because many of the buffer circles contain multiple roads, we first need calculate the length of each road then we need to aggregate to get the length of <strong>all</strong> roads in a given enumeration area. We’ll convert from meters to km for greater readability. <strong>It’s important to note that any EAs with buffers that don’t contain any roads will not be in the</strong> <code>int</code> <strong>dataset, so we’ll do a</strong> <code>dplyr::full_join()</code> <strong>with</strong> <code>gps_tr</code> <strong>to make sure we get them all.</strong></p>
<p>Because <code>int</code> and <code>gps_tr</code> are both <code>sf</code> objects, it’s not possible to do a standard join – you can only use <code>sf::join()</code> when you have two <code>sf</code> objects. That’s why we convert both to <code>data.frames</code> for the <code>dplyr::full_join()</code> and then back into an <code>sf</code> object. Finally, we’ll convert <code>int</code> back into an <code>sf</code> object, retaining the <code>POINT</code> geometry from <code>gps_tr</code>, and replace all <code>NA</code> road lengths as 0.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='co'># join, calculate length, &amp; summarize</span>
<span class='va'>int</span> <span class='op'>&lt;-</span> <span class='va'>int</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>road_length <span class='op'>=</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/geos_measures.html'>st_length</a></span><span class='op'>(</span><span class='va'>geometry</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>EAID</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tidyverse.html'>summarise</a></span><span class='op'>(</span>road_length <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>road_length</span>, na.rm <span class='op'>=</span> <span class='cn'>T</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>road_length <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/units/man/set_units.html'>set_units</a></span><span class='op'>(</span><span class='va'>road_length</span>, <span class='st'>"km"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/pkg/raster/man/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>full_join</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/raster/man/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='va'>gps_tr</span><span class='op'>)</span>, by <span class='op'>=</span> <span class='st'>"EAID"</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/sf.html'>st_sf</a></span><span class='op'>(</span>sf_column_name <span class='op'>=</span> <span class='st'>'geometry.y'</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>geometry.x</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>road_length <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>road_length</span><span class='op'>)</span>, <span class='fl'>0</span>, <span class='va'>road_length</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>int</span>
</code></pre>
</div>
<pre><code>Simple feature collection with 83 features and 7 fields
geometry type:  POINT
dimension:      XY
bbox:           xmin: 260943.3 ymin: 1114669 xmax: 1025472 ymax: 1653511
projected CRS:  WGS 84 / UTM zone 30N
First 10 features:
   EAID road_length PMACC PMAYEAR               REGION DATUM
1  7003    22.41682    BF    2017       5. centre-nord WGS84
2  7006    13.35579    BF    2017       5. centre-nord WGS84
3  7009    20.45756    BF    2017               8. est WGS84
4  7016    20.31970    BF    2017 1. boucle-du-mouhoun WGS84
5  7026    18.99583    BF    2017      6. centre-ouest WGS84
6  7042    14.52567    BF    2017               8. est WGS84
7  7048    24.29931    BF    2017        4. centre-est WGS84
8  7056    15.21114    BF    2017     9. hauts-bassins WGS84
9  7082    44.15771    BF    2017          2. cascades WGS84
10 7092    26.30945    BF    2017        7. centre-sud WGS84
   pop_density               geometry.y
1     29.55058 POINT (422741.8 1383385)
2     29.98035 POINT (371721.6 1276582)
3     37.77861 POINT (348264.9 1114669)
4    154.07399 POINT (346019.4 1218739)
5     57.09591 POINT (352638.7 1209502)
6     63.08637 POINT (752580.5 1219236)
7     74.19692 POINT (479619.4 1234717)
8     35.07390 POINT (359915.1 1392593)
9   2731.76393 POINT (669089.2 1375002)
10   152.23504 POINT (559070.9 1346179)</code></pre>
</div>
<p>The added benefit of the <code>full_join()</code> with <code>gps_tr</code> is that it brings in the <code>pop_density</code> variable we created earlier. So now everything is in one dataset!</p>
<p>This can now be merged into other PMA data, such as the individual level dataset <code>bf_merged</code> we worked with in the other posts in this module, and the variables can be used for analysis!</p>
<p>As always, let us know if you have any questions and if you’re doing anything exciting with the PMA spatial data!</p>
<p><em>Special thanks to Tracy Kugler, Nicholas Nagle, and Jonathan Schroeder for excellent help with this post.</em></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>Linard, C., Gilbert, M., Snow, R. W., Noor, A. M., &amp; Tatem, A. J. (2012). Population distribution, settlement patterns and accessibility across Africa in 2010. PloS one, 7(2), e31743.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>NEON: <a href="https://www.neonscience.org/resources/learning-hub/tutorials/raster-res-extent-pixels-r" class="uri">https://www.neonscience.org/resources/learning-hub/tutorials/raster-res-extent-pixels-r</a><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>Wikipedia<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p><a href="https://www.earthdatascience.org/courses/earth-analytics/spatial-data-r/intro-to-coordinate-reference-systems/" class="uri">https://www.earthdatascience.org/courses/earth-analytics/spatial-data-r/intro-to-coordinate-reference-systems/</a><a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
