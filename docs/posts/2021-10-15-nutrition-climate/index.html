<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007ba5; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #007ba5; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #007ba5; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #5e5e5e; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>


  <!--radix_placeholder_meta_tags-->
<title>Data Analysis Hub: How to use CHIRPS Climate Data with PMA Nutrition Surveys</title>

<meta property="description" itemprop="description" content="Remotely sensed daily precipitation data is an incredible resource for understanding rainfed food systems."/>

<link rel="canonical" href="https://ipums.github.io/pma-data-hub/posts/2021-10-15-nutrition-climate/"/>
<link rel="icon" type="image/png" href="../../images/favicon/favicon-32x32.png"/>

<!--  https://schema.org/Article -->
<meta property="article:published" itemprop="datePublished" content="2021-10-15"/>
<meta property="article:created" itemprop="dateCreated" content="2021-10-15"/>
<meta name="article:author" content="Matt Gunther"/>

<!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
<meta property="og:title" content="Data Analysis Hub: How to use CHIRPS Climate Data with PMA Nutrition Surveys"/>
<meta property="og:type" content="article"/>
<meta property="og:description" content="Remotely sensed daily precipitation data is an incredible resource for understanding rainfed food systems."/>
<meta property="og:url" content="https://ipums.github.io/pma-data-hub/posts/2021-10-15-nutrition-climate/"/>
<meta property="og:image" content="https://ipums.github.io/pma-data-hub/posts/2021-10-15-nutrition-climate/nutrition-climate_files/figure-html5/unnamed-chunk-32-1.png"/>
<meta property="og:image:width" content="1536"/>
<meta property="og:image:height" content="1536"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:site_name" content="Data Analysis Hub"/>

<!--  https://dev.twitter.com/cards/types/summary -->
<meta property="twitter:card" content="summary_large_image"/>
<meta property="twitter:title" content="Data Analysis Hub: How to use CHIRPS Climate Data with PMA Nutrition Surveys"/>
<meta property="twitter:description" content="Remotely sensed daily precipitation data is an incredible resource for understanding rainfed food systems."/>
<meta property="twitter:url" content="https://ipums.github.io/pma-data-hub/posts/2021-10-15-nutrition-climate/"/>
<meta property="twitter:image" content="https://ipums.github.io/pma-data-hub/posts/2021-10-15-nutrition-climate/nutrition-climate_files/figure-html5/unnamed-chunk-32-1.png"/>
<meta property="twitter:image:width" content="1536"/>
<meta property="twitter:image:height" content="1536"/>
<meta property="twitter:site" content="@ipumsGH"/>

<!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

<script type="text/json" id="radix-rmarkdown-metadata">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","categories","output","canonical_url"]}},"value":[{"type":"character","attributes":{},"value":["How to use CHIRPS Climate Data with PMA Nutrition Surveys"]},{"type":"character","attributes":{},"value":["Remotely sensed daily precipitation data is an incredible resource for understanding rainfed food systems."]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","affiliation"]}},"value":[{"type":"character","attributes":{},"value":["Matt Gunther"]},{"type":"character","attributes":{},"value":["IPUMS PMA Senior Data Analyst"]}]}]},{"type":"character","attributes":{},"value":["10-15-2021"]},{"type":"character","attributes":{},"value":["Nutrition","CHIRPS","Precipitation","Climate","Agriculture","terra","sf","ggspatial"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","toc","toc_depth","toc_float"]}},"value":[{"type":"logical","attributes":{},"value":[false]},{"type":"logical","attributes":{},"value":[true]},{"type":"integer","attributes":{},"value":[3]},{"type":"logical","attributes":{},"value":[true]}]}]},{"type":"character","attributes":{},"value":["https://ipums.github.io/pma-data-hub/posts/2021-10-15-nutrition-climate/"]}]}
</script>
<!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["data/chirps_bf/19970301.tif","data/ea_all.gz","data/ea_all.rds.gz","data/ea_one.gz","data/ea_one.rds","data/gps_bf.csv","data/ipums.rds.gz","data/shape_bf/geobf.CPG","data/shape_bf/geobf.dbf","data/shape_bf/geobf.prj","data/shape_bf/geobf.sbn","data/shape_bf/geobf.sbx","data/shape_bf/geobf.shp","data/shape_bf/geobf.shp.xml","data/shape_bf/geobf.shx","images/chirps1.png","images/chirps2.png","images/chirps3.png","images/climateserv1.png","images/climateserv2.png","images/displacement.png","nutrition-climate_files/anchor-4.2.2/anchor.min.js","nutrition-climate_files/bowser-1.9.3/bowser.min.js","nutrition-climate_files/distill-2.2.21/template.v2.js","nutrition-climate_files/figure-html5/unnamed-chunk-10-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-11-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-13-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-14-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-15-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-21-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-22-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-23-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-24-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-27-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-28-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-29-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-30-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-31-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-32-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-33-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-38-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-40-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-41-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-42-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-5-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-6-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-7-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-8-1.png","nutrition-climate_files/figure-html5/unnamed-chunk-9-1.png","nutrition-climate_files/header-attrs-2.11/header-attrs.js","nutrition-climate_files/jquery-3.6.0/jquery-3.6.0.js","nutrition-climate_files/jquery-3.6.0/jquery-3.6.0.min.js","nutrition-climate_files/jquery-3.6.0/jquery-3.6.0.min.map","nutrition-climate_files/popper-2.6.0/popper.min.js","nutrition-climate_files/tippy-6.2.7/tippy-bundle.umd.min.js","nutrition-climate_files/tippy-6.2.7/tippy-light-border.css","nutrition-climate_files/tippy-6.2.7/tippy.css","nutrition-climate_files/tippy-6.2.7/tippy.umd.min.js","nutrition-climate_files/webcomponents-2.0.0/webcomponents.js","PMA_displacement.pdf"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
<meta name="distill:offset" content="../.."/>

<script type="application/javascript">

  window.headroom_prevent_pin = false;

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // initialize headroom for banner
    var header = $('header').get(0);
    var headerHeight = header.offsetHeight;
    var headroom = new Headroom(header, {
      tolerance: 5,
      onPin : function() {
        if (window.headroom_prevent_pin) {
          window.headroom_prevent_pin = false;
          headroom.unpin();
        }
      }
    });
    headroom.init();
    if(window.location.hash)
      headroom.unpin();
    $(header).addClass('headroom--transition');

    // offset scroll location for banner on hash change
    // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
    window.addEventListener("hashchange", function(event) {
      window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
    });

    // responsive menu
    $('.distill-site-header').each(function(i, val) {
      var topnav = $(this);
      var toggle = topnav.find('.nav-toggle');
      toggle.on('click', function() {
        topnav.toggleClass('responsive');
      });
    });

    // nav dropdowns
    $('.nav-dropbtn').click(function(e) {
      $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
      $(this).parent().siblings('.nav-dropdown')
         .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $("body").click(function(e){
      $('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $(".nav-dropdown").click(function(e){
      e.stopPropagation();
    });
  });
</script>

<style type="text/css">

/* Theme (user-documented overrideables for nav appearance) */

.distill-site-nav {
  color: rgba(255, 255, 255, 0.8);
  background-color: #0F2E3D;
  font-size: 15px;
  font-weight: 300;
}

.distill-site-nav a {
  color: inherit;
  text-decoration: none;
}

.distill-site-nav a:hover {
  color: white;
}

@media print {
  .distill-site-nav {
    display: none;
  }
}

.distill-site-header {

}

.distill-site-footer {

}


/* Site Header */

.distill-site-header {
  width: 100%;
  box-sizing: border-box;
  z-index: 3;
}

.distill-site-header .nav-left {
  display: inline-block;
  margin-left: 8px;
}

@media screen and (max-width: 768px) {
  .distill-site-header .nav-left {
    margin-left: 0;
  }
}


.distill-site-header .nav-right {
  float: right;
  margin-right: 8px;
}

.distill-site-header a,
.distill-site-header .title {
  display: inline-block;
  text-align: center;
  padding: 14px 10px 14px 10px;
}

.distill-site-header .title {
  font-size: 18px;
  min-width: 150px;
}

.distill-site-header .logo {
  padding: 0;
}

.distill-site-header .logo img {
  display: none;
  max-height: 20px;
  width: auto;
  margin-bottom: -4px;
}

.distill-site-header .nav-image img {
  max-height: 18px;
  width: auto;
  display: inline-block;
  margin-bottom: -3px;
}



@media screen and (min-width: 1000px) {
  .distill-site-header .logo img {
    display: inline-block;
  }
  .distill-site-header .nav-left {
    margin-left: 20px;
  }
  .distill-site-header .nav-right {
    margin-right: 20px;
  }
  .distill-site-header .title {
    padding-left: 12px;
  }
}


.distill-site-header .nav-toggle {
  display: none;
}

.nav-dropdown {
  display: inline-block;
  position: relative;
}

.nav-dropdown .nav-dropbtn {
  border: none;
  outline: none;
  color: rgba(255, 255, 255, 0.8);
  padding: 16px 10px;
  background-color: transparent;
  font-family: inherit;
  font-size: inherit;
  font-weight: inherit;
  margin: 0;
  margin-top: 1px;
  z-index: 2;
}

.nav-dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: 200px;
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: 4px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
  z-index: 1;
  margin-top: 2px;
  white-space: nowrap;
  padding-top: 4px;
  padding-bottom: 4px;
}

.nav-dropdown-content hr {
  margin-top: 4px;
  margin-bottom: 4px;
  border: none;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.nav-dropdown-active {
  display: block;
}

.nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
  color: black;
  padding: 6px 24px;
  text-decoration: none;
  display: block;
  text-align: left;
}

.nav-dropdown-content .nav-dropdown-header {
  display: block;
  padding: 5px 24px;
  padding-bottom: 0;
  text-transform: uppercase;
  font-size: 14px;
  color: #999999;
  white-space: nowrap;
}

.nav-dropdown:hover .nav-dropbtn {
  color: white;
}

.nav-dropdown-content a:hover {
  background-color: #ddd;
  color: black;
}

.nav-right .nav-dropdown-content {
  margin-left: -45%;
  right: 0;
}

@media screen and (max-width: 768px) {
  .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
  .distill-site-header a.nav-toggle {
    float: right;
    display: block;
  }
  .distill-site-header .title {
    margin-left: 0;
  }
  .distill-site-header .nav-right {
    margin-right: 0;
  }
  .distill-site-header {
    overflow: hidden;
  }
  .nav-right .nav-dropdown-content {
    margin-left: 0;
  }
}


@media screen and (max-width: 768px) {
  .distill-site-header.responsive {position: relative; min-height: 500px; }
  .distill-site-header.responsive a.nav-toggle {
    position: absolute;
    right: 0;
    top: 0;
  }
  .distill-site-header.responsive a,
  .distill-site-header.responsive .nav-dropdown {
    display: block;
    text-align: left;
  }
  .distill-site-header.responsive .nav-left,
  .distill-site-header.responsive .nav-right {
    width: 100%;
  }
  .distill-site-header.responsive .nav-dropdown {float: none;}
  .distill-site-header.responsive .nav-dropdown-content {position: relative;}
  .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
    display: block;
    width: 100%;
    text-align: left;
  }
}

/* Site Footer */

.distill-site-footer {
  width: 100%;
  overflow: hidden;
  box-sizing: border-box;
  z-index: 3;
  margin-top: 30px;
  padding-top: 30px;
  padding-bottom: 30px;
  text-align: center;
}

/* Headroom */

d-title {
  padding-top: 6rem;
}

@media print {
  d-title {
    padding-top: 4rem;
  }
}

.headroom {
  z-index: 1000;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
}

.headroom--transition {
  transition: all .4s ease-in-out;
}

.headroom--unpinned {
  top: -100px;
}

.headroom--pinned {
  top: 0;
}

/* adjust viewport for navbar height */
/* helps vertically center bootstrap (non-distill) content */
.min-vh-100 {
  min-height: calc(100vh - 100px) !important;
}

</style>

<script src="../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../../site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet"/>
<link href="../../site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet"/>
<script src="../../site_libs/headroom-0.9.4/headroom.min.js"></script>
<script src="../../site_libs/autocomplete-0.37.1/autocomplete.min.js"></script>
<script src="../../site_libs/fuse-6.4.1/fuse.min.js"></script>

<script type="application/javascript">

function getMeta(metaName) {
  var metas = document.getElementsByTagName('meta');
  for (let i = 0; i < metas.length; i++) {
    if (metas[i].getAttribute('name') === metaName) {
      return metas[i].getAttribute('content');
    }
  }
  return '';
}

function offsetURL(url) {
  var offset = getMeta('distill:offset');
  return offset ? offset + '/' + url : url;
}

function createFuseIndex() {

  // create fuse index
  var options = {
    keys: [
      { name: 'title', weight: 20 },
      { name: 'categories', weight: 15 },
      { name: 'description', weight: 10 },
      { name: 'contents', weight: 5 },
    ],
    ignoreLocation: true,
    threshold: 0
  };
  var fuse = new window.Fuse([], options);

  // fetch the main search.json
  return fetch(offsetURL('search.json'))
    .then(function(response) {
      if (response.status == 200) {
        return response.json().then(function(json) {
          // index main articles
          json.articles.forEach(function(article) {
            fuse.add(article);
          });
          // download collections and index their articles
          return Promise.all(json.collections.map(function(collection) {
            return fetch(offsetURL(collection)).then(function(response) {
              if (response.status === 200) {
                return response.json().then(function(articles) {
                  articles.forEach(function(article) {
                    fuse.add(article);
                  });
                })
              } else {
                return Promise.reject(
                  new Error('Unexpected status from search index request: ' +
                            response.status)
                );
              }
            });
          })).then(function() {
            return fuse;
          });
        });

      } else {
        return Promise.reject(
          new Error('Unexpected status from search index request: ' +
                      response.status)
        );
      }
    });
}

window.document.addEventListener("DOMContentLoaded", function (event) {

  // get search element (bail if we don't have one)
  var searchEl = window.document.getElementById('distill-search');
  if (!searchEl)
    return;

  createFuseIndex()
    .then(function(fuse) {

      // make search box visible
      searchEl.classList.remove('hidden');

      // initialize autocomplete
      var options = {
        autoselect: true,
        hint: false,
        minLength: 2,
      };
      window.autocomplete(searchEl, options, [{
        source: function(query, callback) {
          const searchOptions = {
            isCaseSensitive: false,
            shouldSort: true,
            minMatchCharLength: 2,
            limit: 10,
          };
          var results = fuse.search(query, searchOptions);
          callback(results
            .map(function(result) { return result.item; })
          );
        },
        templates: {
          suggestion: function(suggestion) {
            var img = suggestion.preview && Object.keys(suggestion.preview).length > 0
              ? `<img src="${offsetURL(suggestion.preview)}"</img>`
              : '';
            var html = `
              <div class="search-item">
                <h3>${suggestion.title}</h3>
                <div class="search-item-description">
                  ${suggestion.description || ''}
                </div>
                <div class="search-item-preview">
                  ${img}
                </div>
              </div>
            `;
            return html;
          }
        }
      }]).on('autocomplete:selected', function(event, suggestion) {
        window.location.href = offsetURL(suggestion.path);
      });
      // remove inline display style on autocompleter (we want to
      // manage responsive display via css)
      $('.algolia-autocomplete').css("display", "");
    })
    .catch(function(error) {
      console.log(error);
    });

});

</script>

<style type="text/css">

.nav-search {
  font-size: x-small;
}

/* Algolioa Autocomplete */

.algolia-autocomplete {
  display: inline-block;
  margin-left: 10px;
  vertical-align: sub;
  background-color: white;
  color: black;
  padding: 6px;
  padding-top: 8px;
  padding-bottom: 0;
  border-radius: 6px;
  border: 1px #0F2E3D solid;
  width: 180px;
}


@media screen and (max-width: 768px) {
  .distill-site-nav .algolia-autocomplete {
    display: none;
    visibility: hidden;
  }
  .distill-site-nav.responsive .algolia-autocomplete {
    display: inline-block;
    visibility: visible;
  }
  .distill-site-nav.responsive .algolia-autocomplete .aa-dropdown-menu {
    margin-left: 0;
    width: 400px;
    max-height: 400px;
  }
}

.algolia-autocomplete .aa-input, .algolia-autocomplete .aa-hint {
  width: 90%;
  outline: none;
  border: none;
}

.algolia-autocomplete .aa-hint {
  color: #999;
}
.algolia-autocomplete .aa-dropdown-menu {
  width: 550px;
  max-height: 70vh;
  overflow-x: visible;
  overflow-y: scroll;
  padding: 5px;
  margin-top: 3px;
  margin-left: -150px;
  background-color: #fff;
  border-radius: 5px;
  border: 1px solid #999;
  border-top: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion {
  cursor: pointer;
  padding: 5px 4px;
  border-bottom: 1px solid #eee;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion:last-of-type {
  border-bottom: none;
  margin-bottom: 2px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item {
  overflow: hidden;
  font-size: 0.8em;
  line-height: 1.4em;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item h3 {
  font-size: 1rem;
  margin-block-start: 0;
  margin-block-end: 5px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-description {
  display: inline-block;
  overflow: hidden;
  height: 2.8em;
  width: 80%;
  margin-right: 4%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview {
  display: inline-block;
  width: 15%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img {
  height: 3em;
  width: auto;
  display: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img[src] {
  display: initial;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion.aa-cursor {
  background-color: #eee;
}
.algolia-autocomplete .aa-dropdown-menu .aa-suggestion em {
  font-weight: bold;
  font-style: normal;
}

</style>


<!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

<style type="text/css">

body {
  background-color: white;
}

.pandoc-table {
  width: 100%;
}

.pandoc-table>caption {
  margin-bottom: 10px;
}

.pandoc-table th:not([align]) {
  text-align: left;
}

.pagedtable-footer {
  font-size: 15px;
}

d-byline .byline {
  grid-template-columns: 2fr 2fr;
}

d-byline .byline h3 {
  margin-block-start: 1.5em;
}

d-byline .byline .authors-affiliations h3 {
  margin-block-start: 0.5em;
}

.authors-affiliations .orcid-id {
  width: 16px;
  height:16px;
  margin-left: 4px;
  margin-right: 4px;
  vertical-align: middle;
  padding-bottom: 2px;
}

d-title .dt-tags {
  margin-top: 1em;
  grid-column: text;
}

.dt-tags .dt-tag {
  text-decoration: none;
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0em 0.4em;
  margin-right: 0.5em;
  margin-bottom: 0.4em;
  font-size: 70%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

d-article table.gt_table td,
d-article table.gt_table th {
  border-bottom: none;
  font-size: 100%;
}

.html-widget {
  margin-bottom: 2.0em;
}

.l-screen-inset {
  padding-right: 16px;
}

.l-screen .caption {
  margin-left: 10px;
}

.shaded {
  background: rgb(247, 247, 247);
  padding-top: 20px;
  padding-bottom: 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .html-widget {
  margin-bottom: 0;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .shaded-content {
  background: white;
}

.text-output {
  margin-top: 0;
  line-height: 1.5em;
}

.hidden {
  display: none !important;
}

d-article {
  padding-top: 2.5rem;
  padding-bottom: 30px;
}

d-appendix {
  padding-top: 30px;
}

d-article>p>img {
  width: 100%;
}

d-article h2 {
  margin: 1rem 0 1.5rem 0;
}

d-article h3 {
  margin-top: 1.5rem;
}

d-article iframe {
  border: 1px solid rgba(0, 0, 0, 0.1);
  margin-bottom: 2.0em;
  width: 100%;
}

/* Tweak code blocks */

d-article div.sourceCode code,
d-article pre code {
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
}

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: auto;
}

d-article div.sourceCode {
  background-color: white;
}

d-article div.sourceCode pre {
  padding-left: 10px;
  font-size: 12px;
  border-left: 2px solid rgba(0,0,0,0.1);
}

d-article pre {
  font-size: 12px;
  color: black;
  background: none;
  margin-top: 0;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

d-article pre a {
  border-bottom: none;
}

d-article pre a:hover {
  border-bottom: none;
  text-decoration: underline;
}

d-article details {
  grid-column: text;
  margin-bottom: 0.8em;
}

@media(min-width: 768px) {

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: visible !important;
}

d-article div.sourceCode pre {
  padding-left: 18px;
  font-size: 14px;
}

d-article pre {
  font-size: 14px;
}

}

figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

/* CSS for d-contents */

.d-contents {
  grid-column: text;
  color: rgba(0,0,0,0.8);
  font-size: 0.9em;
  padding-bottom: 1em;
  margin-bottom: 1em;
  padding-bottom: 0.5em;
  margin-bottom: 1em;
  padding-left: 0.25em;
  justify-self: start;
}

@media(min-width: 1000px) {
  .d-contents.d-contents-float {
    height: 0;
    grid-column-start: 1;
    grid-column-end: 4;
    justify-self: center;
    padding-right: 3em;
    padding-left: 2em;
  }
}

.d-contents nav h3 {
  font-size: 18px;
  margin-top: 0;
  margin-bottom: 1em;
}

.d-contents li {
  list-style-type: none
}

.d-contents nav > ul {
  padding-left: 0;
}

.d-contents ul {
  padding-left: 1em
}

.d-contents nav ul li {
  margin-top: 0.6em;
  margin-bottom: 0.2em;
}

.d-contents nav a {
  font-size: 13px;
  border-bottom: none;
  text-decoration: none
  color: rgba(0, 0, 0, 0.8);
}

.d-contents nav a:hover {
  text-decoration: underline solid rgba(0, 0, 0, 0.6)
}

.d-contents nav > ul > li > a {
  font-weight: 600;
}

.d-contents nav > ul > li > ul {
  font-weight: inherit;
}

.d-contents nav > ul > li > ul > li {
  margin-top: 0.2em;
}


.d-contents nav ul {
  margin-top: 0;
  margin-bottom: 0.25em;
}

.d-article-with-toc h2:nth-child(2) {
  margin-top: 0;
}


/* Figure */

.figure {
  position: relative;
  margin-bottom: 2.5em;
  margin-top: 1.5em;
}

.figure .caption {
  color: rgba(0, 0, 0, 0.6);
  font-size: 12px;
  line-height: 1.5em;
}

.figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

.figure .caption a {
  color: rgba(0, 0, 0, 0.6);
}

.figure .caption b,
.figure .caption strong, {
  font-weight: 600;
  color: rgba(0, 0, 0, 1.0);
}

/* Citations */

d-article .citation {
  color: inherit;
  cursor: inherit;
}

div.hanging-indent{
  margin-left: 1em; text-indent: -1em;
}

/* Citation hover box */

.tippy-box[data-theme~=light-border] {
  background-color: rgba(250, 250, 250, 0.95);
}

.tippy-content > p {
  margin-bottom: 0;
  padding: 2px;
}


/* Tweak 1000px media break to show more text */

@media(min-width: 1000px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 16px;
  }

  .grid {
    grid-column-gap: 16px;
  }

  d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
  }
  figure .caption, .figure .caption, figure figcaption {
    font-size: 13px;
  }
}

@media(min-width: 1180px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 32px;
  }

  .grid {
    grid-column-gap: 32px;
  }
}


/* Get the citation styles for the appendix (not auto-injected on render since
   we do our own rendering of the citation appendix) */

d-appendix .citation-appendix,
.d-appendix .citation-appendix {
  font-size: 11px;
  line-height: 15px;
  border-left: 1px solid rgba(0, 0, 0, 0.1);
  padding-left: 18px;
  border: 1px solid rgba(0,0,0,0.1);
  background: rgba(0, 0, 0, 0.02);
  padding: 10px 18px;
  border-radius: 3px;
  color: rgba(150, 150, 150, 1);
  overflow: hidden;
  margin-top: -12px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* Include appendix styles here so they can be overridden */

d-appendix {
  contain: layout style;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-top: 60px;
  margin-bottom: 0;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  color: rgba(0,0,0,0.5);
  padding-top: 60px;
  padding-bottom: 48px;
}

d-appendix h3 {
  grid-column: page-start / text-start;
  font-size: 15px;
  font-weight: 500;
  margin-top: 1em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.65);
}

d-appendix h3 + * {
  margin-top: 1em;
}

d-appendix ol {
  padding: 0 0 0 15px;
}

@media (min-width: 768px) {
  d-appendix ol {
    padding: 0 0 0 30px;
    margin-left: -30px;
  }
}

d-appendix li {
  margin-bottom: 1em;
}

d-appendix a {
  color: rgba(0, 0, 0, 0.6);
}

d-appendix > * {
  grid-column: text;
}

d-appendix > d-footnote-list,
d-appendix > d-citation-list,
d-appendix > distill-appendix {
  grid-column: screen;
}

/* Include footnote styles here so they can be overridden */

d-footnote-list {
  contain: layout style;
}

d-footnote-list > * {
  grid-column: text;
}

d-footnote-list a.footnote-backlink {
  color: rgba(0,0,0,0.3);
  padding-left: 0.5em;
}



/* Anchor.js */

.anchorjs-link {
  /*transition: all .25s linear; */
  text-decoration: none;
  border-bottom: none;
}
*:hover > .anchorjs-link {
  margin-left: -1.125em !important;
  text-decoration: none;
  border-bottom: none;
}

/* Social footer */

.social_footer {
  margin-top: 30px;
  margin-bottom: 0;
  color: rgba(0,0,0,0.67);
}

.disqus-comments {
  margin-right: 30px;
}

.disqus-comment-count {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  cursor: pointer;
}

#disqus_thread {
  margin-top: 30px;
}

.article-sharing a {
  border-bottom: none;
  margin-right: 8px;
}

.article-sharing a:hover {
  border-bottom: none;
}

.sidebar-section.subscribe {
  font-size: 12px;
  line-height: 1.6em;
}

.subscribe p {
  margin-bottom: 0.5em;
}


.article-footer .subscribe {
  font-size: 15px;
  margin-top: 45px;
}


.sidebar-section.custom {
  font-size: 12px;
  line-height: 1.6em;
}

.custom p {
  margin-bottom: 0.5em;
}

/* Styles for listing layout (hide title) */
.layout-listing d-title, .layout-listing .d-title {
  display: none;
}

/* Styles for posts lists (not auto-injected) */


.posts-with-sidebar {
  padding-left: 45px;
  padding-right: 45px;
}

.posts-list .description h2,
.posts-list .description p {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
}

.posts-list .description h2 {
  font-weight: 700;
  border-bottom: none;
  padding-bottom: 0;
}

.posts-list h2.post-tag {
  border-bottom: 1px solid rgba(0, 0, 0, 0.2);
  padding-bottom: 12px;
}
.posts-list {
  margin-top: 60px;
  margin-bottom: 24px;
}

.posts-list .post-preview {
  text-decoration: none;
  overflow: hidden;
  display: block;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  padding: 24px 0;
}

.post-preview-last {
  border-bottom: none !important;
}

.posts-list .posts-list-caption {
  grid-column: screen;
  font-weight: 400;
}

.posts-list .post-preview h2 {
  margin: 0 0 6px 0;
  line-height: 1.2em;
  font-style: normal;
  font-size: 24px;
}

.posts-list .post-preview p {
  margin: 0 0 12px 0;
  line-height: 1.4em;
  font-size: 16px;
}

.posts-list .post-preview .thumbnail {
  box-sizing: border-box;
  margin-bottom: 24px;
  position: relative;
  max-width: 500px;
}
.posts-list .post-preview img {
  width: 100%;
  display: block;
}

.posts-list .metadata {
  font-size: 12px;
  line-height: 1.4em;
  margin-bottom: 18px;
}

.posts-list .metadata > * {
  display: inline-block;
}

.posts-list .metadata .publishedDate {
  margin-right: 2em;
}

.posts-list .metadata .dt-authors {
  display: block;
  margin-top: 0.3em;
  margin-right: 2em;
}

.posts-list .dt-tags {
  display: block;
  line-height: 1em;
}

.posts-list .dt-tags .dt-tag {
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0.3em 0.4em;
  margin-right: 0.2em;
  margin-bottom: 0.4em;
  font-size: 60%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

.posts-list img {
  opacity: 1;
}

.posts-list img[data-src] {
  opacity: 0;
}

.posts-more {
  clear: both;
}


.posts-sidebar {
  font-size: 16px;
}

.posts-sidebar h3 {
  font-size: 16px;
  margin-top: 0;
  margin-bottom: 0.5em;
  font-weight: 400;
  text-transform: uppercase;
}

.sidebar-section {
  margin-bottom: 30px;
}

.categories ul {
  list-style-type: none;
  margin: 0;
  padding: 0;
}

.categories li {
  color: rgba(0, 0, 0, 0.8);
  margin-bottom: 0;
}

.categories li>a {
  border-bottom: none;
}

.categories li>a:hover {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
}

.categories .active {
  font-weight: 600;
}

.categories .category-count {
  color: rgba(0, 0, 0, 0.4);
}


@media(min-width: 768px) {
  .posts-list .post-preview h2 {
    font-size: 26px;
  }
  .posts-list .post-preview .thumbnail {
    float: right;
    width: 30%;
    margin-bottom: 0;
  }
  .posts-list .post-preview .description {
    float: left;
    width: 45%;
  }
  .posts-list .post-preview .metadata {
    float: left;
    width: 20%;
    margin-top: 8px;
  }
  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.5em;
    font-size: 16px;
  }
  .posts-with-sidebar .posts-list {
    float: left;
    width: 75%;
  }
  .posts-with-sidebar .posts-sidebar {
    float: right;
    width: 20%;
    margin-top: 60px;
    padding-top: 24px;
    padding-bottom: 24px;
  }
}


/* Improve display for browsers without grid (IE/Edge <= 15) */

.downlevel {
  line-height: 1.6em;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  margin: 0;
}

.downlevel .d-title {
  padding-top: 6rem;
  padding-bottom: 1.5rem;
}

.downlevel .d-title h1 {
  font-size: 50px;
  font-weight: 700;
  line-height: 1.1em;
  margin: 0 0 0.5rem;
}

.downlevel .d-title p {
  font-weight: 300;
  font-size: 1.2rem;
  line-height: 1.55em;
  margin-top: 0;
}

.downlevel .d-byline {
  padding-top: 0.8em;
  padding-bottom: 0.8em;
  font-size: 0.8rem;
  line-height: 1.8em;
}

.downlevel .section-separator {
  border: none;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.downlevel .d-article {
  font-size: 1.06rem;
  line-height: 1.7em;
  padding-top: 1rem;
  padding-bottom: 2rem;
}


.downlevel .d-appendix {
  padding-left: 0;
  padding-right: 0;
  max-width: none;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.5);
  padding-top: 40px;
  padding-bottom: 48px;
}

.downlevel .footnotes ol {
  padding-left: 13px;
}

.downlevel .base-grid,
.downlevel .distill-header,
.downlevel .d-title,
.downlevel .d-abstract,
.downlevel .d-article,
.downlevel .d-appendix,
.downlevel .distill-appendix,
.downlevel .d-byline,
.downlevel .d-footnote-list,
.downlevel .d-citation-list,
.downlevel .distill-footer,
.downlevel .appendix-bottom,
.downlevel .posts-container {
  padding-left: 40px;
  padding-right: 40px;
}

@media(min-width: 768px) {
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
  padding-left: 150px;
  padding-right: 150px;
  max-width: 900px;
}
}

.downlevel pre code {
  display: block;
  border-left: 2px solid rgba(0, 0, 0, .1);
  padding: 0 0 0 20px;
  font-size: 14px;
}

.downlevel code, .downlevel pre {
  color: black;
  background: none;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

.downlevel .posts-list .post-preview {
  color: inherit;
}



</style>

<script type="application/javascript">

function is_downlevel_browser() {
  if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                 window.navigator.userAgent)) {
    return true;
  } else {
    return window.load_distill_framework === undefined;
  }
}

// show body when load is complete
function on_load_complete() {

  // add anchors
  if (window.anchors) {
    window.anchors.options.placement = 'left';
    window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
  }


  // set body to visible
  document.body.style.visibility = 'visible';

  // force redraw for leaflet widgets
  if (window.HTMLWidgets) {
    var maps = window.HTMLWidgets.findAll(".leaflet");
    $.each(maps, function(i, el) {
      var map = this.getMap();
      map.invalidateSize();
      map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer)
          layer.redraw();
      });
    });
  }

  // trigger 'shown' so htmlwidgets resize
  $('d-article').trigger('shown');
}

function init_distill() {

  init_common();

  // create front matter
  var front_matter = $('<d-front-matter></d-front-matter>');
  $('#distill-front-matter').wrap(front_matter);

  // create d-title
  $('.d-title').changeElementType('d-title');

  // create d-byline
  var byline = $('<d-byline></d-byline>');
  $('.d-byline').replaceWith(byline);

  // create d-article
  var article = $('<d-article></d-article>');
  $('.d-article').wrap(article).children().unwrap();

  // move posts container into article
  $('.posts-container').appendTo($('d-article'));

  // create d-appendix
  $('.d-appendix').changeElementType('d-appendix');

  // flag indicating that we have appendix items
  var appendix = $('.appendix-bottom').children('h3').length > 0;

  // replace footnotes with <d-footnote>
  $('.footnote-ref').each(function(i, val) {
    appendix = true;
    var href = $(this).attr('href');
    var id = href.replace('#', '');
    var fn = $('#' + id);
    var fn_p = $('#' + id + '>p');
    fn_p.find('.footnote-back').remove();
    var text = fn_p.html();
    var dtfn = $('<d-footnote></d-footnote>');
    dtfn.html(text);
    $(this).replaceWith(dtfn);
  });
  // remove footnotes
  $('.footnotes').remove();

  // move refs into #references-listing
  $('#references-listing').replaceWith($('#refs'));

  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    var id = $(this).attr('id');
    $('.d-contents a[href="#' + id + '"]').parent().remove();
    appendix = true;
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
  });

  // show d-appendix if we have appendix content
  $("d-appendix").css('display', appendix ? 'grid' : 'none');

  // localize layout chunks to just output
  $('.layout-chunk').each(function(i, val) {

    // capture layout
    var layout = $(this).attr('data-layout');

    // apply layout to markdown level block elements
    var elements = $(this).children().not('details, div.sourceCode, pre, script');
    elements.each(function(i, el) {
      var layout_div = $('<div class="' + layout + '"></div>');
      if (layout_div.hasClass('shaded')) {
        var shaded_content = $('<div class="shaded-content"></div>');
        $(this).wrap(shaded_content);
        $(this).parent().wrap(layout_div);
      } else {
        $(this).wrap(layout_div);
      }
    });


    // unwrap the layout-chunk div
    $(this).children().unwrap();
  });

  // remove code block used to force  highlighting css
  $('.distill-force-highlighting-css').parent().remove();

  // remove empty line numbers inserted by pandoc when using a
  // custom syntax highlighting theme
  $('code.sourceCode a:empty').remove();

  // load distill framework
  load_distill_framework();

  // wait for window.distillRunlevel == 4 to do post processing
  function distill_post_process() {

    if (!window.distillRunlevel || window.distillRunlevel < 4)
      return;

    // hide author/affiliations entirely if we have no authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
    if (!have_authors)
      $('d-byline').addClass('hidden');

    // article with toc class
    $('.d-contents').parent().addClass('d-article-with-toc');

    // strip links that point to #
    $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

    // add orcid ids
    $('.authors-affiliations').find('.author').each(function(i, el) {
      var orcid_id = front_matter.authors[i].orcidID;
      if (orcid_id) {
        var a = $('<a></a>');
        a.attr('href', 'https://orcid.org/' + orcid_id);
        var img = $('<img></img>');
        img.addClass('orcid-id');
        img.attr('alt', 'ORCID ID');
        img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
        a.append(img);
        $(this).append(a);
      }
    });

    // hide elements of author/affiliations grid that have no value
    function hide_byline_column(caption) {
      $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
    }

    // affiliations
    var have_affiliations = false;
    for (var i = 0; i<front_matter.authors.length; ++i) {
      var author = front_matter.authors[i];
      if (author.affiliation !== "&nbsp;") {
        have_affiliations = true;
        break;
      }
    }
    if (!have_affiliations)
      $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

    // published date
    if (!front_matter.publishedDate)
      hide_byline_column("Published");

    // document object identifier
    var doi = $('d-byline').find('h3:contains("DOI")');
    var doi_p = doi.next().empty();
    if (!front_matter.doi) {
      // if we have a citation and valid citationText then link to that
      if ($('#citation').length > 0 && front_matter.citationText) {
        doi.html('Citation');
        $('<a href="#citation"></a>')
          .text(front_matter.citationText)
          .appendTo(doi_p);
      } else {
        hide_byline_column("DOI");
      }
    } else {
      $('<a></a>')
         .attr('href', "https://doi.org/" + front_matter.doi)
         .html(front_matter.doi)
         .appendTo(doi_p);
    }

     // change plural form of authors/affiliations
    if (front_matter.authors.length === 1) {
      var grid = $('.authors-affiliations');
      grid.children('h3:contains("Authors")').text('Author');
      grid.children('h3:contains("Affiliations")').text('Affiliation');
    }

    // remove d-appendix and d-footnote-list local styles
    $('d-appendix > style:first-child').remove();
    $('d-footnote-list > style:first-child').remove();

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // hoverable references
    $('span.citation[data-cites]').each(function() {
      const citeChild = $(this).children()[0]
      // Do not process if @xyz has been used without escaping and without bibliography activated
      // https://github.com/rstudio/distill/issues/466
      if (citeChild === undefined) return true

      if (citeChild.nodeName == "D-FOOTNOTE") {
        var fn = citeChild
        $(this).html(fn.shadowRoot.querySelector("sup"))
        $(this).id = fn.id
        fn.remove()
      }
      var refs = $(this).attr('data-cites').split(" ");
      var refHtml = refs.map(function(ref) {
        // Could use CSS.escape too here, we insure backward compatibility in navigator
        return "<p>" + $('div[id="ref-' + ref + '"]').html() + "</p>";
      }).join("\n");
      window.tippy(this, {
        allowHTML: true,
        content: refHtml,
        maxWidth: 500,
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start'
      });
    });

    // fix footnotes in tables (#411)
    // replacing broken distill.pub feature
    $('table d-footnote').each(function() {
      // we replace internal showAtNode methode which is triggered when hovering a footnote
      this.hoverBox.showAtNode = function(node) {
        // ported from https://github.com/distillpub/template/pull/105/files
        calcOffset = function(elem) {
            let x = elem.offsetLeft;
            let y = elem.offsetTop;
            // Traverse upwards until an `absolute` element is found or `elem`
            // becomes null.
            while (elem = elem.offsetParent && elem.style.position != 'absolute') {
                x += elem.offsetLeft;
                y += elem.offsetTop;
            }

            return { left: x, top: y };
        }
        // https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/offsetTop
        const bbox = node.getBoundingClientRect();
        const offset = calcOffset(node);
        this.show([offset.left + bbox.width, offset.top + bbox.height]);
      }
    })

    // clear polling timer
    clearInterval(tid);

    // show body now that everything is ready
    on_load_complete();
  }

  var tid = setInterval(distill_post_process, 50);
  distill_post_process();

}

function init_downlevel() {

  init_common();

   // insert hr after d-title
  $('.d-title').after($('<hr class="section-separator"/>'));

  // check if we have authors
  var front_matter = JSON.parse($("#distill-front-matter").html());
  var have_authors = front_matter.authors && front_matter.authors.length > 0;

  // manage byline/border
  if (!have_authors)
    $('.d-byline').remove();
  $('.d-byline').after($('<hr class="section-separator"/>'));
  $('.d-byline a').remove();

  // remove toc
  $('.d-contents').remove();

  // move appendix elements
  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
  });


  // inject headers into references and footnotes
  var refs_header = $('<h3></h3>');
  refs_header.text('References');
  $('#refs').prepend(refs_header);

  var footnotes_header = $('<h3></h3');
  footnotes_header.text('Footnotes');
  $('.footnotes').children('hr').first().replaceWith(footnotes_header);

  // move appendix-bottom entries to the bottom
  $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
  $('.appendix-bottom').remove();

  // remove appendix if it's empty
  if ($('.d-appendix').children().length === 0)
    $('.d-appendix').remove();

  // prepend separator above appendix
  $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

  // trim code
  $('pre>code').each(function(i, val) {
    $(this).html($.trim($(this).html()));
  });

  // move posts-container right before article
  $('.posts-container').insertBefore($('.d-article'));

  $('body').addClass('downlevel');

  on_load_complete();
}


function init_common() {

  // jquery plugin to change element types
  (function($) {
    $.fn.changeElementType = function(newType) {
      var attrs = {};

      $.each(this[0].attributes, function(idx, attr) {
        attrs[attr.nodeName] = attr.nodeValue;
      });

      this.replaceWith(function() {
        return $("<" + newType + "/>", attrs).append($(this).contents());
      });
    };
  })(jQuery);

  // prevent underline for linked images
  $('a > img').parent().css({'border-bottom' : 'none'});

  // mark non-body figures created by knitr chunks as 100% width
  $('.layout-chunk').each(function(i, val) {
    var figures = $(this).find('img, .html-widget');
    // ignore leaflet img layers (#106)
    figures = figures.filter(':not(img[class*="leaflet"])')
    if ($(this).attr('data-layout') !== "l-body") {
      figures.css('width', '100%');
    } else {
      figures.css('max-width', '100%');
      figures.filter("[width]").each(function(i, val) {
        var fig = $(this);
        fig.css('width', fig.attr('width') + 'px');
      });

    }
  });

  // auto-append index.html to post-preview links in file: protocol
  // and in rstudio ide preview
  $('.post-preview').each(function(i, val) {
    if (window.location.protocol === "file:")
      $(this).attr('href', $(this).attr('href') + "index.html");
  });

  // get rid of index.html references in header
  if (window.location.protocol !== "file:") {
    $('.distill-site-header a[href]').each(function(i,val) {
      $(this).attr('href', $(this).attr('href').replace(/^index[.]html/, "./"));
    });
  }

  // add class to pandoc style tables
  $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
  $('.kable-table').children('table').addClass('pandoc-table');

  // add figcaption style to table captions
  $('caption').parent('table').addClass("figcaption");

  // initialize posts list
  if (window.init_posts_list)
    window.init_posts_list();

  // implmement disqus comment link
  $('.disqus-comment-count').click(function() {
    window.headroom_prevent_pin = true;
    $('#disqus_thread').toggleClass('hidden');
    if (!$('#disqus_thread').hasClass('hidden')) {
      var offset = $(this).offset();
      $(window).resize();
      $('html, body').animate({
        scrollTop: offset.top - 35
      });
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  if (is_downlevel_browser())
    init_downlevel();
  else
    window.addEventListener('WebComponentsReady', init_distill);
});

</script>

<style type="text/css">
/* base variables */

/* Edit the CSS properties in this file to create a custom
   Distill theme. Only edit values in the right column
   for each row; values shown are the CSS defaults.
   To return any property to the default,
   you may set its value to: unset
   All rows must end with a semi-colon.                      */

/* Optional: embed custom fonts here with `@import`          */
/* This must remain at the top of this file.                 */



html {
  /*-- Main font sizes --*/
  --title-size:      50px;
  --body-size:       1.06rem;
  --code-size:       14px;
  --aside-size:      12px;
  --fig-cap-size:    13px;
  /*-- Main font colors --*/
  --title-color:     #000000;
  --header-color:    rgba(0, 0, 0, 0.8);
  --body-color:      rgba(0, 0, 0, 0.8);
  --aside-color:     rgba(0, 0, 0, 0.6);
  --fig-cap-color:   rgba(0, 0, 0, 0.6);
  /*-- Specify custom fonts ~~~ must be imported above   --*/
  --heading-font:    sans-serif;
  --mono-font:       monospace;
  --body-font:       sans-serif;
  --navbar-font:     sans-serif;  /* websites + blogs only */
}

/*-- ARTICLE METADATA --*/
d-byline {
  --heading-size:    0.6rem;
  --heading-color:   rgba(0, 0, 0, 0.5);
  --body-size:       0.8rem;
  --body-color:      rgba(0, 0, 0, 0.8);
}

/*-- ARTICLE TABLE OF CONTENTS --*/
.d-contents {
  --heading-size:    18px;
  --contents-size:   13px;
}

/*-- ARTICLE APPENDIX --*/
d-appendix {
  --heading-size:    15px;
  --heading-color:   rgba(0, 0, 0, 0.65);
  --text-size:       0.8em;
  --text-color:      rgba(0, 0, 0, 0.5);
}

/*-- WEBSITE HEADER + FOOTER --*/
/* These properties only apply to Distill sites and blogs  */

.distill-site-header {
  --title-size:       18px;
  --text-color:       rgba(255, 255, 255, 0.8);
  --text-size:        15px;
  --hover-color:      white;
  --bkgd-color:       #0F2E3D;
}

.distill-site-footer {
  --text-color:       rgba(255, 255, 255, 0.8);
  --text-size:        15px;
  --hover-color:      white;
  --bkgd-color:       #0F2E3D;
}

/*-- Additional custom styles --*/
/* Add any additional CSS rules below                      */
</style>
<style type="text/css">
/* base variables */

/* Edit the CSS properties in this file to create a custom
   Distill theme. Only edit values in the right column
   for each row; values shown are the CSS defaults.
   To return any property to the default,
   you may set its value to: unset
   All rows must end with a semi-colon.                      */

/* Optional: embed custom fonts here with `@import`          */
/* This must remain at the top of this file.                 */

@import url('https://assets.ipums.org/_css/font-faces.css');

html {
  /*-- Main font sizes --*/
  --title-size:      50px;
  --body-size:       1.06rem;
  --code-size:       14px;
  --aside-size:      12px;
  --fig-cap-size:    13px;
  /*-- Main font colors --*/
  --title-color:     #00263A;
  --header-color:    #00263A;
  --body-color:      #00263A;
  --aside-color:     rgba(0, 0, 0, 0.6);
  --fig-cap-color:   rgba(0, 0, 0, 0.6);
  /*-- Specify custom fonts ~~~ must be imported above   --*/
  --heading-font:    cabrito_sans_norm_regular;
  --mono-font:       Menlo, Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  --body-font:       cabrito_sans_norm_regular;
  --navbar-font:     cabrito_sans_norm_regular;  /* websites + blogs only */
}

/*-- ARTICLE METADATA --*/
d-byline {
  --heading-size:    0.6rem;
  --heading-color:   rgba(0, 0, 0, 0.5);
  --body-size:       0.8rem;
  --body-color:      rgba(0, 0, 0, 0.8);
}

/*-- ARTICLE TABLE OF CONTENTS --*/
.d-contents {
  --heading-size:    18px;
  --contents-size:   13px;
}

/*-- ARTICLE APPENDIX --*/
d-appendix {
  --heading-size:    15px;
  --heading-color:   rgba(0, 0, 0, 0.65);
  --text-size:       0.8em;
  --text-color:      rgba(0, 0, 0, 0.5);
}

/*-- WEBSITE HEADER + FOOTER --*/
/* These properties only apply to Distill sites and blogs  */

.distill-site-header {
  --title-size:       18px;
  --text-color:       rgba(255, 255, 255, 0.8);
  --text-size:        15px;
  --hover-color:      white;
  --bkgd-color:       #00263A;
}

.distill-site-footer {
  --text-color:       rgba(255, 255, 255, 0.8);
  --text-size:        15px;
  --hover-color:      white;
  --bkgd-color:       #00263A;
}

/*-- Additional custom styles --*/
/* Add any additional CSS rules below                      */

h1{
  font-family: 'cabrito_sans_norm_regular';
  text-transform: uppercase;
  color: #00263A;
}

d-title h1{
  font-weight: 500;
}

d-article h1{
  font-size: 36px;
  line-height: 1.1em;
  font-weight: 100;
}

d-article h2{
    font-size: 30px;
    font-family: "cabrito_sans_cond_demi";
    text-transform: uppercase;
    color: #00263A;
    font-weight: 100;
}

d-article h3{
  font-size: 26px;
  font-family: 'cabrito_sans_cond_demi';
  color: #00263A;
  margin-top: 1.5rem;
  margin-bottom: 1em;
  font-weight: 100;
}

d-article h4{
  font-size: 24px;
  font-family: 'cabrito_sans_norm_regular';
  color: #00263A;
  text-transform: unset;
  margin-top: 1.5rem;
  margin-bottom: 1em;
  font-weight: 100;
}

d-article h5{
  font-size: 24px;
  font-family: 'cabrito_sans_cond_demi';
  color: #00263A;
  margin-top: 1.5rem;
  margin-bottom: 1em;
  font-weight: 100;
}

d-article li {
    margin-bottom: 0;
    margin-left: 1rem;
    padding-left: 0;
    color: #00263A;
}

d-article table {
    color: #00263A;
}
.d-contents nav > ul > li > a {
    font-weight: 100;
}

body{
  font-family: 'cabrito_subset';
}

b, strong {
  font-family: "cabrito_sans_cond_demi";
  font-weight: 100;
}

p>a {
    color: #98579B
}

li>a {
    color: #98579B;
}

.btn {
    font-family: "cabrito_subset";
    font-size: 16px;
    background-color: #F0E6F0;
    margin-bottom: 20px;
    border-width: 1px;
    padding-top: 6px;
    padding-bottom: 6px;
    cursor: pointer;
}

.distill-site-header .title {
    text-transform: uppercase;
    line-height: 38px;
    vertical-align: middle;
}

.distill-site-header .logo img{
  max-height: 50px; /* Makes logo bigger, default was 20px */
  vertical-align: middle;
  margin-bottom: 0;
}

.distill-site-header .nav-right {
    float: right;
    line-height: 38px;
    vertical-align: middle;
}

.distill-site-header .nav-left {
    display: inline-block;
    line-height: 38px;
    vertical-align: middle;
}

.algolia-autocomplete {
  line-height: 25px;
}

d-article iframe {
    border: 0;
    margin-bottom: 0;
    width: 100%;
}

d-article aside a {
  color: #98579B;
}

@media(max-width: 767px){
  aside{
    width: 50%;
    position: relative;
    left: 25%;
    padding-bottom: 20px;
  }
}

code {
  font-family: Menlo, Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
}

/* Prevent leaflet widgets from appearing above navbar */ 
.header {
  z-index: 1001;
}</style>
<style type="text/css">
/* base style */

/* FONT FAMILIES */

:root {
  --heading-default: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  --mono-default: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  --body-default: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
}

body,
.posts-list .post-preview p,
.posts-list .description p {
  font-family: var(--body-font), var(--body-default);
}

h1, h2, h3, h4, h5, h6,
.posts-list .post-preview h2,
.posts-list .description h2 {
  font-family: var(--heading-font), var(--heading-default);
}

d-article div.sourceCode code,
d-article pre code {
  font-family: var(--mono-font), var(--mono-default);
}


/*-- TITLE --*/
d-title h1,
.posts-list > h1 {
  color: var(--title-color, black);
}

d-title h1 {
  font-size: var(--title-size, 50px);
}

/*-- HEADERS --*/
d-article h1,
d-article h2,
d-article h3,
d-article h4,
d-article h5,
d-article h6 {
  color: var(--header-color, rgba(0, 0, 0, 0.8));
}

/*-- BODY --*/
d-article > p,  /* only text inside of <p> tags */
d-article > ul, /* lists */
d-article > ol {
  color: var(--body-color, rgba(0, 0, 0, 0.8));
  font-size: var(--body-size, 1.06rem);
}


/*-- CODE --*/
d-article div.sourceCode code,
d-article pre code {
  font-size: var(--code-size, 14px);
}

/*-- ASIDE --*/
d-article aside {
  font-size: var(--aside-size, 12px);
  color: var(--aside-color, rgba(0, 0, 0, 0.6));
}

/*-- FIGURE CAPTIONS --*/
figure .caption,
figure figcaption,
.figure .caption {
  font-size: var(--fig-cap-size, 13px);
  color: var(--fig-cap-color, rgba(0, 0, 0, 0.6));
}

/*-- METADATA --*/
d-byline h3 {
  font-size: var(--heading-size, 0.6rem);
  color: var(--heading-color, rgba(0, 0, 0, 0.5));
}

d-byline {
  font-size: var(--body-size, 0.8rem);
  color: var(--body-color, rgba(0, 0, 0, 0.8));
}

d-byline a,
d-article d-byline a {
  color: var(--body-color, rgba(0, 0, 0, 0.8));
}

/*-- TABLE OF CONTENTS --*/
.d-contents nav h3 {
  font-size: var(--heading-size, 18px);
}

.d-contents nav a {
  font-size: var(--contents-size, 13px);
}

/*-- APPENDIX --*/
d-appendix h3 {
  font-size: var(--heading-size, 15px);
  color: var(--heading-color, rgba(0, 0, 0, 0.65));
}

d-appendix {
  font-size: var(--text-size, 0.8em);
  color: var(--text-color, rgba(0, 0, 0, 0.5));
}

d-appendix d-footnote-list a.footnote-backlink {
  color: var(--text-color, rgba(0, 0, 0, 0.5));
}

/*-- WEBSITE HEADER + FOOTER --*/
.distill-site-header .title {
  font-size: var(--title-size, 18px);
  font-family: var(--navbar-font), var(--heading-default);
}

.distill-site-header a,
.nav-dropdown .nav-dropbtn {
  font-family: var(--navbar-font), var(--heading-default);
}

.nav-dropdown .nav-dropbtn {
  color: var(--text-color, rgba(255, 255, 255, 0.8));
  font-size: var(--text-size, 15px);
}

.distill-site-header a:hover,
.nav-dropdown:hover .nav-dropbtn {
  color: var(--hover-color, white);
}

.distill-site-header {
  font-size: var(--text-size, 15px);
  color: var(--text-color, rgba(255, 255, 255, 0.8));
  background-color: var(--bkgd-color, #0F2E3D);
}

.distill-site-footer {
  font-size: var(--text-size, 15px);
  color: var(--text-color, rgba(255, 255, 255, 0.8));
  background-color: var(--bkgd-color, #0F2E3D);
}

.distill-site-footer a:hover {
  color: var(--hover-color, white);
}</style>
<!--/radix_placeholder_distill-->
  <script src="../../site_libs/header-attrs-2.11/header-attrs.js"></script>
  <script src="../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
  <script src="../../site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="../../site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="../../site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="../../site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="../../site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="../../site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="../../site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="../../site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
<script type="text/javascript" cookie-consent="tracking" async src="https://www.googletagmanager.com/gtag/js?id=UA-191039907-2"></script>
<script type="text/javascript" cookie-consent="tracking">
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-191039907-2');
</script>
<!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"How to use CHIRPS Climate Data with PMA Nutrition Surveys","description":"Remotely sensed daily precipitation data is an incredible resource for understanding rainfed food systems.","authors":[{"author":"Matt Gunther","authorURL":"#","affiliation":"IPUMS PMA Senior Data Analyst","affiliationURL":"#","orcidID":""}],"publishedDate":"2021-10-15T00:00:00.000-04:00","citationText":"Gunther, 2021"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a class="logo" href="https://pma.ipums.org/pma/">
<img src="../../images/logo-white.png" alt="Logo"/>
</a>
<a href="../../index.html" class="title">Data Analysis Hub</a>
<input id="distill-search" class="nav-search hidden" type="text" placeholder="Search..."/>
</div>
<div class="nav-right">
<a href="../../index.html">Posts</a>
<div class="nav-dropdown">
<button class="nav-dropbtn">
Courses
 
<span class="down-arrow">&#x25BE;</span>
</button>
<div class="nav-dropdown-content">
<a href="../../introduction.html">Introduction to IPUMS PMA Data Analysis</a>
</div>
</div>
<div class="nav-dropdown">
<button class="nav-dropbtn">
R Tips
 
<span class="down-arrow">&#x25BE;</span>
</button>
<div class="nav-dropdown-content">
<a href="../../posts/2020-12-10-get-ipums-pma-data/index.html">Import IPUMS PMA Data into R</a>
<a href="../../posts/2020-12-10-get-r-and-packages/index.html">R, RStudio, and R Packages</a>
<a href="../../posts/2021-11-15-find-an-example/index.html">Find an Example</a>
</div>
</div>
<div class="nav-dropdown">
<button class="nav-dropbtn">
Community
 
<span class="down-arrow">&#x25BE;</span>
</button>
<div class="nav-dropdown-content">
<a href="../../CONTRIBUTING.html">Contributing guide</a>
<a href="../../CODE_OF_CONDUCT.html">Code of conduct</a>
<a href="../../LICENSE.html">License</a>
<a href="https://github.com/ipums/pma-data-hub/">GitHub</a>
</div>
</div>
<a href="../../about.html">About</a>
<a href="../../index.xml">
<i class="fa fa-rss" aria-hidden="true"></i>
</a>
<a href="https://twitter.com/ipumsGH">
<i class="fab fa-twitter" aria-hidden="true"></i>
</a>
<a href="https://github.com/ipums/pma-data-hub" aria-label="Link to source">
<i class="fab fa-github" aria-hidden="true"></i>
</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>How to use CHIRPS Climate Data with PMA Nutrition Surveys</h1>
<!--radix_placeholder_categories-->
<div class="dt-tags">
  <a href="../../index.html#category:Nutrition" class="dt-tag">Nutrition</a>
  <a href="../../index.html#category:CHIRPS" class="dt-tag">CHIRPS</a>
  <a href="../../index.html#category:Precipitation" class="dt-tag">Precipitation</a>
  <a href="../../index.html#category:Climate" class="dt-tag">Climate</a>
  <a href="../../index.html#category:Agriculture" class="dt-tag">Agriculture</a>
  <a href="../../index.html#category:terra" class="dt-tag">terra</a>
  <a href="../../index.html#category:sf" class="dt-tag">sf</a>
  <a href="../../index.html#category:ggspatial" class="dt-tag">ggspatial</a>
</div>
<!--/radix_placeholder_categories-->
<p><p>Remotely sensed daily precipitation data is an incredible resource for understanding rainfed food systems.</p></p>
</div>

<div class="d-byline">
  Matt Gunther  (IPUMS PMA Senior Data Analyst)
  
<br/>10-15-2021
</div>

<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#setup">Setup</a>
<ul>
<li><a href="#simple-features-objects">Simple features objects</a></li>
<li><a href="#plot-theme">Plot theme</a></li>
</ul></li>
<li><a href="#enumeration-area-buffers">Enumeration Area Buffers</a></li>
<li><a href="#chirps-data">CHIRPS data</a>
<ul>
<li><a href="#raster-data-with-terra">Raster data with terra</a></li>
<li><a href="#raster-layers">Raster layers</a></li>
</ul></li>
<li><a href="#rainfall-within-enumeration-areas">Rainfall within Enumeration Areas</a></li>
</ul>
</nav>
</div>
<p>If you’ve been following along with <a href="../../index.html#category:Nutrition">this series</a>, you already know that <a href="https://www.pmadata.org/technical-areas/nutrition">PMA nutrition surveys</a> offer researchers a unique opportunity to connect nutrition data for <a href="../2021-09-01-nutrition-discovery/index.html#household-nutrition-surveys">women and young children</a> with data about their local <a href="../2021-09-01-nutrition-discovery/index.html#sdp-nutrition-surveys">health and nutrition services</a> environment. PMA promotes this type of contextual research by cluster sampling both <strong>households</strong> and <strong>service delivery points</strong> within the same geographically-defined <a href="https://pma.ipums.org/pma-action/variables/EAID#description_section">enumeration areas</a>.</p>
<p>In this post, we’ll take a look at <em>another</em> approach to studying contextual factors that impact nutrition. Specifically, we’ll be laying the groundwork for our next post, where we’ll dive into <a href="https://iopscience.iop.org/article/10.1088/2515-7620/ac07f5/meta">a recent paper</a> published in <em>Environmental Research Communications</em> that explores the impact of <strong>climate change</strong> on rainfed agriculture in Burkina Faso. As we’ll see, the authors use PMA nutrition data together with <strong>local precipitation</strong> measures from the <a href="https://www.chc.ucsb.edu/data/chirps">Climate Hazards center InfraRed Precipitation with Station dataset (CHIRPS)</a> to show how spatial patterns of growing season quality impact the <a href="../2021-10-01-nutrition-indicators/index.html">quality and variety</a> of foods available for women and young children.</p>
<p>Research like this is made possible when we know the <em>approximate centroid location</em> for enumeration areas used in PMA nutrition surveys. PMA offers displaced GPS coordinates for all of its nutrition surveys <a href="https://www.pmadata.org/data/request-access-datasets">here</a>. In preparation for our next post, we’ll show how to combine these GPS coordinates with an IPUMS PMA data extract and precipitation <a href="https://rspatial.org/terra/spatial/4-rasterdata.html">raster data</a> downloaded from CHIRPS.</p>
<h1 id="setup">Setup</h1>
<p>To get started, we’ll download a 2017 Burkina Faso nutrition data extract from <a href="https://pma.ipums.org/pma-action/variables/group?unit_of_analysis=person_nutrition">IPUMS PMA</a> and load it into R. We’ve selected responses only for “Females and Children with Nutrition Information” (all other household members have been omitted). As usual, we’ll save the “dat” file together with the “xml” codebook in our working directory, and we’ll then load both into R with the <a href="https://tidyverse.tidyverse.org/">tidyverse</a> and <a href="http://tech.popdata.org/ipumsr/">ipumsr</a> packages.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tidyverse.tidyverse.org'>tidyverse</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://www.ipums.org'>ipumsr</a></span><span class='op'>)</span>

<span class='va'>dat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/ipumsr/man/read_ipums_micro.html'>read_ipums_micro</a></span><span class='op'>(</span>
  ddi <span class='op'>=</span> <span class='st'>"data/pma_00002.xml"</span>,
  data <span class='op'>=</span> <span class='st'>"data/pma_00002.dat.gz"</span>
<span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Notably, IPUMS PMA <em>does not</em> disseminate the GPS coordinates we’ll be using in this post. Instead, you’ll need to <a href="https://www.pmadata.org/data/request-access-datasets">apply</a> to download them directly from our partners at PMA. Once approved, you’ll receive a CSV file containing the <strong>displaced centroid</strong> for every enumeration area represented in our data extract <code>dat</code>. You’ll also receive complete <a href="PMA_displacement.pdf">documentation</a> detailing the procedure PMA used to displace each centroid from its original location.</p>
<p>If you’re new to spatial analysis in R, you might expect to begin by loading the CSV into R the <a href="https://readr.tidyverse.org/reference/read_delim.html">usual way</a>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>gps</span> <span class='op'>&lt;-</span> <span class='fu'>read_csv</span><span class='op'>(</span><span class='st'>"data/gps_bf.csv"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>EA_ID</span>, <span class='va'>GPSLONG</span>, <span class='va'>GPSLAT</span>, <span class='va'>DATUM</span><span class='op'>)</span>
<span class='va'>gps</span> 
</code></pre>
</div>
<pre><code># A tibble: 83 × 4
   EA_ID GPSLONG GPSLAT DATUM
   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;
 1  7610  -1.07    12.9 WGS84
 2  7820  -4.07    12.7 WGS84
 3  7271  -1.58    12.4 WGS84
 4  7799  -1.54    12.4 WGS84
 5  7243   0.380   12.1 WGS84
 6  7026  -2.37    12.3 WGS84
 7  7859  -1.57    12.3 WGS84
 8  7725  -1.55    12.3 WGS84
 9  7390  -2.21    12.1 WGS84
10  7104  -1.91    12.8 WGS84
# … with 73 more rows</code></pre>
</div>
<p>Here, we see one row for each of the 83 enumeration areas included in the 2017 Burkina Faso sample. The column <code>EA_ID</code> corresponds to the variable <a href="https://pma.ipums.org/pma-action/variables/EAID">EAID</a>, and the displaced latitude and longitude points are displayed in <code>GPSLAT</code> and <code>GPSLONG</code>, respectively. The column <code>DATUM</code> shows the coordinate reference system for those points: “WGS84” for the World Geodetic System 1984.</p>
<p>In order to perform geometrical operations with these <code>gps</code> coordinates, we’ll need to load the <a href="https://r-spatial.github.io/sf/index.html">sf package</a> designed for manipulating <a href="https://en.wikipedia.org/wiki/Simple_Features">simple features</a> used by geographic information systems. We’ve covered the basics of this package in previous posts <a href="../2021-01-29-mapping-sdp-variables/">here</a> and <a href="../2021-02-04-merging-external-spatial-data/">here</a>, so we’ll skip over some of the introductory details this time; however, it’s crucial to know that <code>sf</code> requires three <strong>operating system dependencies</strong>:</p>
<ul>
<li><a href="https://trac.osgeo.org/geos">GEOS</a> for geometrical operations on projected coordinates</li>
<li><a href="http://proj.org/">PRØJ</a> for coordinate reference system conversion and transformation</li>
<li><a href="http://www.gdal.org/">GDAL</a> for driver options</li>
</ul>
<p>Make sure to follow <a href="https://r-spatial.github.io/sf/index.html#installing">these instructions</a> for installing <code>GEOS</code>, <code>PRØJ</code>, and <code>GDAL</code> on your operating system. You may also need to update R, and then run <code>install.packages("sf")</code>.</p>
<h2 id="simple-features-objects">Simple features objects</h2>
<p>Once you’ve installed <code>sf</code>, load it into R and use <a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a> to coerce <code>gps</code> into the “simple features” object class. We’ll tell <code>sf</code> that the coordinates data are stored in <code>GPSLONG</code> and <code>GPSLAT</code>, and that the points are modeled with the coordinate reference system (crs) <code>4326</code> (this is the <a href="https://epsg.io/4326">EPSG</a> code corresponding to the World Geodetic System 1984).</p>
<aside>
<div class="layout-chunk" data-layout="l-body">
<a href="https://r-spatial.github.io/sf/index.html">
<img src="../../images/hex/sf.png"/>
</a>
</div>
© (<a href="http://www.gnu.org/licenses/old-licenses/gpl-2.0.html">GPLv2</a>)
</aside>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://r-spatial.github.io/sf/'>sf</a></span><span class='op'>)</span>
<span class='va'>gps</span> <span class='op'>&lt;-</span> <span class='va'>gps</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_as_sf.html'>st_as_sf</a></span><span class='op'>(</span>
    coords <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/terra/man/c.html'>c</a></span><span class='op'>(</span><span class='st'>"GPSLONG"</span>, <span class='st'>"GPSLAT"</span><span class='op'>)</span>, 
    crs <span class='op'>=</span> <span class='fl'>4326</span>
  <span class='op'>)</span>
<span class='va'>gps</span> 
</code></pre>
</div>
<pre><code>Simple feature collection with 83 features and 2 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -5.18865 ymin: 9.883331 xmax: 1.634087 ymax: 14.39679
Geodetic CRS:  WGS 84
# A tibble: 83 × 3
   EA_ID DATUM             geometry
 * &lt;dbl&gt; &lt;chr&gt;          &lt;POINT [°]&gt;
 1  7610 WGS84 (-1.065238 12.93839)
 2  7820 WGS84 (-4.065366 12.72985)
 3  7271 WGS84 (-1.583361 12.37884)
 4  7799 WGS84 (-1.540024 12.40452)
 5  7243 WGS84 (0.3797186 12.07097)
 6  7026 WGS84 (-2.366313 12.26087)
 7  7859 WGS84 (-1.570808 12.33761)
 8  7725 WGS84 (-1.552744 12.33411)
 9  7390 WGS84 (-2.211783 12.09784)
10  7104 WGS84 (-1.909244 12.76427)
# … with 73 more rows</code></pre>
</div>
<p>The result of this transformation looks something like a <a href="https://tibble.tidyverse.org/">tibble</a>, except that it contains a header describing a <strong>simple feature collection</strong> with 83 “features” (one per enumeration area) and 2 “fields” (<code>EA_ID</code> and <code>DATUM</code>). The new column <code>geometry</code> replaces <code>GPSLONG</code> and <code>GPSLAT</code>, and it contains the latitude / longitude for each displaced centroid.</p>
<p>There are several graphics packages available for mapping <strong>simple feature collections</strong>, but we’ll focus here on <a href="https://paleolimbot.github.io/ggspatial/index.html">ggspatial</a> - an extension of the <a href="https://ggplot2.tidyverse.org/index.html">ggplot2</a> package we’ve introduced <a href="../2021-07-15-covid-likert/">elsewhere on this blog</a>. For example, we can now easily lay out the displaced centroid for each <code>EAID</code> as a point on a grid like so:</p>
<aside>
In this post, we’ll be plotting <code>SpatRaster</code> objects from the <a href="https://rspatial.github.io/terra/index.html">terra</a> package. Support for <code>terra</code> objects is provided in <code>ggspatial</code> version <code>1.1.5.9000</code> (currently available on <a href="https://github.com/paleolimbot/ggspatial">GitHub</a>).
</aside>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://paleolimbot.github.io/ggspatial/'>ggspatial</a></span><span class='op'>)</span>
<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span><span class='va'>gps</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="nutrition-climate_files/figure-html5/unnamed-chunk-6-1.png" width="624" /></p>
</div>
<p>The <code>ggspatial</code> package comes with several base-map options, accessible via <a href="https://paleolimbot.github.io/ggspatial/reference/annotation_map_tile.html">annotation_map_tile</a>. However, we’ll use a <strong>shapefile</strong> we’ve <a href="https://pma.ipums.org/pma/gis_boundary_files.shtml">downloaded from IPUMS PMA</a> and saved in the “data” folder of our working directory. We’ll use <a href="https://r-spatial.github.io/sf/reference/st_read.html">sf::st_read</a> to load it as another <strong>simple feature collection</strong> (we’ll also drop some columns that we won’t be using in this post).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>shape</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_read.html'>st_read</a></span><span class='op'>(</span><span class='st'>"data/shape_bf"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>select</span><span class='op'>(</span><span class='va'>ADMIN_NAME</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Reading layer `geobf&#39; from data source 
  `/Users/Matt/R/pma-data-hub/_posts/2021-10-15-nutrition-climate/data/shape_bf&#39; 
  using driver `ESRI Shapefile&#39;
Simple feature collection with 13 features and 4 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -5.521112 ymin: 9.393889 xmax: 2.404293 ymax: 15.08511
Geodetic CRS:  WGS 84</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>shape</span>
</code></pre>
</div>
<pre><code>Simple feature collection with 13 features and 1 field
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -5.521112 ymin: 9.393889 xmax: 2.404293 ymax: 15.08511
Geodetic CRS:  WGS 84
First 10 features:
          ADMIN_NAME                       geometry
1  Boucle du Mouhoun MULTIPOLYGON (((-3.206306 1...
2           Cascades MULTIPOLYGON (((-5.388849 1...
3             Centre MULTIPOLYGON (((-1.565052 1...
4         Centre-Est MULTIPOLYGON (((-0.2517975 ...
5        Centre-Nord MULTIPOLYGON (((-0.6722373 ...
6       Centre-Ouest MULTIPOLYGON (((-2.547486 1...
7         Centre-Sud MULTIPOLYGON (((-1.470801 1...
8                Est MULTIPOLYGON (((0.06834642 ...
9      Hauts-Bassins MULTIPOLYGON (((-4.483203 1...
10              Nord MULTIPOLYGON (((-2.952616 1...</code></pre>
</div>
<p>With <code>ggspatial</code>, you can layer different <strong>simple feature collections</strong> together, much like you would layer multiple geometries on a bar chart or any other figure in <code>ggplot2</code>. We’ll build a transparent layer for <code>shape</code> (by setting <code>alpha = 0</code>), and then we’ll build a layer for <code>gps</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span><span class='va'>shape</span>, alpha <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span> <span class='op'>+</span> <span class='co'># `alpha = 0` makes the shapes transparent</span>
  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span><span class='va'>gps</span><span class='op'>)</span> 
</code></pre>
</div>
<p><img src="nutrition-climate_files/figure-html5/unnamed-chunk-8-1.png" width="624" /></p>
</div>
<h2 id="plot-theme">Plot theme</h2>
<p>In previous posts, we’ve shown how to <a href="../2021-08-01-covid-batches/#plot-theme">make a custom theme</a> for plots made with <code>ggplot2</code>. Because <code>ggspatial</code> is a spatial extension of <code>ggplot2</code>, we’ll do so again here to create <code>theme_pma_rainfall</code>. This theme builds on <a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a> by specifying a font, several label and color options, a few custom mapping options:</p>
<ul>
<li><code>title</code> gives us a quick way to provide a title for our map</li>
<li><code>subtitle</code> provides an optional subtitle</li>
<li><code>show_legend</code> allows us to show or hide a pre-designed legend describing the shapes we’ll use to show urban and rural enumeration areas</li>
<li><code>manual_grid</code> describes the coordinates of one particular enumeration area we’ll be focusing on in an example below</li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>sysfonts</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/sysfonts/man/font_add.html'>font_add</a></span><span class='op'>(</span>
  family <span class='op'>=</span> <span class='st'>"cabrito"</span>, 
  regular <span class='op'>=</span> <span class='st'>"../../fonts/cabritosansnormregular-webfont.ttf"</span>
<span class='op'>)</span>
<span class='fu'>showtext</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/showtext/man/showtext_auto.html'>showtext_auto</a></span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>theme_pma_rainfall</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span>
  <span class='va'>title</span>, 
  <span class='va'>subtitle</span> <span class='op'>=</span> <span class='cn'>NULL</span>, 
  <span class='va'>show_legend</span> <span class='op'>=</span> <span class='cn'>TRUE</span>,
  <span class='va'>manual_grid</span> <span class='op'>=</span> <span class='cn'>FALSE</span>
<span class='op'>)</span><span class='op'>{</span>
  <span class='va'>components</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
    <span class='fu'>theme_minimal</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%+replace%</span> 
      <span class='fu'>theme</span><span class='op'>(</span>
        text <span class='op'>=</span> <span class='fu'>element_text</span><span class='op'>(</span>family <span class='op'>=</span> <span class='st'>"cabrito"</span>, size <span class='op'>=</span> <span class='fl'>10</span><span class='op'>)</span>, 
        plot.title <span class='op'>=</span> <span class='fu'>element_text</span><span class='op'>(</span>
          hjust <span class='op'>=</span> <span class='fl'>0</span>,
          size <span class='op'>=</span> <span class='fl'>18</span>, 
          color <span class='op'>=</span> <span class='st'>"#00263A"</span>, <span class='co'># IPUMS navy</span>
          margin <span class='op'>=</span> <span class='fu'>margin</span><span class='op'>(</span>b <span class='op'>=</span> <span class='fl'>5</span><span class='op'>)</span>
        <span class='op'>)</span>, 
        plot.subtitle <span class='op'>=</span> <span class='fu'>element_text</span><span class='op'>(</span>
          size <span class='op'>=</span> <span class='fl'>12</span>, 
          hjust <span class='op'>=</span> <span class='fl'>0</span>,
          margin <span class='op'>=</span> <span class='fu'>margin</span><span class='op'>(</span>b <span class='op'>=</span> <span class='fl'>10</span><span class='op'>)</span>
        <span class='op'>)</span>
      <span class='op'>)</span>,
    <span class='fu'>labs</span><span class='op'>(</span>
      title <span class='op'>=</span> <span class='va'>title</span>, 
      subtitle <span class='op'>=</span> <span class='va'>subtitle</span>,
      fill <span class='op'>=</span> <span class='st'>"Rainfall total (mm)"</span>,
      size <span class='op'>=</span> <span class='st'>"EA displacement buffer"</span>,
      x <span class='op'>=</span> <span class='cn'>NULL</span>,
      y <span class='op'>=</span> <span class='cn'>NULL</span>
    <span class='op'>)</span>,
    <span class='fu'>guides</span><span class='op'>(</span>size <span class='op'>=</span> <span class='fu'>guide_legend</span><span class='op'>(</span>override.aes <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>alpha <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>,
    <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/annotation_scale.html'>annotation_scale</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>style <span class='op'>=</span> <span class='st'>"ticks"</span>, location <span class='op'>=</span> <span class='st'>"br"</span><span class='op'>)</span><span class='op'>)</span>,
    <span class='kw'>if</span><span class='op'>(</span><span class='va'>show_legend</span><span class='op'>)</span><span class='op'>{</span><span class='fu'><a href='https://rdrr.io/pkg/terra/man/c.html'>c</a></span><span class='op'>(</span>
      <span class='fu'>geom_point</span><span class='op'>(</span>
        mapping <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>size <span class='op'>=</span> <span class='va'>URBAN</span> <span class='op'>+</span> <span class='fl'>1</span>, x <span class='op'>=</span> <span class='fl'>0</span>, y <span class='op'>=</span> <span class='fl'>14</span><span class='op'>)</span>,
        data <span class='op'>=</span> <span class='va'>gps</span>,
        alpha <span class='op'>=</span> <span class='fl'>0</span>, 
        shape <span class='op'>=</span> <span class='fl'>21</span>, 
        fill <span class='op'>=</span> <span class='st'>"white"</span>
      <span class='op'>)</span>,
      <span class='fu'>scale_size</span><span class='op'>(</span>
        breaks <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/terra/man/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>2</span><span class='op'>)</span>, 
        range <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/terra/man/c.html'>c</a></span><span class='op'>(</span><span class='fl'>.75</span>, <span class='fl'>3</span><span class='op'>)</span>, 
        labels <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/terra/man/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Urban (2 km)"</span>, <span class='st'>"Rural (5 km)"</span><span class='op'>)</span>
      <span class='op'>)</span>
    <span class='op'>)</span><span class='op'>}</span>,
    <span class='kw'>if</span><span class='op'>(</span><span class='va'>manual_grid</span><span class='op'>)</span><span class='op'>{</span><span class='fu'><a href='https://rdrr.io/pkg/terra/man/c.html'>c</a></span><span class='op'>(</span>
      <span class='fu'>scale_x_continuous</span><span class='op'>(</span>breaks <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span>from <span class='op'>=</span> <span class='op'>-</span><span class='fl'>0.4</span>, to <span class='op'>=</span> <span class='op'>-</span><span class='fl'>0.2</span>, by <span class='op'>=</span> <span class='fl'>0.025</span><span class='op'>)</span><span class='op'>)</span>,
      <span class='fu'>scale_y_continuous</span><span class='op'>(</span>breaks <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span>from <span class='op'>=</span> <span class='fl'>13.4</span>, to <span class='op'>=</span> <span class='fl'>13.6</span>, by <span class='op'>=</span> <span class='fl'>0.025</span><span class='op'>)</span><span class='op'>)</span>,
      <span class='fu'>scale_fill_gradient2</span><span class='op'>(</span>high <span class='op'>=</span> <span class='st'>"#BEC4CB"</span><span class='op'>)</span>
    <span class='op'>)</span><span class='op'>}</span>
  <span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>We’ll be layering <code>theme_pma_rainfall</code> onto our <code>ggspatial</code> maps like so:</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span><span class='va'>shape</span>, alpha <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span><span class='va'>gps</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>theme_pma_rainfall</span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"2017 Burkina Faso Nutrition Survey Enumeration Areas"</span>,
    subtitle <span class='op'>=</span> <span class='st'>"Displaced centroid location for household sample clusters"</span>,
    show_legend <span class='op'>=</span> <span class='cn'>FALSE</span>
  <span class='op'>)</span>
</code></pre>
</div>
<p><img src="nutrition-climate_files/figure-html5/unnamed-chunk-10-1.png" width="960" /></p>
</div>
<h1 id="enumeration-area-buffers">Enumeration Area Buffers</h1>
<p>We mentioned above that the <code>gps</code> coordinates downloaded from PMA are <em>not</em> the actual centroid locations for each EA. These coordinates are <strong>randomly displaced</strong> from the <em>actual</em> centroid, subject to certain rules:</p>
<ul>
<li>urban EAs were displaced up to 2 kilometers in any direction</li>
<li>99% of rural EAs were displaced up to 5 kilometers in any direction</li>
<li>1% of rural EAs were discplaced up to 10 kilometers in any direction</li>
<li>displaced coordinates could <em>not</em> cross one of the administrative boundaries shown in our shape file</li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-11"></span>
<img src="images/displacement.png" alt="Image courtesy https://pmadata.org" width="490" />
<p class="caption">
Figure 1: Image courtesy <a href="https://pmadata.org" class="uri">https://pmadata.org</a>
</p>
</div>
</div>
<p>In order to better represent the <em>actual</em> centroid location for each EA, we’ll use <a href="https://r-spatial.github.io/sf/reference/geos_unary.html">sf::st_buffer</a> to create an appropriately sized <strong>buffer zone</strong> around the displaced <code>gps</code> coordinates for urban and rural areas. First, we’ll need to <a href="https://ipums.github.io/pma-data-hub/posts/2021-02-04-merging-external-spatial-data/#population-density-working-with-raster-data">project</a> both <code>gps</code> and <code>shape</code> with a coordinate reference system that uses <strong>meters</strong> rather than degrees of latitude / longitude. We’ll use <a href="https://epsg.io/32630">EPSG code 32630</a> to select an appropriate projection for Burkina Faso. Notice that the <code>geometry</code> column for each now describes a point in meters:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Project `gps` to meters </span>
<span class='va'>gps</span> <span class='op'>&lt;-</span> <span class='va'>gps</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_transform.html'>st_transform</a></span><span class='op'>(</span>crs <span class='op'>=</span> <span class='fl'>32630</span><span class='op'>)</span>
<span class='va'>gps</span>
</code></pre>
</div>
<pre><code>Simple feature collection with 83 features and 2 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 261303.6 ymin: 1092514 xmax: 1005762 ymax: 1593223
Projected CRS: WGS 84 / UTM zone 30N
# A tibble: 83 × 3
   EA_ID DATUM           geometry
 * &lt;dbl&gt; &lt;chr&gt;        &lt;POINT [m]&gt;
 1  7610 WGS84 (709895.9 1431117)
 2  7820 WGS84 (384340.5 1407498)
 3  7271 WGS84 (654009.7 1368854)
 4  7799 WGS84 (658706.4 1371720)
 5  7243 WGS84 (868012.7 1336673)
 6  7026 WGS84 (568916.8 1355481)
 7  7859 WGS84   (655399 1364301)
 8  7725 WGS84 (657365.6 1363924)
 9  7390 WGS84   (585776 1337496)
10  7104 WGS84 (618400.2 1411317)
# … with 73 more rows</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Project `shape` to meters </span>
<span class='va'>shape</span> <span class='op'>&lt;-</span> <span class='va'>shape</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_transform.html'>st_transform</a></span><span class='op'>(</span>crs <span class='op'>=</span> <span class='fl'>32630</span><span class='op'>)</span>
<span class='va'>shape</span>
</code></pre>
</div>
<pre><code>Simple feature collection with 13 features and 1 field
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 223985.4 ymin: 1038409 xmax: 1089380 ymax: 1669244
Projected CRS: WGS 84 / UTM zone 30N
First 10 features:
          ADMIN_NAME                       geometry
1  Boucle du Mouhoun MULTIPOLYGON (((477692.2 15...
2           Cascades MULTIPOLYGON (((238964.1 12...
3             Centre MULTIPOLYGON (((655859.9 13...
4         Centre-Est MULTIPOLYGON (((798642.2 13...
5        Centre-Nord MULTIPOLYGON (((751439.8 15...
6       Centre-Ouest MULTIPOLYGON (((549102.6 14...
7         Centre-Sud MULTIPOLYGON (((666365.7 13...
8                Est MULTIPOLYGON (((832139.5 14...
9      Hauts-Bassins MULTIPOLYGON (((338580.2 13...
10              Nord MULTIPOLYGON (((505125.2 15...</code></pre>
</div>
<p>Next, we’ll need to identify which of the EAs in <code>gps</code> are located in urban areas. To do so, we’ll use the <code>URBAN</code> indicator for each <code>EAID</code> in our data extract <code>dat</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>gps</span> <span class='op'>&lt;-</span> <span class='va'>dat</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>count</span><span class='op'>(</span><span class='va'>EAID</span>, <span class='va'>URBAN</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>EAID</span>, <span class='va'>URBAN</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>mutate</span><span class='op'>(</span>URBAN <span class='op'>=</span> <span class='fu'>if_else</span><span class='op'>(</span><span class='va'>URBAN</span> <span class='op'>==</span> <span class='fl'>1</span>, <span class='cn'>TRUE</span>, <span class='cn'>FALSE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>full_join</span><span class='op'>(</span><span class='va'>gps</span> <span class='op'>%&gt;%</span> <span class='fu'>rename</span><span class='op'>(</span>EAID <span class='op'>=</span> <span class='va'>EA_ID</span><span class='op'>)</span>, <span class='va'>.</span>, by <span class='op'>=</span> <span class='st'>"EAID"</span><span class='op'>)</span>
<span class='va'>gps</span>
</code></pre>
</div>
<pre><code>Simple feature collection with 83 features and 3 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 261303.6 ymin: 1092514 xmax: 1005762 ymax: 1593223
Projected CRS: WGS 84 / UTM zone 30N
# A tibble: 83 × 4
    EAID DATUM           geometry URBAN
   &lt;dbl&gt; &lt;chr&gt;        &lt;POINT [m]&gt; &lt;lgl&gt;
 1  7610 WGS84 (709895.9 1431117) FALSE
 2  7820 WGS84 (384340.5 1407498) FALSE
 3  7271 WGS84 (654009.7 1368854) TRUE 
 4  7799 WGS84 (658706.4 1371720) TRUE 
 5  7243 WGS84 (868012.7 1336673) TRUE 
 6  7026 WGS84 (568916.8 1355481) TRUE 
 7  7859 WGS84   (655399 1364301) TRUE 
 8  7725 WGS84 (657365.6 1363924) TRUE 
 9  7390 WGS84   (585776 1337496) FALSE
10  7104 WGS84 (618400.2 1411317) FALSE
# … with 73 more rows</code></pre>
</div>
<p>The function <a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a> will draw a circle around each centroid. We’ll specify that the radius of our circle should be 2000 meters if a particular EA is <code>URBAN</code>, and 5000 meters otherwise. We’ll then bisect each circle with <a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection</a> if it crosses an administrative boundary in <code>shape</code>, and we’ll use <a href="https://r-spatial.github.io/sf/reference/st_join.html">st_filter</a> to discard any resulting section that does not contain one of the original centroids in <code>gps</code>.</p>
<aside>
We use a 5 km buffer for <em>all</em> rural EAs in our maps, but remember that an unknown 1% of rural EAs were actually displaced 10 km.
</aside>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>gps</span> <span class='op'>&lt;-</span> <span class='va'>gps</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/geos_unary.html'>st_buffer</a></span><span class='op'>(</span><span class='fu'>if_else</span><span class='op'>(</span><span class='va'>.</span><span class='op'>$</span><span class='va'>URBAN</span>, <span class='fl'>2000</span>, <span class='fl'>5000</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/geos_binary_ops.html'>st_intersection</a></span><span class='op'>(</span><span class='va'>shape</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_join.html'>st_filter</a></span><span class='op'>(</span><span class='va'>gps</span><span class='op'>)</span> 
<span class='va'>gps</span> 
</code></pre>
</div>
<pre><code>Simple feature collection with 83 features and 4 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 257997.5 ymin: 1090514 xmax: 1010762 ymax: 1598223
Projected CRS: WGS 84 / UTM zone 30N
# A tibble: 83 × 5
    EAID DATUM URBAN ADMIN_NAME                               geometry
 * &lt;dbl&gt; &lt;chr&gt; &lt;lgl&gt; &lt;chr&gt;                               &lt;POLYGON [m]&gt;
 1  7820 WGS84 FALSE Boucle du Mouhoun ((389340.5 1407498, 389333.6 1…
 2  7139 WGS84 TRUE  Boucle du Mouhoun ((452887.2 1376644, 452884.4 1…
 3  7869 WGS84 FALSE Boucle du Mouhoun ((524026.7 1425830, 524019.9 1…
 4  7602 WGS84 FALSE Boucle du Mouhoun ((473865.1 1373194, 473858.3 1…
 5  7185 WGS84 TRUE  Boucle du Mouhoun ((383533.7 1346964, 383531 134…
 6  7016 WGS84 FALSE Boucle du Mouhoun ((359037.3 1313005, 359030.4 1…
 7  7212 WGS84 FALSE Boucle du Mouhoun ((531483.7 1275510, 531476.8 1…
 8  7813 WGS84 FALSE Cascades          ((412468.5 1144108, 412461.6 1…
 9  7521 WGS84 FALSE Cascades          ((289412.7 1156524, 289405.9 1…
10  7335 WGS84 TRUE  Cascades          ((307168.9 1176806, 307166.1 1…
# … with 73 more rows</code></pre>
</div>
<p>Notice that the <code>geometry</code> column now describes a “polygon” rather than a “point”. This polygon is defined by a series of latitude / longitude pairs that form the circumference of a <strong>buffer zone</strong>.</p>
<p>We’re finished measuring distance in <strong>meters</strong>, so we’ll revert <em>back</em> to degrees of latitude / longitude and plot the result. (This time, we’ll use the argument <code>show_legend = TRUE</code> to adopt the custom legend we designed for <code>theme_pma_rainfall</code>).</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>gps</span> <span class='op'>&lt;-</span> <span class='va'>gps</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_transform.html'>st_transform</a></span><span class='op'>(</span>crs <span class='op'>=</span> <span class='fl'>4326</span><span class='op'>)</span>
<span class='va'>shape</span> <span class='op'>&lt;-</span> <span class='va'>shape</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_transform.html'>st_transform</a></span><span class='op'>(</span>crs <span class='op'>=</span> <span class='fl'>4326</span><span class='op'>)</span>

<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span><span class='va'>shape</span>, alpha <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span><span class='va'>gps</span>, alpha <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>theme_pma_rainfall</span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"2017 Burkina Faso Nutrition Survey Enumeration Areas"</span>,
    subtitle <span class='op'>=</span> <span class='st'>"Displaced centroid location for household sample clusters"</span>,
    show_legend <span class='op'>=</span> <span class='cn'>TRUE</span>
  <span class='op'>)</span>
</code></pre>
</div>
<p><img src="nutrition-climate_files/figure-html5/unnamed-chunk-15-1.png" width="960" /></p>
</div>
<p>Now that we’ve identified the <strong>buffer zone</strong> for each cluster of sampled households, we’re ready to calculate a measure of local precipitation for each household with data from CHIRPS.</p>
<h1 id="chirps-data">CHIRPS data</h1>
<p>The complete CHIRPS precipitation data series can be downloaded directly from the <a href="https://data.chc.ucsb.edu/products/CHIRPS-2.0/">UCSB Climate Hazards Center</a>, but we imagine most users will want to select an area of interest through the CHIRPS API provider, <a href="https://climateserv.servirglobal.net/">ClimateServ</a>. If you’re familiar with tools for downloading and saving <strong>raster</strong> files, you can submit a request to ClimateServ directly from R via the <a href="https://docs.ropensci.org/chirps/index.html">chirps R package</a>. Or, if you’re more comfortable using a graphic user interface, you can simply navigate to the ClimateServ homepage in your browser:</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="images/climateserv1.png" width="1280" style="display: block; margin: auto;" /></p>
</div>
<p>The ClimateServ website allows us to simply select the country boundaries for Burkina Faso. We’ll select “download raw data” to download <strong>daily rainfall totals</strong> for a roughly 30 year period from June 1, 2017 (nutrition interviews were conducted between June and August).</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="images/climateserv2.png" width="1280" /></p>
</div>
<p>Once your request has been processed, you’ll receive a compressed folder containing one “tif” image for each day in the 30 year timespan: that’s 10,959 files containing comprising potentially several gigabytes of raster data. We’ve previously shown how to use the <a href="https://rspatial.org/raster/index.html">raster</a> package to handle this type of data, but we’ll now introduce the <a href="https://rspatial.org/terra/index.html">terra</a> package as a newer, faster alternative.</p>
<h2 id="raster-data-with-terra">Raster data with terra</h2>
<p>If you’ve installed all of the dependencies needed for <code>sf</code> above, you’ll be able to install <code>terra</code> with <code>install.packages("terra")</code> and then load it into R.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://rspatial.org/terra/'>terra</a></span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>The magic behind <code>terra</code> is that it <em>avoids reading every image into R at once</em>. Instead, it <a href="https://rspatial.github.io/terra/reference/rast.html">reads metadata about each image</a> - information about its spatial extent, coordinate reference system, and pixel count. Let’s take a look at the metadata for the image associated with a particularly rainy day in 1997:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>day1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/terra/man/rast.html'>rast</a></span><span class='op'>(</span><span class='st'>"data/chirps_bf/19970301.tif"</span><span class='op'>)</span>
<span class='va'>day1</span>
</code></pre>
</div>
<pre><code>class       : SpatRaster 
dimensions  : 115, 159, 1  (nrow, ncol, nlyr)
resolution  : 0.05, 0.05  (x, y)
extent      : -5.549997, 2.400003, 9.349999, 15.1  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat WGS 84 (EPSG:4326) 
source      : 19970301.tif 
name        : 19970301 
min value   :        0 
max value   : 8.319133 </code></pre>
</div>
<aside>
<div class="layout-chunk" data-layout="l-body">
<a href="https://rspatial.github.io/terra/index.html">
<img src="../../images/hex/terra.png"/>
</a>
</div>
© (<a href="https://www.gnu.org/licenses/gpl-3.0.en.html">GPLv3</a>)
</aside>
<p>As you can see, this image contains 115 rows and 159 columns of pixels. The value in each pixel represents the rainfall - in millimeters - for an area 0.05 degrees longitude by 0.05 degrees latitutde (shown in the “resolution” field). If you just want to preview the <a href="https://rspatial.github.io/terra/reference/values.html">values</a> associated with each pixel, we recommend coercing the default <code>matrix</code> as a <code>tibble</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>day1_vals</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/terra/man/values.html'>values</a></span><span class='op'>(</span><span class='va'>day1</span>, dataframe <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tibble.html'>tibble</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>day1_vals</span>
</code></pre>
</div>
<pre><code># A tibble: 18,285 × 1
   X19970301
       &lt;dbl&gt;
 1         0
 2         0
 3         0
 4         0
 5         0
 6         0
 7         0
 8         0
 9         0
10         0
# … with 18,275 more rows</code></pre>
</div>
<p>The result is a single column with precipitation totals for 18,285 pixels. This is the CHIRPS data we’ve obtained for <em>a single day</em> in our 30-year timespan. Alone, it’s not a lot of data:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/utils/object.size.html'>object.size</a></span><span class='op'>(</span><span class='va'>day1_vals</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/format.html'>format</a></span><span class='op'>(</span><span class='st'>"Mb"</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] &quot;0.1 Mb&quot;</code></pre>
</div>
<p>If you’d like, you can plot the rainfall pixels from March 1, 1997 with the same <code>ggspatial</code> tools shown above. We’ll also ensure that all pixels representing “0” rainfall are transparent (revealing the underlying coordinate grid).</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span>
    <span class='va'>day1</span>,
    alpha <span class='op'>=</span> <span class='fu'>if_else</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/terra/man/values.html'>values</a></span><span class='op'>(</span><span class='va'>day1</span><span class='op'>)</span> <span class='op'>==</span> <span class='fl'>0</span>, <span class='fl'>0</span>, <span class='fl'>1</span><span class='op'>)</span> <span class='co'># makes 0 values transparent</span>
  <span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span><span class='va'>shape</span>, alpha <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span><span class='va'>gps</span>,  alpha <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>theme_pma_rainfall</span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Burkina Faso Rainfall Totals: March 1, 1997"</span>,
    subtitle <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste</a></span><span class='op'>(</span>
      <span class='st'>"National precipitation with displaced centroid locations for 2017 PMA"</span>,
      <span class='st'>"Nutrition Survey enumeration areas"</span>
    <span class='op'>)</span>
  <span class='op'>)</span> <span class='op'>+</span>    
  <span class='fu'>scale_fill_gradient2</span><span class='op'>(</span>
    low <span class='op'>=</span> <span class='st'>"#000000"</span>,   <span class='co'># white</span>
    high <span class='op'>=</span> <span class='st'>"#00263A"</span>  <span class='co'># IPUMS navy</span>
  <span class='op'>)</span>
</code></pre>
</div>
<p><img src="nutrition-climate_files/figure-html5/unnamed-chunk-23-1.png" width="960" /></p>
</div>
<h2 id="raster-layers">Raster layers</h2>
<p>Now, imagine working with data for each of the 10,959 days in our data series. Whereas the total size of the dataset from a single day was small - only about 0.1 megabytes - the amount of data required to represent 18,285 pixels from daily collection over a 30-year period could easily overwhelm the amount of memory available to R. Instead, we’ll only read metadata for each image into a large list with <a href="https://purrr.tidyverse.org/reference/map.html">purrr::map</a>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>chirps</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.files.html'>list.files</a></span><span class='op'>(</span><span class='st'>"data/chirps"</span>, full.names <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>map</span><span class='op'>(</span><span class='op'>~</span><span class='fu'><a href='https://rdrr.io/pkg/terra/man/rast.html'>rast</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>We can now “stack” all of the list-items in <code>chirps</code> as “layers” in a single metadata object:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>chirps</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/terra/man/rast.html'>rast</a></span><span class='op'>(</span><span class='va'>chirps</span><span class='op'>)</span>
<span class='va'>chirps</span>
</code></pre>
</div>
<pre><code>class       : SpatRaster 
dimensions  : 115, 159, 14031  (nrow, ncol, nlyr)
resolution  : 0.05, 0.05  (x, y)
extent      : -5.549997, 2.400003, 9.349999, 15.1  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat WGS 84 (EPSG:4326) 
sources     : 19810101.tif  
              19810102.tif  
              19810103.tif  
              ... and 14028 more source(s)
names       : 19810101, 19810102, 19810103, 19810104, 19810105, 19810106, ... </code></pre>
</div>
<p>Notice that the amount of data actually loaded into R is only about one <em>kilobyte</em>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/utils/object.size.html'>object.size</a></span><span class='op'>(</span><span class='va'>chirps</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/format.html'>format</a></span><span class='op'>(</span><span class='st'>"Kb"</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] &quot;1.3 Kb&quot;</code></pre>
</div>
<p>The <code>terra</code> package contains several <a href="https://rspatial.github.io/terra/reference/summarize-generics.html">summary methods</a> you can use to quickly explore summary statistics over all of the layers included in our 30-year timespan. For example, <code>terra::mean</code> computes the mean value for each pixel across every layer of <code>chirps</code>. This can be particularly helpful if you want to create a map showing the 30-year average rainfall for selected enumeration areas relative to neighboring areas:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>bf_means</span> <span class='op'>&lt;-</span> <span class='fu'>terra</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/terra/man/summarize-generics.html'>mean</a></span><span class='op'>(</span><span class='va'>chirps</span><span class='op'>)</span> 
</code></pre>
</div>
</div>
<p>When we build a map for <code>bf_means</code> we’ll use <a href="https://rspatial.github.io/terra/reference/mask.html">mask</a> simply to hide any pixels outside the boundaries of our <code>shape</code> file:</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/terra/man/mask.html'>mask</a></span><span class='op'>(</span><span class='va'>bf_means</span>, <span class='fu'><a href='https://rdrr.io/pkg/terra/man/vect.html'>vect</a></span><span class='op'>(</span><span class='va'>shape</span><span class='op'>)</span>, touches <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span><span class='va'>shape</span>, alpha <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span><span class='va'>gps</span>,  alpha <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>theme_pma_rainfall</span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Burkina Faso 30-year Average Daily Rainfall"</span>,
    subtitle <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste</a></span><span class='op'>(</span>
      <span class='st'>"National precipitation with displaced centroid locations for 2017 PMA"</span>,
      <span class='st'>"Nutrition Survey enumeration areas"</span>
    <span class='op'>)</span>
  <span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_fill_continuous</span><span class='op'>(</span>
    low <span class='op'>=</span> <span class='st'>"#FAEFD1BB"</span>, high <span class='op'>=</span> <span class='st'>"#00263ABB"</span>, na.value <span class='op'>=</span> <span class='st'>"transparent"</span>
  <span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>labs</span><span class='op'>(</span>caption <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste</a></span><span class='op'>(</span>
    sep <span class='op'>=</span> <span class='st'>"\n"</span>,
    <span class='st'>"Climate Hazards Center InfraRed Precipitation with Station data (CHIRPS)"</span>,
    <span class='st'>"06-01-1987 to 06-01-2017"</span>
  <span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="nutrition-climate_files/figure-html5/unnamed-chunk-30-1.png" width="960" /></p>
</div>
<p>For most analytic purposes, you’ll want to do more than simply <em>layer</em> summary data beneath a map of the PMA enumeration areas. Instead, we’ll want to <a href="https://rspatial.github.io/terra/reference/extract.html">extract</a> the pixels associated with the area covered by the buffer zones we created above.</p>
<h1 id="rainfall-within-enumeration-areas">Rainfall within Enumeration Areas</h1>
<p>Let’s start by zooming-in one of the enumeration areas listed in our <code>gps</code> dataset. This <em>rural</em> EA is located near the eastern border in the Boucle du Mouhoun region, so you’ll notice that its 5 kilometer buffer zone is cropped by an administrative boundary.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span><span class='va'>gps</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>EAID</span> <span class='op'>==</span> <span class='fl'>7003</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>theme_pma_rainfall</span><span class='op'>(</span>
    <span class='st'>"Enumeration Area 7003"</span>, 
    <span class='st'>"A rural sample cluster in the Boucle du Mouhoun region"</span>,
    show_legend <span class='op'>=</span> <span class='cn'>FALSE</span>,
    manual_grid <span class='op'>=</span> <span class='cn'>TRUE</span>
  <span class='op'>)</span>   
</code></pre>
</div>
<p><img src="nutrition-climate_files/figure-html5/unnamed-chunk-31-1.png" width="768" /></p>
</div>
<p>In our single-day map above, we plotted national rainfall totals for March 1, 1997. We’ll plot rainfall from this date again, but this time we’ll use the <code>crop</code> function to focus only on pixels in the immediate vicinity of <code>EAID == 7003</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>day1_7003</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/terra/man/crop.html'>crop</a></span><span class='op'>(</span>
  <span class='va'>day1</span>, 
  <span class='va'>gps</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>EAID</span> <span class='op'>==</span> <span class='fl'>7003</span><span class='op'>)</span>, 
  snap <span class='op'>=</span> <span class='st'>"out"</span>
<span class='op'>)</span>

<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span><span class='va'>day1_7003</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span><span class='va'>gps</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>EAID</span> <span class='op'>==</span> <span class='fl'>7003</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>theme_pma_rainfall</span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Rural EA Rainfall Total: March 1, 1997"</span>, 
    subtitle <span class='op'>=</span> <span class='st'>"One daily total is reported for every 0.05 arc-degrees"</span>,
    show_legend <span class='op'>=</span> <span class='cn'>FALSE</span>, 
    manual_grid <span class='op'>=</span> <span class='cn'>TRUE</span>
  <span class='op'>)</span> 
</code></pre>
</div>
<p><img src="nutrition-climate_files/figure-html5/unnamed-chunk-32-1.png" width="768" data-distill-preview=1 /></p>
</div>
<p>Interestingly, we see a range of rainfall totals across the 9 pixels in this area: trace amounts of rain were detected in the 6 western-most pixels, but not in the 3 pixels on the eastern side. <em>How should we summarise the rainfall experienced by a household in this enumeration area, given that its centroid might be located any one of several different pixels?</em></p>
<p>You might consider taking the mean daily total for all 9 pixels, but 2 pixels (top-right and bottom-right) are not included in the buffer zone at all. Most of the remaining pixels only <em>partially</em> overlap with the buffer zone - you might reasonably conclude the centroid is more likely to fall within the bottom 2 rows of pixels than in the top row.</p>
<p>Fortunately, the <code>terra</code> function <code>extract</code> gives both the rainfall total <em>and</em> the proportion of each pixel overlapping with buffer zone if we specify <code>weights = TRUE</code>. We’ll need to use <a href="https://rspatial.github.io/terra/reference/vect.html">vect</a> to coerce the <code>gps</code> object into the <code>SpatVector</code> class used by most <code>terra</code> functions.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>day1_7003</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/terra/man/extract.html'>extract</a></span><span class='op'>(</span>
  <span class='va'>day1_7003</span>, 
  <span class='va'>gps</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>EAID</span> <span class='op'>==</span> <span class='fl'>7003</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/pkg/terra/man/vect.html'>vect</a></span><span class='op'>(</span><span class='op'>)</span>, 
  weights <span class='op'>=</span> <span class='cn'>TRUE</span>
<span class='op'>)</span>

<span class='va'>day1_7003</span> 
</code></pre>
</div>
<pre><code>  ID  19970301 weight
1  1 1.2160333   0.01
2  1 0.8472163   0.13
3  1 1.6922826   0.49
4  1 1.4724811   1.00
5  1 0.0000000   0.22
6  1 1.3903536   0.26
7  1 1.3996017   0.64</code></pre>
</div>
<p>The result is a <code>data.frame</code> containing one row for each pixel that overlaps with our buffer (the top-right and bottom-right pixels are omitted). The column <code>19970301</code> gives the rainfall for each pixel, and the column <code>weight</code> shows the proportion of each pixel that falls within the buffer. We can think of these <code>weight</code> values as probabilities representing the likelihood that each pixel contains the real centroid location for <code>EA == 7003</code>. Let’s calculate a <code>weighted.mean</code> using the probabilities represented by <code>weight</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>day1_7003</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tidyverse.html'>summarise</a></span><span class='op'>(</span>
    EAID <span class='op'>=</span> <span class='fl'>7003</span>,
    wtd_mean <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/terra/man/weighted.mean.html'>weighted.mean</a></span><span class='op'>(</span><span class='va'>`19970301`</span>, <span class='va'>weight</span><span class='op'>)</span>
  <span class='op'>)</span>
</code></pre>
</div>
<pre><code>  EAID wtd_mean
1 7003 1.338631</code></pre>
</div>
<p>This represents the approximate <em>single-day rainfall total</em> for March 1, 1997 spatially averaged for all pixels overlapping with the buffer for <code>EA == 7003</code>. In order to produce the <em>30-year average daily rainfall</em> for this buffer, we’ll simply repeat the same process for each day between June 1, 1987 and June 1, 2017 (the entire stack represented by <code>chirps</code>). We’ll arrange the results in a <code>tibble</code>, and we’ll replace the default <code>ID</code> column with the unique identifier for each <code>pixel</code> shown above.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>chirps30_7003</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/terra/man/extract.html'>extract</a></span><span class='op'>(</span>
  <span class='va'>chirps</span>,
  <span class='va'>gps</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>EAID</span> <span class='op'>==</span> <span class='fl'>7003</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/pkg/terra/man/vect.html'>vect</a></span><span class='op'>(</span><span class='op'>)</span>,
  weights <span class='op'>=</span> <span class='cn'>TRUE</span>
<span class='op'>)</span>

<span class='va'>chirps30_7003</span> <span class='op'>&lt;-</span> <span class='va'>chirps30_7003</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tibble.html'>tibble</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>ID</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>rowid_to_column</span><span class='op'>(</span><span class='st'>"pixel"</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>relocate</span><span class='op'>(</span><span class='va'>weight</span>, .after <span class='op'>=</span> <span class='va'>pixel</span><span class='op'>)</span>

<span class='va'>chirps30_7003</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<pre><code># A tibble: 7 × 10,961
  pixel weight `19870601` `19870602` `19870603` `19870604` `19870605`
  &lt;int&gt;  &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;
1     1   0.01       8.81          0       2.94       5.87          0
2     2   0.13       8.43          0       2.81       5.62          0
3     3   0.49       9.46          0       3.15       6.31          0
4     4   1.00       9.10          0       3.03       6.07          0
5     5   0.22       9.23          0       3.08       6.16          0
6     6   0.26       9.99          0       3.33       6.66          0
7     7   0.64       9.45          0       3.15       6.30          0
# … with 10,954 more variables: 19870606 &lt;dbl&gt;, 19870607 &lt;dbl&gt;,
#   19870608 &lt;dbl&gt;, 19870609 &lt;dbl&gt;, 19870610 &lt;dbl&gt;, 19870611 &lt;dbl&gt;,
#   19870612 &lt;dbl&gt;, 19870613 &lt;dbl&gt;, 19870614 &lt;dbl&gt;, 19870615 &lt;dbl&gt;,
#   19870616 &lt;dbl&gt;, 19870617 &lt;dbl&gt;, 19870618 &lt;dbl&gt;, 19870619 &lt;dbl&gt;,
#   19870620 &lt;dbl&gt;, 19870621 &lt;dbl&gt;, 19870622 &lt;dbl&gt;, 19870623 &lt;dbl&gt;,
#   19870624 &lt;dbl&gt;, 19870625 &lt;dbl&gt;, 19870626 &lt;dbl&gt;, 19870627 &lt;dbl&gt;,
#   19870628 &lt;dbl&gt;, 19870629 &lt;dbl&gt;, 19870630 &lt;dbl&gt;, 19870701 &lt;dbl&gt;, …</code></pre>
</div>
<p>The rainfall total for each day is stored in one of 10,959 columns to the right of <code>pixel</code> and <code>weight</code>. We’ll use <code>pivot_longer</code> to rearrange these data in rows, and then we’ll calculate a simple <code>weighted.mean</code> to obtain the 30-year average daily rainfall.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>chirps30_7003</span> <span class='op'>&lt;-</span> <span class='va'>chirps30_7003</span> <span class='op'>%&gt;%</span> <span class='fu'>pivot_longer</span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/pkg/terra/man/c.html'>c</a></span><span class='op'>(</span><span class='va'>pixel</span>, <span class='va'>weight</span><span class='op'>)</span><span class='op'>)</span> 
<span class='va'>chirps30_7003</span>   
</code></pre>
</div>
<pre><code># A tibble: 76,713 × 4
   pixel weight name     value
   &lt;int&gt;  &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;
 1     1   0.01 19870601  8.81
 2     1   0.01 19870602  0   
 3     1   0.01 19870603  2.94
 4     1   0.01 19870604  5.87
 5     1   0.01 19870605  0   
 6     1   0.01 19870606 30.6 
 7     1   0.01 19870607  3.39
 8     1   0.01 19870608  0   
 9     1   0.01 19870609  0   
10     1   0.01 19870610  0   
# … with 76,703 more rows</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>chirps30_7003</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tidyverse.html'>summarise</a></span><span class='op'>(</span>
    EAID <span class='op'>=</span> <span class='fl'>7003</span>,
    MEAN_20YR <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/terra/man/weighted.mean.html'>weighted.mean</a></span><span class='op'>(</span><span class='va'>value</span>, <span class='va'>weight</span><span class='op'>)</span>
  <span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 1 × 2
   EAID MEAN_20YR
  &lt;dbl&gt;     &lt;dbl&gt;
1  7003      1.50</code></pre>
</div>
<p>Now that we’ve developed a strategy for summarising all of the rainfall pixels for a <em>single</em> enumeration area, we’ll see that it’s easy to generalize our approach to <em>all</em> of the enumeration areas associated with the 2017 Burkina Faso sample. Although we’ll save a great deal of time by focusing <em>only</em> on the CHIRPS pixels that fall within each of our 83 buffer zones, the <code>extract</code> procedure below will still require a few minutes of patience:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>chirps30_all</span> <span class='op'>&lt;-</span> <span class='va'>chirps</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/pkg/terra/man/extract.html'>extract</a></span><span class='op'>(</span><span class='va'>gps</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/pkg/terra/man/vect.html'>vect</a></span><span class='op'>(</span><span class='op'>)</span>, weights <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/pkg/terra/man/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tibble.html'>tibble</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>chirps30_all</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<pre><code># A tibble: 416 × 10,961
      ID `19870601` `19870602` `19870603` `19870604` `19870605`
   &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;
 1     1          0       5.91       5.91       11.8       5.91
 2     1          0       5.76       5.76       11.5       5.76
 3     1          0       5.73       5.73       11.5       5.73
 4     1          0       6.56       6.56       13.1       0   
 5     1          0       6.14       6.14       12.3       6.14
 6     1          0       6.15       6.15       12.3       6.15
 7     1          0       6.80       0          13.6       0   
 8     1          0       6.83       0          13.7       0   
 9     2          0       5.95       0          17.9       5.95
10     2          0       6.07       0          18.2       6.07
# … with 406 more rows, and 10,955 more variables: 19870606 &lt;dbl&gt;,
#   19870607 &lt;dbl&gt;, 19870608 &lt;dbl&gt;, 19870609 &lt;dbl&gt;, 19870610 &lt;dbl&gt;,
#   19870611 &lt;dbl&gt;, 19870612 &lt;dbl&gt;, 19870613 &lt;dbl&gt;, 19870614 &lt;dbl&gt;,
#   19870615 &lt;dbl&gt;, 19870616 &lt;dbl&gt;, 19870617 &lt;dbl&gt;, 19870618 &lt;dbl&gt;,
#   19870619 &lt;dbl&gt;, 19870620 &lt;dbl&gt;, 19870621 &lt;dbl&gt;, 19870622 &lt;dbl&gt;,
#   19870623 &lt;dbl&gt;, 19870624 &lt;dbl&gt;, 19870625 &lt;dbl&gt;, 19870626 &lt;dbl&gt;,
#   19870627 &lt;dbl&gt;, 19870628 &lt;dbl&gt;, 19870629 &lt;dbl&gt;, 19870630 &lt;dbl&gt;, …</code></pre>
</div>
<p>The only difference here is that <code>ID</code> represents an index number for each of the 83 enumeration areas, and each enumeration area may include anywhere between 1 and 9 pixels. We haven’t bothered assigning numbers to each pixel, but we’ll need to find the correct <code>EAID</code> for each <code>ID</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>chirps30_all</span> <span class='op'>&lt;-</span> <span class='va'>gps</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>rowid_to_column</span><span class='op'>(</span><span class='st'>"ID"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tibble.html'>tibble</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>ID</span>, <span class='va'>EAID</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>full_join</span><span class='op'>(</span><span class='va'>chirps30_all</span>, by <span class='op'>=</span> <span class='st'>"ID"</span><span class='op'>)</span>
<span class='va'>chirps30_all</span>
</code></pre>
</div>
<pre><code># A tibble: 416 × 10,962
      ID  EAID `19870601` `19870602` `19870603` `19870604` `19870605`
   &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;
 1     1  7820          0       5.91       5.91       11.8       5.91
 2     1  7820          0       5.76       5.76       11.5       5.76
 3     1  7820          0       5.73       5.73       11.5       5.73
 4     1  7820          0       6.56       6.56       13.1       0   
 5     1  7820          0       6.14       6.14       12.3       6.14
 6     1  7820          0       6.15       6.15       12.3       6.15
 7     1  7820          0       6.80       0          13.6       0   
 8     1  7820          0       6.83       0          13.7       0   
 9     2  7139          0       5.95       0          17.9       5.95
10     2  7139          0       6.07       0          18.2       6.07
# … with 406 more rows, and 10,955 more variables: 19870606 &lt;dbl&gt;,
#   19870607 &lt;dbl&gt;, 19870608 &lt;dbl&gt;, 19870609 &lt;dbl&gt;, 19870610 &lt;dbl&gt;,
#   19870611 &lt;dbl&gt;, 19870612 &lt;dbl&gt;, 19870613 &lt;dbl&gt;, 19870614 &lt;dbl&gt;,
#   19870615 &lt;dbl&gt;, 19870616 &lt;dbl&gt;, 19870617 &lt;dbl&gt;, 19870618 &lt;dbl&gt;,
#   19870619 &lt;dbl&gt;, 19870620 &lt;dbl&gt;, 19870621 &lt;dbl&gt;, 19870622 &lt;dbl&gt;,
#   19870623 &lt;dbl&gt;, 19870624 &lt;dbl&gt;, 19870625 &lt;dbl&gt;, 19870626 &lt;dbl&gt;,
#   19870627 &lt;dbl&gt;, 19870628 &lt;dbl&gt;, 19870629 &lt;dbl&gt;, 19870630 &lt;dbl&gt;, …</code></pre>
</div>
<p>Finally, we’ll <code>pivot_longer</code> and calculate a separate <code>weighted.mean</code> for each <code>EAID</code>. The result can be merged directly to <code>gps</code> if we’d like to create a map:</p>
<div class="layout-chunk" data-layout="l-body-outset">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>gps</span> <span class='op'>&lt;-</span> <span class='va'>chirps30_all</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>pivot_longer</span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/pkg/terra/man/c.html'>c</a></span><span class='op'>(</span><span class='va'>ID</span>, <span class='va'>EAID</span>, <span class='va'>weight</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>EAID</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tidyverse.html'>summarise</a></span><span class='op'>(</span>CHIRPS_30 <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/terra/man/weighted.mean.html'>weighted.mean</a></span><span class='op'>(</span><span class='va'>value</span>, <span class='va'>weight</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>full_join</span><span class='op'>(</span><span class='va'>gps</span>, by <span class='op'>=</span> <span class='st'>"EAID"</span><span class='op'>)</span>

<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span><span class='va'>shape</span>, alpha <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html'>layer_spatial</a></span><span class='op'>(</span><span class='va'>gps</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='va'>CHIRPS_30</span>, stroke <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>theme_pma_rainfall</span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Burkina Faso 30-year Average Daily Rainfall"</span>, 
    subtitle <span class='op'>=</span> <span class='st'>"PMA 2017 Nutrition Survey enumeration area centroid locations"</span>
  <span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>scale_fill_steps</span><span class='op'>(</span>low <span class='op'>=</span> <span class='st'>"#FAEFD1"</span>, high <span class='op'>=</span> <span class='st'>"#00263A"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>labs</span><span class='op'>(</span>caption <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste</a></span><span class='op'>(</span>sep <span class='op'>=</span> <span class='st'>"\n"</span>,
    <span class='st'>"Climate Hazards Center InfraRed Precipitation with Station data (CHIRPS)"</span>,
    <span class='st'>"06-01-1987 to 06-01-2017"</span>
  <span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="nutrition-climate_files/figure-html5/unnamed-chunk-41-1.png" width="960" /></p>
</div>
<p>We can also attach these local rainfall totals to the records for individual women and children in the 2017 Burkina Faso nutrition dataset <code>dat</code>. At this point, the <strong>simple features collection</strong> class is no longer necessary; we can simply join <code>CHIRPS_30</code> directly to <code>dat</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>gps</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>EAID</span>, <span class='va'>CHIRPS_30</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>full_join</span><span class='op'>(</span><span class='va'>dat</span>, by <span class='op'>=</span> <span class='st'>"EAID"</span><span class='op'>)</span> 
</code></pre>
</div>
<pre><code># A tibble: 8,305 × 978
    EAID CHIRPS_30         SAMPLE COUNTRY  YEAR ROUND HHID   PERSONID 
   &lt;dbl&gt;     &lt;dbl&gt;      &lt;int+lbl&gt; &lt;int+l&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
 1  7003      1.50 85406 [Burkin… 1 [Bur…  2017     1 07003… 07003000…
 2  7003      1.50 85406 [Burkin… 1 [Bur…  2017     1 07003… 07003000…
 3  7003      1.50 85406 [Burkin… 1 [Bur…  2017     1 07003… 07003000…
 4  7003      1.50 85406 [Burkin… 1 [Bur…  2017     1 07003… 07003000…
 5  7003      1.50 85406 [Burkin… 1 [Bur…  2017     1 07003… 07003000…
 6  7003      1.50 85406 [Burkin… 1 [Bur…  2017     1 07003… 07003000…
 7  7003      1.50 85406 [Burkin… 1 [Bur…  2017     1 07003… 07003000…
 8  7003      1.50 85406 [Burkin… 1 [Bur…  2017     1 07003… 07003000…
 9  7003      1.50 85406 [Burkin… 1 [Bur…  2017     1 07003… 07003000…
10  7003      1.50 85406 [Burkin… 1 [Bur…  2017     1 07003… 07003000…
# … with 8,295 more rows, and 970 more variables:
#   RESPONDENT &lt;int+lbl&gt;, LINENO &lt;int&gt;, ENUMID &lt;dbl+lbl&gt;,
#   CONSENTHQ &lt;int+lbl&gt;, AVAILABLEHQ &lt;int+lbl&gt;, VISITNUMHQ &lt;int+lbl&gt;,
#   PREVINTERVIEWHQ &lt;int+lbl&gt;, RESULTHQ &lt;int+lbl&gt;,
#   ELIGIBLEHH &lt;int+lbl&gt;, RESULTFCQ &lt;int+lbl&gt;, HHIDORIG &lt;chr&gt;,
#   ELIGTYPE &lt;int+lbl&gt;, ELIGIBLEFC &lt;int+lbl&gt;, ELIGIBLESEL &lt;int+lbl&gt;,
#   ELIGIBLEKID &lt;int+lbl&gt;, ELIGIBLEHHKID &lt;int+lbl&gt;, …</code></pre>
</div>
<p>In our next post, we’ll learn much more about the relationship between CHIRPS precipitation data and nutritional outcomes for the women and young children in this survey. Stay tuned!</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<!--radix_placeholder_article_footer-->
<div class="article-footer">
  <p class="social_footer">
    <span class="disqus-comments">
      <i class="fas fa-comments"></i>
      &nbsp;
      <span class="disqus-comment-count" data-disqus-identifier="posts/2021-10-15-nutrition-climate/">Comment on this article</span>
    </span>
    <span class="article-sharing">
      Share: &nbsp;
      <a href="https://twitter.com/share?text=How%20to%20use%20CHIRPS%20Climate%20Data%20with%20PMA%20Nutrition%20Surveys&amp;url=https%3A%2F%2Fipums.github.io%2Fpma-data-hub%2Fposts%2F2021-10-15-nutrition-climate%2F" aria-label="share on twitter">
        <i class="fab fa-twitter" aria-hidden="true"></i>
      </a>
      <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fipums.github.io%2Fpma-data-hub%2Fposts%2F2021-10-15-nutrition-climate%2F&amp;title=How%20to%20use%20CHIRPS%20Climate%20Data%20with%20PMA%20Nutrition%20Surveys" aria-label="share on linkedin">
        <i class="fab fa-linkedin" aria-hidden="true"></i>
      </a>
    </span>
  </p>
  <script id="dsq-count-scr" src="https://pma-data-hub.disqus.com/count.js" async></script>
  <div id="disqus_thread" class="hidden"></div>
  <script type="text/javascript" cookie-consent="functionality">
var disqus_config = function () {
  this.page.url = 'https://ipums.github.io/pma-data-hub/posts/2021-10-15-nutrition-climate/';
  this.page.identifier = 'posts/2021-10-15-nutrition-climate/';
};
(function() {
  var d = document, s = d.createElement('script');
  s.src = 'https://pma-data-hub.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script>
</div>
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
  <h3 id="updates-and-corrections">Corrections</h3>
  <p>If you see mistakes or want to suggest changes, please <a href="https://github.com/ipums/pma-data-hub/issues/new">create an issue</a> on the source repository.</p>
</div>
<!--/radix_placeholder_appendices-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<!--radix_placeholder_navigation_after_body--><html><body>
<div class="distill-site-nav distill-site-footer">
<p>Developed by <a href="https://www.ipums.org">IPUMS</a> at the
University of Minnesota</p>
<p>Licensed under the
<a href="https://www.mozilla.org/en-US/MPL/2.0/">Mozilla Public License
Version 2.0</a></p>
<p>Site built with <a href="https://rstudio.github.io/distill/">Distill
for R Markdown</a></p>
</div>
<!--/radix_placeholder_navigation_after_body-->
</body></html>


</body>

</html>
